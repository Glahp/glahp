<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aura AI — Tahoe Edition</title>
<!--
 Single-file AuraAI with:
  - organized theme system (100+)
  - drawing pad with 100 tasks and Auto-Check (TF.js + MobileNet)
  - music player (bgm.mp3, bgm2.mp3, bgm3.mp3 in same folder)
  - bubble pop, chat preserved
-->
<style>
:root{
  --pad:20px; --radius:16px;
  --glass-bg: rgba(255,255,255,0.20);
  --glass-border: rgba(255,255,255,0.28);
  --glass-shadow: 0 18px 40px rgba(0,0,0,0.18);
  --accent-grad: linear-gradient(90deg,#a8cdf1 0%,#f7b7b9 100%);
  --text: #0b3c61;
  --muted: rgba(11,60,97,0.65);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:"Comic Neue",Arial,sans-serif;background:#a8cdf1;color:var(--text)}
body{display:flex;align-items:center;justify-content:center;overflow:hidden}
.screen{position:absolute;inset:0;display:none;place-items:center;padding:var(--pad)}
.screen.active{display:grid}
.glass{background:var(--glass-bg);backdrop-filter: blur(14px);-webkit-backdrop-filter: blur(14px);border:1px solid var(--glass-border);box-shadow:var(--glass-shadow);border-radius:var(--radius)}
.btn{border:0;cursor:pointer;border-radius:12px;padding:12px 14px;font-weight:800;font-size:15px;background:var(--accent-grad);color:var(--text);box-shadow:0 6px 16px rgba(168,205,241,.6)}
.btn:hover{transform:translateY(-2px);filter:brightness(.95)}
/* main hello */
.hello-wrap{width:min(980px,92vw);padding:28px;text-align:center;border-radius:18px}
.hello-text{font-weight:900;font-size:clamp(36px,7vw,72px);margin:6px 0;background:linear-gradient(90deg,#fff,#f7b7b9,#a8cdf1,#fff);-webkit-background-clip:text;background-clip:text;color:transparent;user-select:none}
.hello-sub{font-size:clamp(15px,2.4vw,20px);opacity:.9;margin-bottom:16px}
.hello-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
.hint{margin-top:12px;font-size:13px;opacity:.8}

/* game */
.game-wrap{width:min(1000px,95vw);height:min(70vh,680px);padding:12px;display:grid;grid-template-rows:auto 1fr;gap:10px;border-radius:16px}
.bar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.title{font-weight:900;font-size:18px}
.game-ind{font-weight:800;padding:8px 12px;border-radius:12px;background:rgba(255,255,255,.6)}

/* draw */
.draw-wrap{width:min(1100px,96vw);height:min(76vh,740px);padding:12px;display:grid;grid-template-rows:auto 1fr auto;gap:10px;border-radius:16px}
.draw-tools{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.brush{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.55);padding:6px 10px;border-radius:12px;font-weight:800}
.swatch{width:26px;height:26px;border-radius:50%;border:0;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,.12)}
.toggle{display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:12px;background:rgba(255,255,255,.55);font-weight:800}
.draw-canvas{width:100%;height:100%;border-radius:14px;background:rgba(255,255,255,.85);outline:2px solid rgba(255,255,255,.5)}
.draw-bottom{display:flex;gap:8px;justify-content:space-between;flex-wrap:wrap}
.picker{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.55);padding:6px 10px;border-radius:12px;font-weight:800}
.picker input[type=color]{border:none;width:42px;height:26px;border-radius:10px}

/* chat */
.chat-container{width:min(980px,92vw);padding:18px;display:flex;flex-direction:column;gap:12px;border-radius:16px}
.header-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.mood-header{flex:1;text-align:center;font-weight:900;font-size:20px;padding:12px 16px;border-radius:14px;background:var(--accent-grad)}
.header-buttons{display:flex;gap:8px;flex-wrap:wrap}
.mood-selector{display:flex;gap:10px;flex-wrap:wrap}
.mood-btn{border:0;flex:1;cursor:pointer;padding:12px 14px;border-radius:14px;font-weight:800;font-size:15px}
.mood-btn.happy{background:#c1e6a6} .mood-btn.sad{background:#a4c7f9} .mood-btn.angry{background:#f9d6d6} .mood-btn.nervous{background:#fff3c8}
#mood-strip{display:flex;gap:8px}
#chat-box{flex:1;min-height:260px;max-height:52vh;overflow:auto;padding:14px;border-radius:14px;background:rgba(232,242,252,.65)}
.message{margin:10px 0;padding:12px 14px;border-radius:14px;max-width:75%;font-size:16px}
.message.bot{background:rgba(0,0,0,0.35);color:#f0f0f0;backdrop-filter:blur(6px)} .message.user{background:rgba(0,0,0,0.55);color:#fff;align-self:flex-end;text-align:right}

/* Themes panel - Tahoe macOS style */
.themes-panel{position:fixed;right:20px;top:60px;width:420px;max-height:70vh;overflow:auto;padding:12px;border-radius:14px;background:rgba(255,255,255,0.88);box-shadow:0 20px 40px rgba(0,0,0,.18);border:1px solid rgba(0,0,0,0.06);z-index:1200}
.themes-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.group{margin-bottom:12px}
.group-title{font-weight:900;margin-bottom:8px}
.swatch-row{display:flex;gap:8px;flex-wrap:wrap}
.theme-btn{width:46px;height:46px;border-radius:8px;border:0;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.12);position:relative;overflow:hidden}
.theme-btn .thumb-label{position:absolute;bottom:4px;left:6px;font-size:11px;background:rgba(0,0,0,0.28);color:#fff;padding:2px 6px;border-radius:8px}

/* mini player */
.miniplayer{position:fixed;right:18px;bottom:18px;background:rgba(255,255,255,0.9);padding:10px;border-radius:12px;display:flex;align-items:center;gap:12px;box-shadow:0 12px 30px rgba(0,0,0,.15);z-index:1300}
.mini-meta{display:flex;flex-direction:column;gap:6px;min-width:200px}
.mini-progress{width:220px}

/* drawing control card integrated into UI */
.draw-card{position:relative;display:flex;align-items:center;gap:8px;padding:10px;border-radius:12px;background:rgba(255,255,255,.85);box-shadow:0 8px 20px rgba(0,0,0,.08);margin-bottom:8px}
.draw-card .label{font-weight:900}
.control-buttons{display:flex;gap:8px;align-items:center}

/* yes/no/later buttons style */
.choice-btn{padding:8px 10px;border-radius:10px;border:0;cursor:pointer;background:rgba(11,60,97,0.06);font-weight:800}
.choice-btn.primary{background:linear-gradient(90deg,#a8cdf1,#f7b7b9);color:var(--text)}
.choice-btn:hover{transform:translateY(-1px)}

/* small helpers */
.small{font-size:13px;color:var(--muted)}
.tooltip{font-size:12px;opacity:.85}

/* responsive */
@media (max-width:880px){
  .themes-panel{right:10px;left:10px;width:auto}
  .miniplayer{left:10px;right:10px;bottom:10px}
}
</style>
</head>
<body>

<!-- AUDIO TRACKS (expected in repo) -->
<audio id="bg1" src="bgm.mp3" crossorigin="anonymous"></audio>
<audio id="bg2" src="bgm2.mp3" crossorigin="anonymous"></audio>
<audio id="bg3" src="bgm3.mp3" crossorigin="anonymous"></audio>

<!-- HELLO -->
<section id="hello" class="screen active">
  <div class="hello-wrap glass">
    <div class="hello-text">AuraAI</div>
    <div class="hello-sub">Hi 👋 I’m your support buddy. What would you like to do today?</div>
    <div class="hello-actions">
      <button class="btn" id="btnPlay">🎮 Play</button>
      <button class="btn" id="btnDraw">🎨 Draw</button>
      <button class="btn" id="btnChat">💬 Talk</button>
    </div>
    <div class="hint">This is Aura inside the app — an app inside an app (macOS Tahoe look).</div>
  </div>
</section>

<!-- GAME -->
<section id="game" class="screen">
  <div class="game-wrap glass">
    <div class="bar">
      <div class="left-group"><div class="title">🫧 Bubble Pop — levels & calm</div></div>
      <div class="right-group">
        <span class="game-ind">Level: <span id="levelNum">1</span></span>
        <span class="game-ind">Score: <span id="score">0</span></span>
        <button class="btn" id="resetBtn">Reset</button>
        <button class="btn" id="backGame">⬅ Back</button>
      </div>
    </div>
    <canvas id="gameCanvas" aria-label="Bubble pop canvas"></canvas>
  </div>
</section>

<!-- DRAW -->
<section id="draw" class="screen">
  <div class="draw-wrap glass">
    <div class="bar">
      <div class="left-group">
        <div class="title">🎨 Draw — practice & check</div>
      </div>
      <div class="right-group">
        <button class="btn" id="themesDraw">🎨 Themes</button>
        <button class="btn" id="backDraw">⬅ Back</button>
      </div>
    </div>

    <!-- integrated draw control card -->
    <div class="draw-card" id="drawCard">
      <div style="flex:1">
        <div class="label">🧠 Idea</div>
        <div id="taskText" class="small">Try drawing a ...</div>
      </div>
      <div class="control-buttons">
        <button class="choice-btn" id="newTaskBtn" title="New idea">🔄 New</button>
        <button class="choice-btn" id="autoCheckToggle" title="Auto-check">✅ Auto‑Check</button>
        <button class="choice-btn primary" id="askBtn">Try this</button>
      </div>
    </div>

    <canvas id="drawCanvas" class="draw-canvas" aria-label="Drawing canvas"></canvas>

    <div class="draw-bottom">
      <div>
        <button class="btn" id="clearBtn">Clear</button>
        <button class="btn" id="saveBtn">Save</button>
        <button class="btn" id="freestyleBtn">Free‑style</button>
      </div>
      <div class="small">Guides & checks are gentle — you can always redo.</div>
    </div>
  </div>
</section>

<!-- CHAT -->
<section id="chat" class="screen">
  <div class="chat-container glass">
    <div class="header-controls">
      <div class="mood-header glass">How do you feel?</div>
      <div class="header-buttons">
        <button class="btn" id="voiceBtn">🎤 Voice</button>
        <button class="btn" id="speakBtn">🔊 Speak</button>
        <button class="btn" id="themesChat">🎨 Themes</button>
        <button class="btn" id="backChat">⬅ Back</button>
      </div>
    </div>

    <div id="mood-strip" class="mood-selector">
      <button class="mood-btn happy" data-mood="happy">😊 Happy</button>
      <button class="mood-btn sad" data-mood="sad">😢 Sad</button>
      <button class="mood-btn angry" data-mood="angry">😠 Angry</button>
      <button class="mood-btn nervous" data-mood="nervous">😰 Nervous</button>
    </div>

    <div id="chat-box" role="log" aria-live="polite"></div>

    <div style="display:flex;gap:10px;align-items:center">
      <input id="chatInput" style="flex:1;padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,.06)" placeholder="Type when you want to share..." />
      <button class="btn" id="sendChat">Send</button>
    </div>
  </div>
</section>

<!-- THEMES PANEL -->
<div class="themes-panel glass" id="themesPanel" aria-hidden="false">
  <div class="themes-head">
    <div style="font-weight:900">Themes — Tahoe Library</div>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="btn" id="surpriseBtn" title="Surprise me">🎲 Surprise</button>
      <button class="btn" id="closeThemes">✕</button>
    </div>
  </div>
  <div id="themesBody">
    <!-- categories injected here -->
  </div>
</div>

<!-- MINI PLAYER -->
<div class="miniplayer glass" id="miniPlayer" role="region" aria-label="Music player">
  <button id="miniPlay" class="btn">▶️</button>
  <div class="mini-meta">
    <div id="miniTitle" style="font-weight:900">BGM</div>
    <input id="miniSeek" class="mini-progress" type="range" min="0" max="100" value="0" />
    <div style="font-size:12px;color:var(--muted)"><span id="miniCur">0:00</span> / <span id="miniDur">0:00</span></div>
  </div>
</div>

<!-- TensorFlow + MobileNet loaded only if needed -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.2.2/dist/mobilenet.min.js"></script>

<script>
/* ---------- Helpers & initial wiring ---------- */
const screens = { hello:document.getElementById('hello'), game:document.getElementById('game'), draw:document.getElementById('draw'), chat:document.getElementById('chat')};
function showScreen(k){ Object.values(screens).forEach(s=>s.classList.remove('active')); screens[k].classList.add('active'); }
document.getElementById('btnPlay').onclick = ()=>{ startGame(); showScreen('game'); }
document.getElementById('btnDraw').onclick = ()=>{ prepareDraw(); showScreen('draw'); }
document.getElementById('btnChat').onclick = ()=>{ showScreen('chat'); }
document.getElementById('backGame').onclick = ()=>{ showScreen('hello'); }
document.getElementById('backDraw').onclick = ()=>{ showScreen('hello'); }
document.getElementById('backChat').onclick = ()=>{ showScreen('hello'); }

/* ---------- THEME LIBRARY (100+ surprise themes in groups) ---------- */
const THEMES_CATEGORIES = [
  {title:"Metallic", items:[
    ["Space Gray","linear-gradient(135deg,#3b3b3f,#8b8b8f)"],
    ["Silver","linear-gradient(135deg,#f3f4f6,#d6d8db)"],
    ["Gold","linear-gradient(135deg,#f4d58d,#c99b4c)"],
    ["Rose Gold","linear-gradient(135deg,#ffd1dc,#c88b85)"],
    ["Steel Blue","linear-gradient(135deg,#4b6b88,#2b445a)"],
    ["Titanium","linear-gradient(135deg,#2f2f33,#6a6a6e)"],
    ["Copper","linear-gradient(135deg,#b26a4a,#4e2314)"],
    ["Chrome","linear-gradient(135deg,#e9eef2,#9aa4ad)"],
    ["Liquid Mercury","linear-gradient(135deg,#a7a9ac,#e7e8ea)"],
    ["Neon Metal","linear-gradient(135deg,#06f7ff,#00ff9d)"]
  ]},
  {title:"Gradients", items: generateGradients(22) },
  {title:"Poster / Bold", items:[
    ["Pure Red","#E53935"],["Pop Cyan","#00BCD4"],["Lemon Yellow","#FFEB3B"],["Magenta","#FF00A8"],
    ["Royal Blue","#2E5CB8"],["Acid Green","#B8FF00"],["Coral","#FF6F61"],["Tangerine","#FF8C42"],
    ["Hot Pink","#FF4FA3"],["Bright Purple","#9B5DE5"],["Electric Indigo","#6F42C1"],["Neon Punch","#FF2D95"],
    ["Turquoise","#1ABC9C"],["Cobalt","#3B82F6"],["Sunshine","#FFD166"]
  ]},
  {title:"Pastels", items:[
    ["Peach","#FFD2B8"],["Lavender","#EAD7FF"],["Mint","#CFFFE1"],["Baby Blue","#CFE9FF"],
    ["Blush","#FFDDE2"],["Powder","#E8F0FF"],["Cream","#FFF7E6"],["Light Jade","#D8F7E8"],
    ["Soft Coral","#FFD7D0"],["Pale Yellow","#FFF8C4"],["Pastel Lilac","#E4D7FF"],["Pastel Sky","#D6EEFF"]
  ]},
  {title:"Grayscale/Minimal", items:[
    ["Black","#000000"],["Charcoal","#2C2C2E"],["Slate","#6B7280"],["Fog","#F3F4F6"],["Paper","#FFFFFF"],
    ["Ash","#9CA3AF"],["Graphite","#374151"],["Silver Mist","#ECEFF1"],["Steel","#B0BEC5"],["Smoke","#CFD8DC"]
  ]},
  {title:"Artistic / Patterned", items:[
    ["Aurora","linear-gradient(135deg,#00d2ff,#3a7bd5)"],["Galaxy","linear-gradient(135deg,#0f0c29,#302b63)"],
    ["Marble","linear-gradient(135deg,#f6f7fb,#e9eef6)"],["Neon Waves","linear-gradient(135deg,#ff6a88,#ff9a9e)"],
    ["Vintage","linear-gradient(135deg,#f0d5b3,#d1b3a1)"],["Fabric","linear-gradient(135deg,#e6eef8,#cfd9ea)"],
    ["Noise","linear-gradient(135deg,#f1f3f5,#e6e9ee)"],["Checker","linear-gradient(135deg,#fff,#eee)"]
  ]},
  {title:"User Upload", items:[
    ["Custom Upload","upload://custom"]
  ]},
];

function generateGradients(n){
  const base = [
    ["Aurora","linear-gradient(135deg,#00d2ff,#3a7bd5)"],
    ["Sunset Glow","linear-gradient(135deg,#f857a6,#ff5858)"],
    ["Deep Ocean","linear-gradient(135deg,#2b5876,#4e4376)"],
    ["Cotton Candy","linear-gradient(135deg,#ffb6c1,#add8e6)"],
    ["Rainbow Loop","rainbow-loop"],
    ["Firestorm","linear-gradient(135deg,#ff416c,#ff4b2b)"],
    ["Galaxy Fade","linear-gradient(135deg,#512da8,#7b1fa2)"],
    ["Mint Dream","linear-gradient(135deg,#a8ff78,#78ffd6)"],
    ["Polar","linear-gradient(135deg,#21D4FD,#B721FF)"],
    ["Berry","linear-gradient(135deg,#833ab4,#fd1d1d)"]
  ];
  const items = [];
  for(let i=0;i<n;i++){
    items.push(base[i%base.length]);
  }
  return items;
}

const themesBody = document.getElementById('themesBody');
function buildThemesUI(){
  themesBody.innerHTML = '';
  THEMES_CATEGORIES.forEach(cat=>{
    const g = document.createElement('div'); g.className='group';
    const t = document.createElement('div'); t.className='group-title'; t.textContent = cat.title;
    g.appendChild(t);
    const row = document.createElement('div'); row.className='swatch-row';
    cat.items.forEach(([name, bg])=>{
      const btn = document.createElement('button'); btn.className='theme-btn'; btn.title = name;
      if(bg === 'rainbow-loop'){
        btn.style.background = 'linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet)';
        btn.dataset.special = 'rainbow';
      } else if(bg && bg.startsWith('upload://')){
        btn.style.background = 'repeating-linear-gradient(45deg,#eee,#eee 10px,#fff 10px,#fff 20px)';
        btn.innerHTML = '<div style="padding:6px 8px;font-size:12px">Upload</div>';
        btn.dataset.theme = 'custom';
      } else {
        btn.style.background = bg;
        btn.dataset.bg = bg;
      }
      const label = document.createElement('div'); label.className='thumb-label'; label.textContent = name; btn.appendChild(label);
      btn.addEventListener('click', ()=>{ applyTheme(name,bg); });
      row.appendChild(btn);
    });
    g.appendChild(row); themesBody.appendChild(g);
  });
}
function applyTheme(name,bg){
  if(bg==='rainbow-loop'){ document.body.style.background = 'linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet)'; // animated
    document.body.style.animation = 'rainbow 8s linear infinite';
    document.body.style.backgroundSize = '400% 400%';
    injectRainbowKeyframes();
  } else if(bg && bg.startsWith('linear-gradient')){
    document.body.style.background = bg; document.body.style.animation = '';
  } else if(name === 'Custom Upload'){
    promptUploadBackground();
  } else if(bg){
    document.body.style.background = bg; document.body.style.animation = '';
  }
}
function injectRainbowKeyframes(){
  if(document.getElementById('kf-rainbow')) return;
  const s = document.createElement('style'); s.id='kf-rainbow';
  s.textContent = '@keyframes rainbow{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}';
  document.head.appendChild(s);
}
document.getElementById('closeThemes').onclick = ()=>{ document.getElementById('themesPanel').style.display='none' };
document.getElementById('surpriseBtn').onclick = ()=>{ const cats = THEMES_CATEGORIES.flatMap(c=>c.items); const pick = cats[Math.floor(Math.random()*cats.length)]; applyTheme(pick[0],pick[1]); }

/* ---------- MINI PLAYER ---------- */
const tracks = [document.getElementById('bg1'),document.getElementById('bg2'),document.getElementById('bg3')];
let currentTrack = 0;
const miniPlay = document.getElementById('miniPlay'); const miniSeek = document.getElementById('miniSeek');
const miniCur = document.getElementById('miniCur'); const miniDur = document.getElementById('miniDur'); const miniTitle = document.getElementById('miniTitle');
function playTrack(idx){
  tracks.forEach((t,i)=>{ try{ t.pause(); t.currentTime=0 }catch{} });
  currentTrack = idx; const a = tracks[currentTrack];
  a.volume = 0.35; a.play().catch(()=>{});
  miniTitle.textContent = 'BGM ' + (currentTrack+1);
}
miniPlay.onclick = ()=>{
  const a = tracks[currentTrack];
  if(a.paused){ a.play(); miniPlay.textContent='⏸'; } else { a.pause(); miniPlay.textContent='▶️'; }
}
tracks.forEach(t=>{
  t.addEventListener('timeupdate', ()=>{ if(t.duration){ miniSeek.value = (t.currentTime/t.duration)*100; miniCur.textContent = fmtTime(t.currentTime); miniDur.textContent = fmtTime(t.duration); }});
  t.addEventListener('ended', ()=>{ currentTrack = (currentTrack+1) % tracks.length; playTrack(currentTrack); });
});
miniSeek.oninput = ()=>{ const a = tracks[currentTrack]; if(a.duration) a.currentTime = (miniSeek.value/100)*a.duration; }
function fmtTime(s){ if(!s || isNaN(s)) return '0:00'; const m=Math.floor(s/60); const sec=Math.floor(s%60).toString().padStart(2,'0'); return m+':'+sec; }
playTrack(0);

/* ---------- DRAWING pad + 100 tasks ---------- */
const prompts = [
"cat","dog","house","tree","car","bicycle","boat","fish","sun","moon","star","flower","cup","cake","ice cream",
"rocket","robot","key","chair","shoe","hat","glasses","book","phone","clock","guitar","piano","bird","butterfly","leaf","mountain",
"castle","train","bus","truck","lamp","window","door","hand","smiley face","heart","umbrella","balloon","crown","map","island","island palm",
"hat","camera","penguin","elephant","lion","tiger","zebra","panda","koala","dolphin","whale","shark","octopus","lighthouse","bridge",
"cake slice","cookie","spoon","fork","knife","bottle","kite","present","ball","ring","diamond","starfish","seashell","leafy plant",
"mushroom","ant","bee","snail","owl","fox","squirrel","hedgehog","pineapple","banana","apple","grapes","pear","strawberry","cherry",
"lantern","compass","tent","campfire","backpack","boots","scarf","glove","parrot","peacock","candle","skate","roller skate","sword","shield",
"wizard hat","wand","treasure chest","maple leaf","geyser","volcano","satellite","planet","telescope","hourglass","anchor","trophy","microphone",
"headphones","paintbrush","palette"
];
// ensure 100 by repeating if necessary
while(prompts.length < 100) prompts.push(...prompts.slice(0,100-prompts.length));

const taskText = document.getElementById('taskText');
const newTaskBtn = document.getElementById('newTaskBtn');
const askBtn = document.getElementById('askBtn');
const autoCheckBtn = document.getElementById('autoCheckToggle');
const clearBtn = document.getElementById('clearBtn');
const saveBtn = document.getElementById('saveBtn');
const freestyleBtn = document.getElementById('freestyleBtn');
let currentTask = null;
let autoCheck = false;
let model = null;
let modelLoading = false;

function pickRandomTask(){ currentTask = prompts[Math.floor(Math.random()*prompts.length)]; taskText.textContent = `Try drawing a ${currentTask}? (OK / No / Later)`; }
newTaskBtn.onclick = ()=>{ pickRandomTask(); }
askBtn.onclick = ()=>{ showTaskChoices() }
autoCheckBtn.onclick = ()=>{ autoCheck = !autoCheck; autoCheckBtn.textContent = autoCheck ? '✅ Auto‑Check ON' : '✅ Auto‑Check'; if(autoCheck && !model && !modelLoading){ loadModel(); } }

function showTaskChoices(){
  // integrated dialog style
  const ok = confirm(`Try drawing a ${currentTask}?\nOK → I want to try\nCancel → No / Later (choose later in UI)`);
  if(ok) {
    toggleCanvasInput(true);
  } else {
    // ask later -> free draw
    alert("You can freestyle anytime — opening free-style.");
    toggleCanvasInput(true);
  }
}

/* canvas draw */
const canvas = document.getElementById('drawCanvas');
const ctx = canvas.getContext('2d');
let drawing=false, lastX=0,lastY=0,brush='#1e88e5',brushSize=8,erasing=false;
function resizeCanvas(){
  const rect = canvas.getBoundingClientRect();
  const dp = devicePixelRatio || 1;
  const w = Math.floor(rect.width*dp), h = Math.floor(rect.height*dp);
  const image = ctx.getImageData(0,0,canvas.width||1,canvas.height||1);
  canvas.width = w; canvas.height = h;
  ctx.setTransform(1,0,0,1,0,0); ctx.scale(dp,dp);
  try{ ctx.putImageData(image,0,0) } catch(e){}
}
window.addEventListener('resize', resizeCanvas);
setTimeout(resizeCanvas,50);

canvas.addEventListener('pointerdown', (e)=>{ drawing=true; const r=canvas.getBoundingClientRect(); lastX = (e.clientX - r.left); lastY = (e.clientY - r.top); });
canvas.addEventListener('pointermove', (e)=>{ if(!drawing) return; const r=canvas.getBoundingClientRect(); const x = (e.clientX - r.left); const y = (e.clientY - r.top); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.lineWidth=brushSize; ctx.strokeStyle = erasing ? 'rgba(0,0,0,1)' : brush; if(erasing) ctx.globalCompositeOperation='destination-out'; else ctx.globalCompositeOperation='source-over'; ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(x,y); ctx.stroke(); lastX=x; lastY=y; });
canvas.addEventListener('pointerup', ()=>{ drawing=false; ctx.globalCompositeOperation='source-over'; });
canvas.addEventListener('pointerleave', ()=>{ drawing=false; });

clearBtn.onclick = ()=>{ ctx.clearRect(0,0,canvas.width,canvas.height); }
saveBtn.onclick = ()=>{ const url = canvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download='drawing.png'; a.click(); if(autoCheck) runAutoCheck(); }
freestyleBtn.onclick = ()=>{ currentTask = null; taskText.textContent = 'Free‑style — create whatever you like'; toggleCanvasInput(true); }

/* Auto-check using MobileNet: best-effort on sketches (mobileNet classifies photographic-like input) */
async function loadModel(){
  if(model) return model;
  modelLoading = true;
  taskText.textContent = 'Auto‑Check model loading...';
  try{
    model = await mobilenet.load(); // from CDN
    taskText.textContent = currentTask ? `Try drawing a ${currentTask}? (Auto‑Check ready)` : 'Free‑style';
  }catch(e){
    taskText.textContent = 'Auto‑Check unavailable';
    model = null;
  } finally { modelLoading = false; }
}
async function runAutoCheck(){
  if(!currentTask){ addEncouragement("Nice free-style!"); return; }
  if(!model){ await loadModel(); if(!model) return; }
  // create a temporary image scaled for model
  const temp = document.createElement('canvas'); temp.width = 224; temp.height = 224;
  const tctx = temp.getContext('2d');
  // fill white behind transparent drawings for better classification
  tctx.fillStyle = '#ffffff'; tctx.fillRect(0,0,224,224);
  tctx.drawImage(canvas,0,0,224,224);
  const img = tf.browser.fromPixels(temp);
  const preds = await model.classify(img);
  img.dispose();
  if(!preds || preds.length===0){ gentleRetry(); return; }
  const top = preds[0].className.toLowerCase();
  // matching heuristic: check if any word in currentTask appears in prediction string
  const taskWords = (currentTask||'').toLowerCase().split(/[\s,-]+/);
  const match = taskWords.some(w=> w && top.includes(w));
  if(match){
    addEncouragement("Wow! That looks great! 🎉 Nice job!");
  } else {
    gentleRetry(top);
  }
}
function gentleRetry(prediction){
  if(prediction){
    const msg = `Nice try — model saw: "${prediction}". Wanna try again or try a new idea?`;
    addGentle(msg);
  } else {
    addGentle("That was cool — want to try again? Maybe rotate, add more details or try a new idea.");
  }
}
function addEncouragement(txt){ alert(txt); } // simple; can be replaced by fancier UI
function addGentle(txt){ alert(txt); }

/* toggle canvas input (open drawing mode) */
function toggleCanvasInput(on){
  // shows the cursor and lets user draw; this is always available; just focus
  canvas.focus();
}

/* show initial task & pick random */
function prepareDraw(){
  pickRandomTask();
  // clear canvas on open
  ctx.clearRect(0,0,canvas.width,canvas.height);
}

/* ---------- GAME: bubble pop with levels ---------- */
const gCanvas = document.getElementById('gameCanvas'), gCtx = gCanvas.getContext('2d');
let bubbles = [], gScore=0, gLevel=1, lastSpawn=0;
function resizeGameCanvas(){
  const rect = gCanvas.getBoundingClientRect();
  const dp = devicePixelRatio || 1;
  gCanvas.width = Math.floor(rect.width * dp);
  gCanvas.height = Math.floor(rect.height * dp);
  gCtx.setTransform(1,0,0,1,0,0); gCtx.scale(dp,dp);
}
window.addEventListener('resize', resizeGameCanvas);
setTimeout(resizeGameCanvas,50);
function spawnBubble(){
  const r = 18 + Math.random()*28;
  const x = r + Math.random()*(gCanvas.clientWidth - r*2);
  const y = gCanvas.clientHeight + r + 10;
  const vy = (0.6 + Math.random()*1.2) * (1 + (gLevel-1)*0.04);
  const hue = Math.floor(180 + Math.random()*160);
  bubbles.push({x,y,r,vy,alpha:1,hue,popped:false});
}
function updateBubbles(dt){
  bubbles = bubbles.filter(b=>b.alpha>0);
  for(const b of bubbles){
    if(!b.popped){ b.y -= b.vy * dt * 0.06; if(b.y < -b.r){ b.popped=true; b.alpha=0; } }
    else b.alpha -= 0.05;
  }
}
function drawBubbles(){
  gCtx.clearRect(0,0,gCanvas.clientWidth,gCanvas.clientHeight);
  const grd = gCtx.createLinearGradient(0,0,gCanvas.clientWidth,gCanvas.clientHeight);
  grd.addColorStop(0,'rgba(255,255,255,.24)'); grd.addColorStop(1,'rgba(255,255,255,.12)');
  gCtx.fillStyle = grd; gCtx.fillRect(0,0,gCanvas.clientWidth,gCanvas.clientHeight);
  for(const b of bubbles){
    gCtx.save(); gCtx.globalAlpha = Math.max(0,b.alpha);
    gCtx.shadowColor = 'rgba(255,255,255,.9)'; gCtx.shadowBlur = 14; gCtx.lineWidth = 2; gCtx.strokeStyle = 'rgba(0,0,0,.16)';
    const cx=b.x,cy=b.y,r=b.r; const grad = gCtx.createRadialGradient(cx-r*0.3,cy-r*0.3,r*0.2,cx,cy,r);
    grad.addColorStop(0,`hsla(${b.hue},90%,96%,.95)`); grad.addColorStop(1,`hsla(${b.hue},70%,65%,.65)`);
    gCtx.fillStyle=grad; gCtx.beginPath(); gCtx.arc(cx,cy,r,0,Math.PI*2); gCtx.fill(); gCtx.stroke();
    gCtx.beginPath(); gCtx.arc(cx-r*0.38,cy-r*0.38,r*0.22,0,Math.PI*2); gCtx.fillStyle='rgba(255,255,255,.6)'; gCtx.fill();
    gCtx.restore();
  }
}
let lastPaint = performance.now();
function gameLoop(t){
  const dt = t - lastPaint; lastPaint = t;
  if(t - lastSpawn > Math.max(2000 - gLevel*40, 400)){ spawnBubble(); lastSpawn=t; }
  updateBubbles(dt);
  drawBubbles();
  requestAnimationFrame(gameLoop);
}
requestAnimationFrame(gameLoop);
gCanvas.addEventListener('click',(e)=>{
  const rect = gCanvas.getBoundingClientRect(), x=e.clientX-rect.left, y=e.clientY-rect.top;
  for(const b of bubbles){ const dx=x-b.x, dy=y-b.y; if(!b.popped && dx*dx+dy*dy <= b.r*b.r){ b.popped=true; b.vy=0; gScore++; document.getElementById('score').textContent=gScore; SoundPop(); checkLevelUp(); break; } }
});
function checkLevelUp(){
  const milestones = 25;
  if(gScore % milestones === 0){
    gLevel = Math.min(30, gLevel+1); document.getElementById('levelNum').textContent = gLevel;
    addBubblePraise(gScore);
  }
}
function addBubblePraise(score){
  const praises = ["Nice!", "Amazing!", "You're on fire!", "Calm and steady!", "Keep going!"];
  const idx = Math.floor(Math.min(praises.length-1, Math.log(score+1)));
  alert(`${praises[idx]} — score ${score}`);
}
function SoundPop(){ try{ const o=new (window.AudioContext||window.webkitAudioContext)(); const osc=o.createOscillator(); const g=o.createGain(); osc.type='sine'; osc.frequency.value=900; g.gain.value=0.05; osc.connect(g).connect(o.destination); osc.start(); osc.stop(o.currentTime+0.08);}catch(e){} }
document.getElementById('resetBtn').onclick = ()=>{ bubbles=[]; gScore=0; gLevel=1; document.getElementById('score').textContent=gScore; document.getElementById('levelNum').textContent=gLevel; }

/* ---------- CHAT: improved responses (basic but better rules) ---------- */
const chatBox = document.getElementById('chat-box'), chatInput=document.getElementById('chatInput'), sendChat=document.getElementById('sendChat');
const moodButtons = document.querySelectorAll('.mood-btn');
function addChat(text,who='bot'){ const d=document.createElement('div'); d.className='message '+(who==='bot'?'bot':'user'); d.textContent=text; chatBox.appendChild(d); chatBox.scrollTop = chatBox.scrollHeight; }
addChat("Hi! 👋 How was your day? 😊");
sendChat.onclick = ()=>{ const t = chatInput.value.trim(); if(!t) return; addChat(t,'user'); chatInput.value=''; setTimeout(()=>{ const rep = smartReply(t); addChat(rep,'bot'); },650); }
function smartReply(input){
  const s = input.toLowerCase();
  if(/(sad|upset|depressed|down)/.test(s)) return "I hear you. Do you want a small comfort idea or to talk it through?";
  if(/(happy|great|good|awesome)/.test(s)) return "That's wonderful — tell me one thing that made you smile today.";
  if(/(anxious|nervous|scared|afraid)/.test(s)) return "Breathing trick: inhale 4s, hold 4s, exhale 6s — want me to guide you?";
  if(/(help|advice|support)/.test(s)) return "I’m here. Tell me a bit and we’ll make a tiny plan together.";
  if(/(game|play)/.test(s)) return "Want to try Bubble Pop? It's calming. Open Play from the home screen.";
  if(/(draw|doodle|sketch)/.test(s)) return "Open Draw and I'll give an idea or you can freestyle.";
  return "Thanks for sharing — tell me more or pick an activity above.";
}
moodButtons.forEach(b=>b.onclick = ()=>{
  const m = b.dataset.mood;
  addChat(`Mood set to ${m}`, 'user');
  const map = {happy:"Love it — want a cheerful activity?", sad:"I'm sorry. Want a calming breathing or a small activity?", angry:"Okay — want a quick vent or grounding?", nervous:"Let's try a short grounding — name 5 things you see."};
  addChat(map[m] || "I'm here.", 'bot');
});

/* ---------- Misc helpers ---------- */
function startGame(){ /* placeholder to open game screen */ }
function prepareDraw(){ pickRandomTask(); ctx.clearRect(0,0,canvas.width,canvas.height); }
pickRandomTask(); buildThemesUI();

/* ---------- Minimal UX polish: tooltips, uploads ---------- */
function promptUploadBackground(){
  const input = document.createElement('input'); input.type='file'; input.accept='image/*';
  input.onchange = e=>{
    const f = e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ev=>{
      document.body.style.background = `url(${ev.target.result}) center/cover no-repeat`;
      localStorage.setItem('aura-custom-bg', ev.target.result);
    };
    reader.readAsDataURL(f);
  };
  input.click();
}
const saved = localStorage.getItem('aura-custom-bg'); if(saved){ document.body.style.background = `url(${saved}) center/cover no-repeat`; }

/* ---------- Auto-check on close/save shortcut ---------- */
document.addEventListener('keydown', (e)=>{ if(e.key==='s' && (e.metaKey||e.ctrlKey)){ e.preventDefault(); saveBtn.click(); } });

</script>
</body>
</html>
