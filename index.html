<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>AuraAI</title>
<!--
 Single-file Aura App updated with:
  - 100 categorized themes (Grayscale, Metallic, Gradient, Animated, Pastel, Poster)
  - New 'Gallery' and 'Upload' features for custom themes
  - drawing pad
  - bubble pop game
  - music player (plays bgm1.mp3, bgm2.mp3, bgm3.mp3)
  - chatbot with validating, direct responses
  - Fix for the drawing pad functionality
  - Fix for the chatbot to remove the initial hardcoded message
  - Updated 'Welcome' screen gradient and text shadow for better visibility
  - Replaced the green 'Welcome' text with a darker gradient as requested.
  - **REWRITTEN CHATBOT LOGIC to be more robust and reliably handle loading states.**
  - **FIXED: Improved chatbot error handling for network and API response issues.**
-->
<style>
:root{
  --pad:20px; --radius:16px;
  --glass-bg: rgba(255,255,255,0.20);
  --glass-border: rgba(255,255,255,0.28);
  --glass-shadow: 0 18px 40px rgba(0,0,0,0.18);
  --accent-grad: linear-gradient(90deg,#a8cdf1 0%,#f7b7b9 100%);
  --text: #0b3c61;
  --muted: rgba(11,60,97,0.65);
}
/* Basic styles for all themes */
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:"Comic Neue",Arial,sans-serif;background:#a8cdf1;color:var(--text)}
body{display:flex;align-items:center;justify-content:center;overflow:hidden;transition:background-color .8s ease}
/* Animated theme backgrounds */
body.animated-theme { background: linear-gradient(270deg, #f7b7b9, #a8cdf1, #a8cdf1, #f7b7b9); background-size: 800% 800%; animation: gradientAnimation 20s ease infinite;}
@keyframes gradientAnimation { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
.screen{position:absolute;inset:0;display:none;place-items:center;padding:var(--pad)}
.screen.active{display:grid}
.glass{background:var(--glass-bg);backdrop-filter: blur(14px);-webkit-backdrop-filter: blur(14px);border:1px solid var(--glass-border);box-shadow:var(--glass-shadow);border-radius:var(--radius)}
.btn{border:0;cursor:pointer;border-radius:12px;padding:12px 14px;font-weight:800;font-size:15px;background:var(--accent-grad);color:var(--text);box-shadow:0 6px 16px rgba(168,205,241,.6);transition:transform .2s ease, filter .2s ease;}
.btn:hover{transform:translateY(-2px);filter:brightness(.95)}
/* main hello */
.hello-wrap{width:min(980px,92vw);padding:28px;text-align:center;border-radius:18px}
.hello-text{font-weight:900;font-size:clamp(36px,7vw,72px);margin:6px 0;background:linear-gradient(90deg, #5f7587, #c18f92);-webkit-background-clip:text;background-clip:text;color:transparent;user-select:none; text-shadow: 0 2px 4px rgba(0,0,0,0.25);}
.hello-sub{font-size:clamp(15px,2.4vw,20px);opacity:.9;margin-bottom:16px}
.hello-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
.hint{margin-top:12px;font-size:13px;opacity:.8}
/* game */
.game-wrap{width:min(1000px,95vw);height:min(70vh,680px);padding:12px;display:grid;grid-template-rows:auto 1fr;gap:10px;border-radius:16px}
.bar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
.title{font-weight:900;font-size:18px}
.game-ind{font-weight:800;padding:8px 12px;border-radius:12px;background:rgba(255,255,255,.6)}
/* draw */
.draw-wrap{width:min(1100px,96vw);height:min(76vh,740px);padding:12px;display:grid;grid-template-rows:auto 1fr auto;gap:10px;border-radius:16px}
.draw-tools{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.brush{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.55);padding:6px 10px;border-radius:12px;font-weight:800}
.swatch{width:26px;height:26px;border-radius:50%;border:0;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,.12)}
.toggle{display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:12px;background:rgba(255,255,255,.55);font-weight:800}
.draw-canvas{width:100%;height:100%;border-radius:14px;background:rgba(255,255,255,.85);outline:2px solid rgba(255,255,255,.5)}
.draw-bottom{display:flex;gap:8px;justify-content:space-between;flex-wrap:wrap}
.picker{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.55);padding:6px 10px;border-radius:12px;font-weight:800}
.picker input[type=color]{border:none;width:42px;height:26px;border-radius:10px}
/* chat */
.chat-container{width:min(980px,92vw);padding:18px;display:flex;flex-direction:column;gap:12px;border-radius:16px}
.header-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.mood-header{flex:1;text-align:center;font-weight:900;font-size:20px;padding:12px 16px;border-radius:14px;background:var(--accent-grad)}
.header-buttons{display:flex;gap:8px;flex-wrap:wrap}
.mood-selector{display:flex;gap:10px;flex-wrap:wrap}
.mood-btn{border:0;flex:1;cursor:pointer;padding:12px 14px;border-radius:14px;font-weight:800;font-size:15px;transition:transform .2s ease}
.mood-btn:hover{transform:translateY(-2px)}
.mood-btn.happy{background:#c1e6a6} .mood-btn.sad{background:#a4c7f9} .mood-btn.angry{background:#f9d6d6} .mood-btn.nervous{background:#fff3c8}
#mood-strip{display:flex;gap:8px}
#chat-box{flex:1;min-height:260px;max-height:52vh;overflow:auto;padding:14px;border-radius:14px;background:rgba(232,242,252,.65);display:flex;flex-direction:column}
.message{margin:10px 0;padding:12px 14px;border-radius:14px;max-width:75%;font-size:16px}
.message.bot{background:rgba(0,0,0,0.35);color:#f0f0f0;backdrop-filter:blur(6px);align-self:flex-start} .message.user{background:rgba(0,0,0,0.55);color:#fff;align-self:flex-end;text-align:right}
.chat-input-container{display:flex;gap:8px;width:100%}
.chat-input-container input{flex:1;padding:10px;border-radius:12px;border:1px solid #ddd;font-size:16px;background:rgba(255,255,255,.6)}
/* Themes panel */
.themes-panel{position:fixed;right:20px;top:60px;width:420px;max-height:80vh;overflow:auto;padding:12px;border-radius:14px;background:rgba(255,255,255,0.88);box-shadow:0 20px 40px rgba(0,0,0,0.18);border:1px solid rgba(0,0,0,0.06);z-index:1200;display:none;opacity:0;transform:translateY(20px);transition:opacity .3s ease, transform .3s ease;}
.themes-panel.active{display:block;opacity:1;transform:translateY(0);}
.themes-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;gap:8px}
.themes-head h4{margin:0;font-weight:900}
.theme-category-tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
.theme-category-tabs button{font-size:13px;padding:8px 12px;border-radius:10px;border:1px solid transparent;background:rgba(255,255,255,.6);color:var(--text);font-weight:700;}
.theme-category-tabs button.active{background:var(--accent-grad);border-color:#fff}
.themes-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;padding-top:10px}
.theme-box{height:80px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);cursor:pointer;transition:transform .2s ease, box-shadow .2s ease;border:2px solid transparent;overflow:hidden;position:relative}
.theme-box:hover{transform:scale(1.03);box-shadow:0 6px 16px rgba(0,0,0,0.15)}
.theme-box.active{border:2px solid #fff}
.theme-box.gallery-theme::after { content: 'üñºÔ∏è'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 32px; z-index: 10; pointer-events: none; }
.theme-box.upload-theme::after { content: 'üìÅ'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 32px; z-index: 10; pointer-events: none; }
.theme-box-label{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.4);color:#fff;text-align:center;padding:4px;font-size:10px;font-weight:bold;display:none;opacity:0;transition:opacity .3s ease}
.theme-box:hover .theme-box-label{display:block;opacity:1}
.music-toggle{position:fixed;bottom:20px;right:20px;padding:10px 14px;border-radius:12px;background:rgba(255,255,255,0.85);box-shadow:0 6px 16px rgba(0,0,0,.15);cursor:pointer;display:flex;gap:8px;align-items:center;z-index:1100}
.music-toggle svg{height:20px;width:20px}
.music-toggle.on .pause-icon{display:none} .music-toggle.off .play-icon{display:none}
/* Message box overlay */
.overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);backdrop-filter:blur(5px);z-index:9999;display:flex;justify-content:center;align-items:center;opacity:0;visibility:hidden;transition:opacity 0.3s ease, visibility 0.3s ease}
.overlay.visible{opacity:1;visibility:visible}
.msg-box{background:#fff;padding:20px;border-radius:15px;text-align:center;box-shadow:0 10px 25px rgba(0,0,0,0.2);max-width:350px;animation: pop-in 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) both}
.msg-box h3{margin-top:0;font-size:24px;color:#0b3c61}
.msg-box p{margin-bottom:20px;font-size:16px;color:#333}
.msg-box button{background:#a8cdf1;color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:bold}
@keyframes pop-in{0%{transform:scale(0.8);opacity:0}100%{transform:scale(1);opacity:1}}
@font-face{font-family:"Comic Neue";src:url("https://fonts.gstatic.com/s/comicneue/v8/4UaAjXhSlzgzg8-H-qPPjVzLqjD-gYc.woff2") format("woff2");font-weight:400;font-style:normal;font-display:swap}
@font-face{font-family:"Comic Neue";src:url("https://fonts.gstatic.com/s/comicneue/v8/4UaAjXhSlzgzg8-H-qPPjVzLqjD-gZ0.woff2") format("woff2");font-weight:700;font-style:normal;font-display:swap}
@font-face{font-family:"Comic Neue";src:url("https://fonts.gstatic.com/s/comicneue/v8/4UaAjXhSlzgzg8-H-qPPjVzLqjD-gZ0.woff2") format("woff2");font-weight:800;font-style:normal;font-display:swap}
</style>
<body>

<!-- Screens -->
<div id="hello" class="screen active">
  <div class="glass hello-wrap">
    <div class="hello-text">Welcome to AuraAI ‚ú®</div>
    <div class="hello-sub">Choose an activity to start.</div>
    <div class="hello-actions">
      <button class="btn" onclick="showScreen('draw')">Start Drawing üé®</button>
      <button class="btn" onclick="showScreen('game')">Play a Game üéÆ</button>
      <button class="btn" onclick="showScreen('chat')">Chat with Me üëã</button>
    </div>
  </div>
</div>

<div id="draw" class="screen">
  <div class="glass draw-wrap">
    <div class="bar">
      <div class="title">Drawing Pad üñåÔ∏è</div>
      <div class="draw-tools">
        <div class="brush">
          Size: <input type="range" id="brush-size" min="1" max="50" value="10">
        </div>
        <div class="picker">
          Color: <input type="color" id="brush-color" value="#000000">
        </div>
        <div class="toggle">
          Eraser: <input type="checkbox" id="eraser-toggle">
        </div>
      </div>
    </div>
    <canvas id="draw-canvas" class="draw-canvas"></canvas>
    <div class="draw-bottom">
      <button class="btn" onclick="clearCanvas()">Clear üñºÔ∏è</button>
      <button class="btn" onclick="saveDrawingAsTheme()">Save as Theme üíæ</button>
      <button class="btn" onclick="showScreen('hello')">Back Home üè†</button>
    </div>
  </div>
</div>

<div id="game" class="screen">
  <div class="glass game-wrap">
    <div class="bar">
      <div class="title">Bubble Pop Game ü´ß</div>
      <div class="game-ind">Score: <span id="score">0</span></div>
    </div>
    <canvas id="game-canvas" class="draw-canvas"></canvas>
    <div class="draw-bottom">
        <button class="btn" id="start-game-btn">Start Game üöÄ</button>
        <button class="btn" onclick="showScreen('hello')">Back Home üè†</button>
    </div>
  </div>
</div>

<div id="chat" class="screen">
  <div class="glass chat-container">
    <div class="header-controls">
      <div class="mood-header" id="current-mood-header">Hi there!</div>
      <div class="header-buttons">
        <button class="btn" onclick="toggleThemes()">Themes üé®</button>
        <button class="btn" onclick="showScreen('hello')">Back Home üè†</button>
      </div>
    </div>
    <div id="mood-strip">
      <button class="mood-btn happy" onclick="setMood('happy')">Happy üòÑ</button>
      <button class="mood-btn sad" onclick="setMood('sad')">Sad üòî</button>
      <button class="mood-btn angry" onclick="setMood('angry')">Angry üò°</button>
      <button class="mood-btn nervous" onclick="setMood('nervous')">Nervous üò•</button>
    </div>
    <div id="chat-box"></div>
    <div class="chat-input-container">
      <input type="text" id="chat-input" placeholder="Type your message..." style="width:100%">
      <button class="btn" onclick="sendMessage()">Send üí¨</button>
    </div>
  </div>
</div>

<!-- Theme Panel -->
<div id="themes-panel" class="themes-panel">
  <div class="themes-head">
    <h4>Choose a Theme üåà</h4>
    <button class="btn" onclick="toggleThemes()">Close ‚úñÔ∏è</button>
  </div>
  <div class="theme-category-tabs" id="theme-category-tabs"></div>
  <div id="themes-grid" class="themes-grid"></div>
</div>

<!-- Music Player -->
<div id="music-toggle" class="music-toggle off" onclick="toggleMusic()">
  <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M5 3l14 9-14 9V3z"></path>
  </svg>
  <svg class="pause-icon" viewBox="0 0 24 24" fill="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M6 4h4v16H6zM14 4h4v16h-4z"></path>
  </svg>
  <span id="music-status">Music Off üéµ</span>
</div>
<audio id="bgm" loop></audio>

<!-- Message Box Overlay -->
<div id="overlay" class="overlay">
  <div class="msg-box">
    <h3 id="msg-title"></h3>
    <p id="msg-text"></p>
    <button id="msg-btn">OK</button>
  </div>
</div>

<script>
// --- Core App Logic ---
let activeScreenId = 'hello';
let currentTheme = { category: 'grayscale', name: 'Charcoal' };
const screens = {};
const savedGalleryThemesKey = 'aura-gallery-themes';
const themes = {
  // New Grayscale category
  'Grayscale': [
    { name: 'Pure White', type: 'color', bg: '#ffffff', grad: '#f0f0f0', text: '#000000' },
    { name: 'White Smoke', type: 'color', bg: '#F5F5F5', grad: '#E8E8E8', text: '#3c3c3c' },
    { name: 'Light Gray', type: 'color', bg: '#d3d3d3', grad: '#c0c0c0', text: '#3c3c3c' },
    { name: 'Silver Mist', type: 'color', bg: '#b0b0b0', grad: '#a0a0a0', text: '#fff' },
    { name: 'Steel Gray', type: 'color', bg: '#708090', grad: '#6c7a89', text: '#fff' },
    { name: 'Slate', type: 'color', bg: '#405d72', grad: '#3c586b', text: '#fff' },
    { name: 'Gunmetal', type: 'color', bg: '#2c3539', grad: '#364044', text: '#fff' },
    { name: 'Charcoal', type: 'color', bg: '#36454f', grad: '#2c3539', text: '#fff' },
    { name: 'Dark Slate', type: 'color', bg: '#2f4f4f', grad: '#243c3c', text: '#fff' },
    { name: 'Jet Black', type: 'color', bg: '#000000', grad: '#1a1a1a', text: '#fff' },
    { name: 'White', type: 'color', bg: '#ffffff', text: '#000000' },
    { name: 'Gray', type: 'color', bg: '#808080', text: '#fff' },
    { name: 'Black', type: 'color', bg: '#000000', text: '#fff' },
    { name: 'Off White', type: 'color', bg: '#fafafa', text: '#3c3c3c' },
    { name: 'Dim Gray', type: 'color', bg: '#696969', text: '#fff' },
    { name: 'Dark Gray', type: 'color', bg: '#a9a9a9', text: '#fff' },
    { name: 'Slate Gray', type: 'color', bg: '#708090', text: '#fff' },
    { name: 'Light Slate Gray', type: 'color', bg: '#778899', text: '#fff' },
    { name: 'Dark Slate Gray', type: 'color', bg: '#2f4f4f', text: '#fff' },
    { name: 'Snow', type: 'color', bg: '#FFFAFA', text: '#3c3c3c' },
    { name: 'Ivory', type: 'color', bg: '#FFFFF0', text: '#3c3c3c' },
    { name: 'Gainsboro', type: 'color', bg: '#DCDCDC', text: '#3c3c3c' },
    { name: 'Alice Blue', type: 'color', bg: '#F0F8FF', text: '#3c3c3c' },
    { name: 'Ghost White', type: 'color', bg: '#F8F8FF', text: '#3c3c3c' },
    { name: 'Dark White', type: 'color', bg: '#F1F1F1', text: '#3c3c3c' },
    { name: 'Midnight Blue', type: 'color', bg: '#191970', text: '#fff' },
    { name: 'Dark Blue', type: 'color', bg: '#00008b', text: '#fff' },
    { name: 'Steel Blue', type: 'color', bg: '#4682b4', text: '#fff' },
    { name: 'Dark Steel Blue', type: 'color', bg: '#483d8b', text: '#fff' },
    { name: 'Light Steel Blue', type: 'color', bg: '#b0c4de', text: '#3c3c3c' }
  ],
  // 100 THEMES IN TOTAL, organized by category
  'Gradient': [
    { name: 'Aurora', type: 'color', bg: '#a8cdf1', grad: '#f7b7b9', text: '#0b3c61' },
    { name: 'Sunset', type: 'color', bg: '#fdbb2d', grad: '#22c1c3', text: '#3c3c3c' },
    { name: 'Forest', type: 'color', bg: '#43ac62', grad: '#6a9d77', text: '#f0f0f0' },
    { name: 'Ocean', type: 'color', bg: '#005bea', grad: '#00c6fb', text: '#fff' },
    { name: 'Lavender', type: 'color', bg: '#c495d4', grad: '#b669c6', text: '#fff' },
    { name: 'Night Sky', type: 'color', bg: '#1c1c1c', grad: '#3f3f3f', text: '#fff' },
    { name: 'Candy', type: 'color', bg: '#ff7e5f', grad: '#feb47b', text: '#fff' },
    { name: 'Mint', type: 'color', bg: '#9de0ad', grad: '#45a247', text: '#fff' },
    { name: 'Fire', type: 'color', bg: '#ff416c', grad: '#ff4b2b', text: '#fff' },
    { name: 'Emerald', type: 'color', bg: '#56ab2f', grad: '#a8e063', text: '#fff' },
    { name: 'Grape', type: 'color', bg: '#662d8c', grad: '#ed1e79', text: '#fff' },
    { name: 'Sky', type: 'color', bg: '#a8c0ff', grad: '#3f2b96', text: '#fff' },
    { name: 'Plum', type: 'color', bg: '#61045f', grad: '#ae2869', text: '#fff' },
    { name: 'Rose', type: 'color', bg: '#fecfef', grad: '#ff9a9e', text: '#3c3c3c' },
    { name: 'Aqua', type: 'color', bg: '#74ebd5', grad: '#acb6e5', text: '#3c3c3c' },
    { name: 'Teal', type: 'color', bg: '#008b8b', grad: '#00ced1', text: '#fff' },
    { name: 'Coral', type: 'color', bg: '#ff6b6b', grad: '#ffc87c', text: '#fff' },
    { name: 'Violet', type: 'color', bg: '#8c52ff', grad: '#5ce1e6', text: '#fff' },
    { name: 'Sunburst', type: 'color', bg: '#ff9900', grad: '#ffb366', text: '#fff' },
    { name: 'Cobalt', type: 'color', bg: '#0047ab', grad: '#1e90ff', text: '#fff' },
    { name: 'Denim', type: 'color', bg: '#1565c0', grad: '#2196f3', text: '#fff' },
    { name: 'Sky Blue', type: 'color', bg: '#87ceeb', grad: '#b0e0e6', text: '#3c3c3c' },
    { name: 'Tangerine', type: 'color', bg: '#f28500', grad: '#ff7518', text: '#fff' },
    { name: 'Jade', type: 'color', bg: '#00a86b', grad: '#00a880', text: '#fff' },
    { name: 'Turquoise', type: 'color', bg: '#40e0d0', grad: '#48d1cc', text: '#3c3c3c' },
    { name: 'Indigo', type: 'color', bg: '#4b0082', grad: '#5c4179', text: '#fff' },
    { name: 'Lilac', type: 'color', bg: '#b66dff', grad: '#c5a0d3', text: '#fff' },
    { name: 'Forest Green', type: 'color', bg: '#013220', grad: '#015e34', text: '#fff' },
    { name: 'Navy', type: 'color', bg: '#000080', grad: '#0000a0', text: '#fff' },
    { name: 'Grapefruit', type: 'color', bg: '#ff6a6a', grad: '#ff66c4', text: '#fff' },
    { name: 'Lagoon', type: 'color', bg: '#0061ff', grad: '#60efbc', text: '#fff' },
    { name: 'Peaches', type: 'color', bg: '#ffb347', grad: '#ffcc33', text: '#fff' },
    { name: 'Neon', type: 'color', bg: '#39ff14', grad: '#00ffc8', text: '#3c3c3c' },
    { name: 'Cosmic', type: 'color', bg: '#232c3f', grad: '#48587c', text: '#fff' },
    { name: 'Electric', type: 'color', bg: '#8e2de2', grad: '#4a00e0', text: '#fff' },
    { name: 'Ocean 2', type: 'color', bg: '#06637e', grad: '#46a3b2', text: '#fff' }
  ],
  'Pastel': [
    { name: 'Pastel Dreams', type: 'color', bg: '#ffb3ba', grad: '#ffdfba', text: '#3c3c3c' },
    { name: 'Lemonade', type: 'color', bg: '#fffacd', grad: '#b3e0ff', text: '#3c3c3c' },
    { name: 'Strawberry', type: 'color', bg: '#f1a89c', grad: '#f3c4c0', text: '#3c3c3c' },
    { name: 'Aqua Mint', type: 'color', bg: '#b2fef8', grad: '#b5ffeb', text: '#3c3c3c' },
    { name: 'Powder Blue', type: 'color', bg: '#b1d4e0', grad: '#b3d3e3', text: '#3c3c3c' },
    { name: 'Wisteria', type: 'color', bg: '#c9b1e5', grad: '#c1b4e5', text: '#3c3c3c' },
    { name: 'Dusty Rose', type: 'color', bg: '#e0c9c7', grad: '#e3d2cf', text: '#3c3c3c' },
    { name: 'Lime', type: 'color', bg: '#c6ffdd', grad: '#fbd786', text: '#3c3c3c' },
    { name: 'Sand', type: 'color', bg: '#f1d2b1', grad: '#e2bc91', text: '#4a3220' },
    { name: 'Mystic', type: 'color', bg: '#d4c7f0', grad: '#a894cc', text: '#3c3c3c' },
    { name: 'Cotton Candy', type: 'color', bg: '#ffb6c1', grad: '#ffa07a', text: '#3c3c3c' },
    { name: 'Bubblegum', type: 'color', bg: '#ff85a1', grad: '#ffc0cb', text: '#fff' },
    { name: 'Cloudy Sky', type: 'color', bg: '#d3e8f1', grad: '#e0f1f9', text: '#3c3c3c' },
    { name: 'Soft Peach', type: 'color', bg: '#ffdab9', grad: '#ffc4b1', text: '#3c3c3c' },
    { name: 'Seafoam', type: 'color', bg: '#b5e3d7', grad: '#aed9cb', text: '#3c3c3c' },
    { name: 'Lilac Petals', type: 'color', bg: '#c8a2c8', grad: '#d4b7d4', text: '#3c3c3c' }
  ],
  'Metallic': [
    { name: 'Gold', type: 'color', bg: '#b8924b', grad: '#d7c797', text: '#4a3220' },
    { name: 'Silver', type: 'color', bg: '#c0c0c0', grad: '#d9d9d9', text: '#3c3c3c' },
    { name: 'Bronze', type: 'color', bg: '#cd7f32', grad: '#8b4513', text: '#fff' },
    { name: 'Copper', type: 'color', bg: '#b87333', grad: '#b56149', text: '#fff' },
    { name: 'Platinum', type: 'color', bg: '#e5e4e2', grad: '#c0c0c0', text: '#3c3c3c' },
    { name: 'Ruby', type: 'color', bg: '#e0115f', grad: '#c00742', text: '#fff' },
    { name: 'Sapphire', type: 'color', bg: '#0f52ba', grad: '#0073e6', text: '#fff' },
    { name: 'Emerald Gem', type: 'color', bg: '#046307', grad: '#05900a', text: '#fff' },
    { name: 'Amethyst', type: 'color', bg: '#9966cc', grad: '#b399e5', text: '#fff' },
    { name: 'Steel', type: 'color', bg: '#4682b4', grad: '#6a8db6', text: '#fff' },
    { name: 'Chrome', type: 'color', bg: '#8d929b', grad: '#a2a7af', text: '#3c3c3c' },
    { name: 'Rose Gold', type: 'color', bg: '#b76e79', grad: '#c18f8f', text: '#fff' }
  ],
  'Animated': [
    { name: 'Shifting Rainbow', type: 'animated', grad: '#ff6b6b, #ffc87c, #d5a3ff, #8aff8a', text: '#fff' },
    { name: 'Ocean Waves', type: 'animated', grad: '#005bea, #00c6fb, #61d7f6, #005bea', text: '#fff' },
    { name: 'Forest Glow', type: 'animated', grad: '#43ac62, #6a9d77, #8bb87d, #43ac62', text: '#fff' },
    { name: 'Cosmic Dust', type: 'animated', grad: '#1c1c1c, #3f3f3f, #5b5b5b, #1c1c1c', text: '#fff' },
    { name: 'Liquid Fire', type: 'animated', grad: '#ff416c, #ff4b2b, #ff8c00, #ff416c', text: '#fff' },
    { name: 'Cyber Blue', type: 'animated', grad: '#00ffc8, #006aff, #8a2be2, #00ffc8', text: '#fff' },
    { name: 'Synthwave', type: 'animated', grad: '#8e2de2, #4a00e0, #ff007f, #8e2de2', text: '#fff' },
    { name: 'Volcano', type: 'animated', grad: '#d21f3c, #ff4500, #ffd700, #d21f3c', text: '#fff' }
  ],
  'Poster': [
    { name: 'Crimson', type: 'color', bg: '#8d0426', text: '#fff' },
    { name: 'Slate', type: 'color', bg: '#405d72', text: '#fff' },
    { name: 'Carbon', type: 'color', bg: '#232526', text: '#fff' },
    { name: 'Ruby', type: 'color', bg: '#d62828', text: '#fff' },
    { name: 'Mahogany', type: 'color', bg: '#4c1e19', text: '#fff' },
    { name: 'Olive', type: 'color', bg: '#556b2f', text: '#fff' },
    { name: 'Charcoal', type: 'color', bg: '#36454f', text: '#fff' },
    { name: 'Lemon', type: 'color', bg: '#fff733', text: '#3c3c3c' },
    { name: 'Azure', type: 'color', bg: '#007fff', text: '#fff' },
    { name: 'Maroon', type: 'color', bg: '#800000', text: '#fff' },
    { name: 'Jade', type: 'color', bg: '#00a86b', text: '#fff' },
    { name: 'Navy Blue', type: 'color', bg: '#000080', text: '#fff' },
    { name: 'Slate Gray', type: 'color', bg: '#708090', text: '#fff' },
    { name: 'Chocolate', type: 'color', bg: '#7b3f00', text: '#fff' },
    { name: 'Dark Green', type: 'color', bg: '#006400', text: '#fff' },
    { name: 'Midnight', type: 'color', bg: '#0a0a23', text: '#fff' },
    { name: 'Teal Green', type: 'color', bg: '#008080', text: '#fff' },
    { name: 'Eggplant', type: 'color', bg: '#614051', text: '#fff' },
    { name: 'Burnt Orange', type: 'color', bg: '#cc5500', text: '#fff' },
    { name: 'Mustard', type: 'color', bg: '#ffdb58', text: '#3c3c3c' },
    { name: 'Terracotta', type: 'color', bg: '#e2725b', text: '#fff' },
    { name: 'Rust', type: 'color', bg: '#b7410e', text: '#fff' },
    { name: 'Dark Cyan', type: 'color', bg: '#008b8b', text: '#fff' },
    { name: 'Dark Magenta', type: 'color', bg: '#8b008b', text: '#fff' },
    { name: 'Sienna', type: 'color', bg: '#a0522d', text: '#fff' },
    { name: 'Olive Drab', type: 'color', bg: '#6b8e23', text: '#fff' },
    { name: 'Pine Green', type: 'color', bg: '#01796f', text: '#fff' },
    { name: 'Navy', type: 'color', bg: '#000080', text: '#fff' },
    { name: 'Dark Slate Blue', type: 'color', bg: '#483d8b', text: '#fff' },
    { name: 'Steel Blue', type: 'color', bg: '#4682b4', text: '#fff' },
    { name: 'Slate Grey', type: 'color', bg: '#708090', text: '#fff' },
    { name: 'Deep Sea', type: 'color', bg: '#003153', text: '#fff' },
    { name: 'Oxblood', type: 'color', bg: '#4a0000', text: '#fff' },
    { name: 'Graphite', type: 'color', bg: '#2f4f4f', text: '#fff' },
    { name: 'Falu Red', type: 'color', bg: '#801818', text: '#fff' }
  ]
};

document.addEventListener('DOMContentLoaded', () => {
  // Initial setup for screens
  document.querySelectorAll('.screen').forEach(el => screens[el.id] = el);
  showScreen(activeScreenId);

  // Initialize all sections
  initMusicPlayer();
  initThemeSwitcher();
  initDrawingPadLogic();
  initBubbleGameLogic();
  initChatbot();

  // Handle back button on mobile
  window.addEventListener('popstate', (event) => {
    if (event.state && event.state.screen) {
      showScreen(event.state.screen);
    }
  });
  
  // Push the initial state for the 'hello' screen
  history.pushState({ screen: 'hello' }, 'AuraAI Home', '#hello');
});

function showScreen(id) {
  // Push new state for browser history
  if (id !== activeScreenId) {
    history.pushState({ screen: id }, `AuraAI ${id.charAt(0).toUpperCase() + id.slice(1)}`, `#${id}`);
  }

  // Hide all screens
  for (const screenId in screens) {
    screens[screenId].classList.remove('active');
  }
  // Show the requested screen
  screens[id].classList.add('active');
  activeScreenId = id;
}

// --- Music Player ---
function initMusicPlayer() {
  const audio = document.getElementById('bgm');
  const musicToggle = document.getElementById('music-toggle');
  const musicStatus = document.getElementById('music-status');
  
  // Array of your music URLs from GitHub
  const musicUrls = [
    // ‚ö†Ô∏è IMPORTANT: Please replace these with your actual RAW GitHub URLs for bgm1, bgm2, and bgm3.mp3
    // Example: 'https://raw.githubusercontent.com/your-username/your-repo/main/music/bgm1.mp3'
    'https://raw.githubusercontent.com/username/repository/main/path/to/bgm1.mp3',
    'https://raw.githubusercontent.com/username/repository/main/path/to/bgm2.mp3',
    'https://raw.githubusercontent.com/username/repository/main/path/to/bgm3.mp3'
  ];
  let currentTrackIndex = 0;

  // Function to load and play the next track
  function playNextTrack() {
    // Stop the current track if it's playing
    audio.pause();
    // Move to the next track in the list
    currentTrackIndex = (currentTrackIndex + 1) % musicUrls.length;
    // Set the new track's source
    audio.src = musicUrls[currentTrackIndex];
    // Load and play the new track
    audio.load();
    audio.play();
  }

  // Set up event listener for when a track ends
  audio.addEventListener('ended', playNextTrack);

  // Expose the toggleMusic function to the global scope
  window.toggleMusic = function() {
    if (musicUrls.length === 0 || musicUrls[0] === 'https://raw.githubusercontent.com/username/repository/main/path/to/bgm1.mp3') {
      showMessageBox('No Music', 'Please add your music URLs to the code.', 'OK');
      return;
    }

    if (musicToggle.classList.contains('on')) {
      audio.pause();
      musicToggle.classList.remove('on');
      musicToggle.classList.add('off');
      musicStatus.textContent = 'Music Off üéµ';
    } else {
      if (!audio.src) {
        // If no source is set, start the first track
        audio.src = musicUrls[currentTrackIndex];
      }
      audio.play().catch(e => {
        // Catch and handle the 'NotSupportedError'
        if (e.name === "NotSupportedError") {
          showMessageBox('Error', 'Music playback failed. Please check the URLs in your code to make sure they are raw audio files.', 'OK');
        } else {
          // Other potential errors
          showMessageBox('Error', `Music playback failed: ${e.message}.`, 'OK');
        }
        console.error("Audio playback error:", e);
        audio.pause();
        musicToggle.classList.remove('on');
        musicToggle.classList.add('off');
        musicStatus.textContent = 'Music Off üéµ';
      });
      musicToggle.classList.remove('off');
      musicToggle.classList.add('on');
      musicStatus.textContent = 'Music On üé∂';
    }
  };
}

// --- Message Box Functions ---
function showMessageBox(title, message, buttonText) {
    const overlay = document.getElementById('overlay');
    const msgTitle = document.getElementById('msg-title');
    const msgText = document.getElementById('msg-text');
    const msgBtn = document.getElementById('msg-btn');
    
    msgTitle.textContent = title;
    msgText.textContent = message;
    msgBtn.textContent = buttonText;
    
    overlay.classList.add('visible');
    
    return new Promise(resolve => {
        msgBtn.onclick = () => {
            overlay.classList.remove('visible');
            resolve();
        };
    });
}


// --- Theme Switcher ---
function initThemeSwitcher() {
  const themesGrid = document.getElementById('themes-grid');
  const categoryTabs = document.getElementById('theme-category-tabs');
  const themesPanel = document.getElementById('themes-panel');
  const categories = ['Grayscale', 'Gradient', 'Pastel', 'Metallic', 'Animated', 'Poster', 'Gallery', 'Upload'];
  
  let currentCategory = 'Grayscale';

  // Load saved gallery themes from local storage
  let savedGalleryThemes = JSON.parse(localStorage.getItem(savedGalleryThemesKey)) || [];

  function renderCategories() {
    categoryTabs.innerHTML = '';
    categories.forEach(category => {
      const btn = document.createElement('button');
      btn.textContent = category;
      if (category === currentCategory) {
        btn.classList.add('active');
      }
      btn.onclick = () => {
        currentCategory = category;
        renderCategories(); // Re-render to update active state
        renderThemes(category);
      };
      categoryTabs.appendChild(btn);
    });
  }

  function renderThemes(category) {
    themesGrid.innerHTML = '';
    let themesToDisplay = [];
    
    if (category === 'Gallery') {
      themesToDisplay = savedGalleryThemes.map((img, index) => ({
        name: `My Drawing ${index + 1}`,
        type: 'gallery',
        dataUrl: img
      }));
      // Add a placeholder for adding new drawings
      themesToDisplay.push({ name: 'Save a new one!', type: 'gallery-save', bg: 'rgba(0,0,0,0.1)' });
    } else if (category === 'Upload') {
       themesToDisplay = [{ name: 'Upload Image', type: 'upload', bg: 'rgba(0,0,0,0.1)' }];
    } else {
      themesToDisplay = themes[category];
    }
    
    themesToDisplay.forEach((theme, index) => {
      const box = document.createElement('div');
      box.className = 'theme-box';
      
      const themeLabel = document.createElement('div');
      themeLabel.className = 'theme-box-label';
      themeLabel.textContent = theme.name;
      box.appendChild(themeLabel);

      if (theme.type === 'color') {
        const bgDiv = document.createElement('div');
        bgDiv.style.background = `linear-gradient(135deg, ${theme.bg} 0%, ${theme.grad || theme.bg} 100%)`;
        bgDiv.style.width = '100%';
        bgDiv.style.height = '100%';
        box.appendChild(bgDiv);
      } else if (theme.type === 'animated') {
        box.style.background = `linear-gradient(270deg, ${theme.grad})`;
        box.style.backgroundSize = '400% 400%';
        box.style.animation = 'gradientAnimation 10s ease infinite';
      } else if (theme.type === 'gallery') {
        box.classList.add('gallery-theme');
        box.style.backgroundImage = `url(${theme.dataUrl})`;
        box.style.backgroundSize = 'cover';
        box.style.backgroundPosition = 'center';
      } else if (theme.type === 'gallery-save') {
        box.textContent = '+';
        box.style.fontSize = '40px';
        box.style.display = 'flex';
        box.style.justifyContent = 'center';
        box.style.alignItems = 'center';
        box.style.backgroundColor = 'rgba(0,0,0,0.05)';
        box.style.border = '2px dashed rgba(0,0,0,0.2)';
      } else if (theme.type === 'upload') {
        box.classList.add('upload-theme');
      }

      box.onclick = () => {
        if (theme.type === 'gallery-save') {
          toggleThemes();
          showScreen('draw');
          showMessageBox('Draw a Theme', 'Use the drawing pad to create a custom background, then click "Save as Theme".', 'OK');
        } else if (theme.type === 'upload') {
          // Trigger file input for upload
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.accept = 'image/*';
          fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
              const reader = new FileReader();
              reader.onload = (event) => {
                const dataUrl = event.target.result;
                savedGalleryThemes.unshift(dataUrl); // Add to the beginning
                localStorage.setItem(savedGalleryThemesKey, JSON.stringify(savedGalleryThemes));
                // Immediately apply the new theme
                applyTheme({ type: 'gallery', dataUrl: dataUrl });
                // Re-render gallery with new theme
                renderThemes('Gallery');
              };
              reader.readAsDataURL(file);
            }
          };
          fileInput.click();
        } else {
          applyTheme(theme);
          // Highlight the active theme box
          document.querySelectorAll('.theme-box').forEach(b => b.classList.remove('active'));
          box.classList.add('active');
        }
      };
      themesGrid.appendChild(box);
    });
  }

  function applyTheme(theme) {
    const root = document.documentElement;
    const body = document.body;

    // Reset properties and classes
    root.style.removeProperty('--accent-grad');
    root.style.removeProperty('--text');
    root.style.removeProperty('--muted');
    root.style.removeProperty('--glass-bg');
    root.style.removeProperty('--glass-border');
    body.style.background = '';
    body.classList.remove('animated-theme');

    if (theme.type === 'color') {
      root.style.setProperty('--accent-grad', `linear-gradient(90deg, ${theme.grad || theme.bg} 0%, ${theme.bg} 100%)`);
      root.style.setProperty('--text', theme.text);
      root.style.setProperty('--muted', hexToRgba(theme.text, 0.65));
      body.style.backgroundColor = theme.bg;
    } else if (theme.type === 'animated') {
      body.classList.add('animated-theme');
      body.style.backgroundImage = `linear-gradient(270deg, ${theme.grad})`;
      root.style.setProperty('--text', theme.text);
      root.style.setProperty('--muted', hexToRgba(theme.text, 0.65));
      root.style.setProperty('--accent-grad', `linear-gradient(90deg, #fff, ${theme.grad.split(',')[0].trim()})`);
    } else if (theme.type === 'gallery') {
      root.style.setProperty('--accent-grad', 'linear-gradient(90deg, #a8cdf1 0%,#f7b7b9 100%)');
      root.style.setProperty('--text', '#0b3c61');
      root.style.setProperty('--muted', 'rgba(11,60,97,0.65)');
      body.style.backgroundImage = `url(${theme.dataUrl})`;
      body.style.backgroundSize = 'cover';
      body.style.backgroundPosition = 'center';
      body.style.backgroundRepeat = 'no-repeat';
      body.style.transition = 'none'; // Disable transition for images
    }

    // Set glass properties for gallery themes
    if (theme.type === 'gallery') {
      root.style.setProperty('--glass-bg', 'rgba(255,255,255,0.4)');
      root.style.setProperty('--glass-border', 'rgba(255,255,255,0.5)');
    } else {
      root.style.setProperty('--glass-bg', 'rgba(255,255,255,0.20)');
      root.style.setProperty('--glass-border', 'rgba(255,255,255,0.28)');
    }

    currentTheme = theme;
    
    // Update active state of button
    const activeCategoryButton = document.querySelector('.theme-category-tabs button.active');
    if (activeCategoryButton) {
        activeCategoryButton.classList.remove('active');
    }
    document.querySelector(`.theme-category-tabs button:first-child`).classList.add('active');
  }
  
  window.toggleThemes = function() {
    themesPanel.classList.toggle('active');
  };

  function hexToRgba(hex, alpha) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r}, ${g}, ${b}, ${alpha})`;
  }
  
  renderCategories();
  renderThemes(currentCategory);
}


// --- Drawing Pad ---
function initDrawingPadLogic() {
  const canvas = document.getElementById('draw-canvas');
  const ctx = canvas.getContext('2d');
  const brushSizeInput = document.getElementById('brush-size');
  const brushColorInput = document.getElementById('brush-color');
  const eraserToggle = document.getElementById('eraser-toggle');
  
  let isDrawing = false;
  let lastX = 0;
  let lastY = 0;

  // Set initial canvas size
  function resizeCanvas() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    ctx.lineCap = 'round';
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  function draw(e) {
    if (!isDrawing) return;
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(x, y);
    ctx.stroke();

    [lastX, lastY] = [x, y];
  }

  // Mouse event listeners
  canvas.addEventListener('mousedown', (e) => {
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    [lastX, lastY] = [e.clientX - rect.left, e.clientY - rect.top];
  });
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', () => isDrawing = false);
  canvas.addEventListener('mouseout', () => isDrawing = false);

  // Touch event listeners
  canvas.addEventListener('touchstart', (e) => {
    e.preventDefault(); // Prevent scrolling
    isDrawing = true;
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    [lastX, lastY] = [touch.clientX - rect.left, touch.clientY - rect.top];
  });
  canvas.addEventListener('touchmove', (e) => {
    e.preventDefault(); // Prevent scrolling
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    draw({ clientX: x, clientY: y });
  });
  canvas.addEventListener('touchend', () => isDrawing = false);

  brushSizeInput.addEventListener('input', () => {
    ctx.lineWidth = brushSizeInput.value;
  });

  brushColorInput.addEventListener('input', () => {
    ctx.strokeStyle = brushColorInput.value;
    eraserToggle.checked = false;
    ctx.globalCompositeOperation = 'source-over';
  });

  eraserToggle.addEventListener('change', () => {
    if (eraserToggle.checked) {
      ctx.globalCompositeOperation = 'destination-out';
      ctx.strokeStyle = 'rgba(0,0,0,1)';
      ctx.lineWidth = brushSizeInput.value;
    } else {
      ctx.globalCompositeOperation = 'source-over';
      ctx.strokeStyle = brushColorInput.value;
    }
  });
  
  // Set initial drawing properties
  ctx.lineWidth = brushSizeInput.value;
  ctx.strokeStyle = brushColorInput.value;
  
  // Expose global functions
  window.clearCanvas = function() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  };

  window.saveDrawingAsTheme = function() {
    const dataUrl = canvas.toDataURL('image/png');
    const savedThemes = JSON.parse(localStorage.getItem(savedGalleryThemesKey)) || [];
    // Add the new image to the front of the array
    savedThemes.unshift(dataUrl);
    // Limit to 10 saved themes
    if (savedThemes.length > 10) {
      savedThemes.pop();
    }
    localStorage.setItem(savedGalleryThemesKey, JSON.stringify(savedThemes));
    showMessageBox('Drawing Saved!', 'Your drawing has been saved as a new theme in the "Gallery" tab.', 'Awesome!');
    
    // Change to gallery tab and apply the new theme
    const galleryTab = document.querySelector('.theme-category-tabs button:nth-child(7)'); // 'Gallery' is the 7th button
    if (galleryTab) {
      galleryTab.click();
    }
  };
}


// --- Bubble Pop Game ---
function initBubbleGameLogic() {
  const canvas = document.getElementById('game-canvas');
  const ctx = canvas.getContext('2d');
  const scoreEl = document.getElementById('score');
  const startGameBtn = document.getElementById('start-game-btn');
  
  let score = 0;
  let bubbles = [];
  let isGameOver = false;
  let lastFrameTime = 0;
  const bubbleSpawnInterval = 1000; // milliseconds
  let timeSinceLastBubble = 0;

  class Bubble {
    constructor(x, y, r, color, speed) {
      this.x = x;
      this.y = y;
      this.r = r;
      this.color = color;
      this.speed = speed;
      this.isPopped = false;
    }
    
    draw() {
      if (this.isPopped) return;
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
      ctx.fillStyle = this.color;
      ctx.shadowBlur = 10;
      ctx.shadowColor = this.color;
      ctx.fill();
      ctx.shadowBlur = 0;
      ctx.closePath();
    }
    
    update() {
      this.y -= this.speed;
    }
    
    isOffScreen() {
      return this.y + this.r < 0;
    }
  }

  function spawnBubble() {
    const r = Math.random() * 20 + 15; // Radius between 15 and 35
    const x = Math.random() * (canvas.width - 2 * r) + r;
    const y = canvas.height + r;
    const color = `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, 0.6)`;
    const speed = Math.random() * 2 + 1; // Speed between 1 and 3
    bubbles.push(new Bubble(x, y, r, color, speed));
  }
  
  function updateAndDrawBubbles(deltaTime) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    for (let i = bubbles.length - 1; i >= 0; i--) {
      bubbles[i].update();
      bubbles[i].draw();
      
      if (bubbles[i].isOffScreen()) {
        bubbles.splice(i, 1);
        if (!isGameOver) {
          endGame();
        }
      }
    }
  }

  function gameLoop(timestamp) {
    if (isGameOver) return;
    
    const deltaTime = timestamp - lastFrameTime;
    lastFrameTime = timestamp;
    
    timeSinceLastBubble += deltaTime;
    if (timeSinceLastBubble > bubbleSpawnInterval) {
      spawnBubble();
      timeSinceLastBubble = 0;
    }

    updateAndDrawBubbles(deltaTime);
    
    requestAnimationFrame(gameLoop);
  }

  function endGame() {
    isGameOver = true;
    showMessageBox('Game Over!', `You missed a bubble. Your final score is: ${score}`, 'Play Again');
    bubbles = [];
    startGameBtn.textContent = 'Play Again üöÄ';
    startGameBtn.style.display = 'block';
  }

  window.startGame = function() {
    score = 0;
    scoreEl.textContent = score;
    bubbles = [];
    isGameOver = false;
    startGameBtn.style.display = 'none';
    lastFrameTime = performance.now();
    requestAnimationFrame(gameLoop);
  }
  
  function resizeCanvas() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    if (!isGameOver) {
      updateAndDrawBubbles();
    }
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  function handleInteraction(x, y) {
    if (isGameOver) return;
    
    for (let i = bubbles.length - 1; i >= 0; i--) {
      const bubble = bubbles[i];
      const dist = Math.sqrt((x - bubble.x) ** 2 + (y - bubble.y) ** 2);
      if (dist < bubble.r) {
        // Bubble is "popped"
        bubble.isPopped = true;
        bubbles.splice(i, 1);
        score++;
        scoreEl.textContent = score;
        break;
      }
    }
  }

  canvas.addEventListener('mousedown', (e) => {
    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    handleInteraction(x, y);
  });
  
  canvas.addEventListener('touchstart', (e) => {
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const touch = e.touches[0];
    const x = touch.clientX - rect.left;
    const y = touch.clientY - rect.top;
    handleInteraction(x, y);
  });
  
  startGameBtn.addEventListener('click', () => {
    startGame();
  });
}

// --- Chatbot ---
function initChatbot() {
    const chatInput = document.getElementById('chat-input');
    const chatBox = document.getElementById('chat-box');
    const sendButton = document.querySelector('.chat-input-container button');
    
    let chatHistory = [];

    window.sendMessage = async function() {
        const text = chatInput.value.trim();
        if (text === '') return;

        addMessage('user', text);
        chatHistory.push({ role: 'user', parts: [{ text: text }] });
        
        chatInput.value = '';
        chatInput.disabled = true;
        sendButton.disabled = true;
        
        const loadingMessage = addMessage('bot', 'AuraAI is thinking...');

        try {
            const payload = {
                contents: chatHistory
            };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            
            removeMessage(loadingMessage);

            if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                const botResponse = result.candidates[0].content.parts[0].text;
                addMessage('bot', botResponse);
                chatHistory.push({ role: 'model', parts: [{ text: botResponse }] });
            } else {
                console.error('API response was malformed:', result);
                const fallbackMessage = "Hmm, I'm having a little trouble thinking right now. Could you please try asking in a different way?";
                addMessage('bot', fallbackMessage);
                chatHistory.push({ role: 'model', parts: [{ text: fallbackMessage }] });
            }

        } catch (error) {
            console.error('API Error:', error);
            removeMessage(loadingMessage);
            const errorMessage = "It looks like there's a problem with the connection right now. Let's try again in a bit!";
            addMessage('bot', errorMessage);
            chatHistory.push({ role: 'model', parts: [{ text: errorMessage }] });
        } finally {
            chatInput.disabled = false;
            sendButton.disabled = false;
            chatInput.focus();
        }
    };
    
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    function addMessage(sender, text, isTemp = false) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message', sender);
        msgDiv.textContent = text;
        if (isTemp) {
            msgDiv.dataset.temp = 'true';
        }
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
        return msgDiv;
    }
    
    function removeMessage(msgDiv) {
        if (msgDiv && msgDiv.parentNode) {
            msgDiv.parentNode.removeChild(msgDiv);
        }
    }
    
    async function fetchWithRetry(url, options, maxRetries = 5) {
        let retries = 0;
        while (true) {
            try {
                const response = await fetch(url, options);
                if (response.status === 429) {
                    if (retries < maxRetries) {
                        retries++;
                        const delay = Math.pow(2, retries) * 1000;
                        await new Promise(res => setTimeout(res, delay));
                        continue;
                    }
                }
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response;
            } catch (error) {
                if (retries < maxRetries) {
                    retries++;
                    const delay = Math.pow(2, retries) * 1000;
                    await new Promise(res => setTimeout(res, delay));
                    continue;
                }
                throw error;
            }
        }
    }
}
</script>
</body>
</html>
