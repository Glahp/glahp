<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aura AI ‚Äî All‚Äëin‚ÄëOne</title>

<!-- TensorFlow.js + MobileNet (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@3.1.0/dist/mobilenet.min.js"></script>

<style>
  :root{
    --pad:20px; --radius:16px;
    --glass-bg: rgba(255,255,255,0.20);
    --glass-border: rgba(255,255,255,0.28);
    --glass-shadow: 0 18px 40px rgba(0,0,0,0.22);
    --text:#0b3c61; --accent:#1E88E5;
    --bot-bg:#d6e6fb; --bot-fg:#074279;
    --user-bg:#517fc4; --user-fg:#e8f3fc;
    --motion-scale:0.75;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family: "Comic Neue", Arial, sans-serif;background:#a8cdf1;color:var(--text);display:flex;align-items:center;justify-content:center;overflow:hidden}
  .screen{position:absolute;inset:0;display:none;place-items:center;padding:var(--pad)}
  .screen.active{display:grid}
  .glass{background:var(--glass-bg);backdrop-filter: blur(14px);-webkit-backdrop-filter: blur(14px);border:1px solid var(--glass-border);box-shadow:var(--glass-shadow);border-radius:var(--radius)}
  .btn{border:0;cursor:pointer;border-radius:14px;padding:12px 16px;font-weight:800;font-size:15px;color:var(--text);background:linear-gradient(90deg,#a8cdf1 0%,#f7b7b9 100%);box-shadow:0 6px 12px rgba(0,0,0,.08)}
  .btn:active{transform:translateY(1px)}
  /* hello */
  .hello-wrap{width:min(980px,92vw);padding:28px;text-align:center;border-radius:18px}
  .hello-text{font-weight:900;font-size:clamp(42px,8vw,72px);line-height:1;margin:8px 0;background:linear-gradient(90deg,#fff,#f7b7b9,#a8cdf1,#fff);-webkit-background-clip:text;background-clip:text;color:transparent;user-select:none}
  .hello-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:12px}
  .hint{font-size:13px;opacity:.85;margin-top:12px}
  /* shared containers */
  .game-wrap{width:min(1000px,95vw);height:min(70vh,700px);padding:12px;display:grid;grid-template-rows:auto 1fr;gap:10px;border-radius:16px}
  .bar{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
  .left-group,.right-group{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .title{font-weight:900;font-size:20px}
  #gameCanvas{width:100%;height:100%;border-radius:14px;background:linear-gradient(135deg,#eaf6ff,#f6f0ff);display:block;outline:2px solid rgba(255,255,255,.5)}
  /* draw */
  .draw-wrap{width:min(1100px,96vw);height:min(76vh,760px);padding:12px;display:grid;grid-template-rows:auto 1fr auto;gap:10px;border-radius:16px}
  .draw-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .swatch{width:26px;height:26px;border-radius:50%;border:0;cursor:pointer;box-shadow:0 6px 14px rgba(0,0,0,.12)}
  .draw-canvas{width:100%;height:100%;border-radius:14px;background:rgba(255,255,255,.65);outline:2px solid rgba(255,255,255,.6)}
  .mini-meta{display:flex;flex-direction:column}
  /* chat */
  .chat-container{width:min(980px,92vw);padding:18px;display:flex;flex-direction:column;gap:12px;border-radius:16px}
  .header-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .mood-header{flex:1;text-align:center;font-weight:900;font-size:20px;padding:10px 12px;border-radius:12px;background:linear-gradient(90deg,#a8cdf1,#f7b7b9);box-shadow:0 4px 8px rgba(168,205,241,.3)}
  .mood-selector{display:flex;gap:10px}
  .mood-btn{border:0;flex:1;cursor:pointer;padding:10px 12px;border-radius:12px;font-weight:800}
  .mood-btn.happy{background:#c1e6a6}.mood-btn.sad{background:#a4c7f9}.mood-btn.angry{background:#f9d6d6}.mood-btn.nervous{background:#fff3c8}
  #chat-box{flex:1;min-height:240px;max-height:56vh;overflow:auto;padding:14px;border-radius:12px;background:rgba(232,242,252,.55)}
  .message{margin:8px 0;padding:10px 12px;border-radius:12px;max-width:78%;font-size:16px}
  .message.bot{background:var(--bot-bg);color:var(--bot-fg);align-self:flex-start}
  .message.user{background:var(--user-bg);color:var(--user-fg);align-self:flex-end;text-align:right}
  .message.fadein{animation:fadeIn .28s ease}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  .input-footer{position:relative}
  #user-input{width:100%;padding:14px 120px 14px 14px;border-radius:12px;border:1px solid #a9c8e8;background:rgba(255,255,255,.78);font-size:16px;outline:none}
  #send-btn{position:absolute;right:6px;top:6px;bottom:6px;width:108px;color:#fff;background:#88b7e5;border-radius:10px}
  /* flow card (app-in-app) */
  .aura-card{width:min(520px,88vw);padding:12px;border-radius:14px;background:linear-gradient(180deg,rgba(255,255,255,.6),rgba(255,255,255,.45));box-shadow:0 12px 30px rgba(0,0,0,.12)}
  .aura-header{display:flex;align-items:center;gap:12px}
  .aura-icon{width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,#1e88e5,#8e44ad);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:900;font-size:20px}
  .aura-lines{display:flex;flex-direction:column;gap:6px}
  .aura-actions{display:flex;gap:8px;margin-top:8px}
  .chip{border:0;border-radius:12px;padding:8px 12px;background:rgba(255,255,255,.7);cursor:pointer;font-weight:800}
  /* themes panel */
  .themes-panel{position:fixed;right:0;top:0;height:100%;width:0;opacity:0;pointer-events:none;z-index:1000;transition:width .28s ease,opacity .25s ease}
  .themes-panel.open{width:360px;opacity:1;pointer-events:auto}
  .themes-body{padding:12px;overflow:auto;height:calc(100% - 72px)}
  .group-title{font-weight:900;margin:8px 4px}
  .swatch-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .theme-btn{width:44px;height:44px;border-radius:8px;border:0;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,.12);position:relative}
  .theme-btn:hover{transform:translateY(-4px)}
  .theme-tooltip{position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);color:#fff;padding:6px 8px;border-radius:8px;font-size:12px;white-space:nowrap;display:none}
  .theme-btn:hover .theme-tooltip{display:block}
  /* miniplayer */
  .miniplayer{position:fixed;right:16px;bottom:16px;z-index:1200;display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;backdrop-filter:blur(8px);background:rgba(255,255,255,.7);box-shadow:0 10px 30px rgba(0,0,0,.12)}
  .mini-btn{background:rgba(255,255,255,.9);border-radius:10px;padding:8px 12px;border:0;cursor:pointer;box-shadow:0 6px 12px rgba(0,0,0,.06);font-weight:800}
  .mini-progress{appearance:none;width:220px;height:6px;border-radius:6px;background:rgba(0,0,0,.08)}
  .pulse{animation:pulse .9s infinite alternate}
  @keyframes pulse{from{transform:scale(1)}to{transform:scale(1.02)}}
  /* responsive */
  @media (max-width:880px){ .hello-text{font-size:42px} .themes-panel.open{width:100%} .miniplayer{left:10px;right:10px} }
</style>
</head>
<body>

<!-- HELLO -->
<section id="hello-screen" class="screen active">
  <div class="hello-wrap glass">
    <div class="hello-text">AuraAI</div>
    <div class="hello-sub">Hi üëã I‚Äôm your support buddy. What would you like to do today?</div>
    <div class="hello-actions">
      <button class="btn" id="goPlay">üéÆ Play a Game</button>
      <button class="btn" id="goDraw">üé® Draw Something</button>
      <button class="btn" id="goTalk">üí¨ Talk</button>
    </div>
    <div style="display:flex;justify-content:center;gap:8px;margin-top:14px">
      <button class="btn" id="themesToggle">üé® Themes</button>
      <button class="btn" id="musicToggle">üé∂ Music</button>
    </div>
    <div class="hint">Dedicated to Eswar ‚Äî we built this to help express, breathe, and connect. üíô</div>
  </div>
</section>

<!-- GAME -->
<section id="game-screen" class="screen">
  <div class="game-wrap glass">
    <div class="bar">
      <div class="left-group">
        <div class="title">ü´ß Bubble Pop ‚Äî calm your mind (Levels)</div>
      </div>
      <div class="right-group">
        <div class="game-ind">Level: <span id="levelTxt">1</span></div>
        <div class="game-ind">Score: <span id="scoreTxt">0</span></div>
        <button class="btn" id="resetGame">Reset</button>
        <button class="btn" id="backFromGame">‚¨Ö Back</button>
      </div>
    </div>
    <canvas id="gameCanvas" aria-label="Bubble Pop Canvas"></canvas>
  </div>
</section>

<!-- DRAW -->
<section id="draw-screen" class="screen">
  <div class="draw-wrap glass">
    <div class="bar">
      <div class="left-group">
        <div class="title">üé® Draw ‚Äî Challenges & Free‚Äëstyle</div>
        <div style="margin-left:8px" class="draw-controls">
          <button class="btn" id="newChallengeBtn">üîÑ New</button>
          <button class="btn" id="okChallengeBtn">‚úÖ Try</button>
          <button class="btn" id="noChallengeBtn">‚ùå No</button>
          <button class="btn" id="laterBtn">üïì Later</button>
          <button class="btn" id="clearBtn">Clear</button>
          <button class="btn" id="saveBtn">Save</button>
        </div>
      </div>
      <div class="right-group">
        <div class="game-ind">Auto‚ÄëCheck: <input type="checkbox" id="autoCheck" checked /></div>
        <button class="btn" id="backFromDraw">‚¨Ö Back</button>
      </div>
    </div>

    <canvas id="drawCanvas" class="draw-canvas" aria-label="Drawing Canvas" tabindex="0"></canvas>

    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
      <div style="display:flex;flex-direction:column;gap:6px">
        <div style="display:flex;gap:8px;align-items:center">
          <label style="font-weight:900">Challenge</label>
          <div id="challengeBox" class="aura-card" style="min-width:260px;padding:10px">
            <div style="display:flex;align-items:center;gap:8px">
              <div style="width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,#8e44ad,#1e88e5);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:900">A</div>
              <div style="display:flex;flex-direction:column">
                <div id="challengeText" style="font-weight:900">Loading challenge...</div>
                <div id="challengeHint" style="font-size:13px;opacity:.8">Say "Try" to accept or "Later" to free‚Äëstyle.</div>
              </div>
            </div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <label style="font-weight:900">Recognition</label>
          <div id="recognitionBox" class="aura-card" style="min-width:260px;padding:8px">
            <div id="recognitionResult">Awaiting drawing...</div>
          </div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        <div style="font-weight:900">Tools</div>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="brushSize" type="range" min="2" max="60" value="10" />
          <input id="colorPicker" type="color" value="#1e88e5" />
          <label style="display:flex;align-items:center;gap:6px"><input id="eraserToggle" type="checkbox">Eraser</label>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="freeStyleBtn">‚úèÔ∏è Free‚Äëstyle</button>
          <button class="btn" id="rotateBtn">üîÅ Rotate</button>
        </div>
      </div>
    </div>

  </div>
</section>

<!-- CHAT -->
<section id="chat-screen" class="screen">
  <div class="chat-container glass">
    <div class="header-controls">
      <div class="mood-header glass">How do you feel?</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn" id="voice-mode-btn" aria-pressed="false">üé§ Voice</button>
        <button class="btn" id="speak-reply-btn" aria-pressed="false">üîä Speak</button>
        <button class="btn" id="themeBtnChat">üé® Themes</button>
        <button class="btn" id="muteBtnChat">üîá Mute</button>
        <button class="btn" id="backFromChat">‚¨Ö Back</button>
      </div>
    </div>

    <div style="display:flex;gap:8px;align-items:center">
      <div class="mood-selector" style="flex:1">
        <button class="mood-btn happy" data-mood="happy">üòä Happy</button>
        <button class="mood-btn sad" data-mood="sad">üò¢ Sad</button>
        <button class="mood-btn angry" data-mood="angry">üò† Angry</button>
        <button class="mood-btn nervous" data-mood="nervous">üò∞ Nervous</button>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="activityBtn">‚ú® Activities</button>
      </div>
    </div>

    <div id="chat-box" role="log" aria-live="polite"></div>
    <div class="input-footer">
      <input id="user-input" placeholder="Type your response..." />
      <button id="send-btn" class="btn">Send</button>
    </div>

    <!-- Aura card (integrated into UI) -->
    <div style="margin-top:8px" class="aura-card">
      <div class="aura-header">
        <div class="aura-icon">A</div>
        <div class="aura-lines">
          <div style="font-weight:900">Aura ‚Äî Support Buddy</div>
          <div style="font-size:13px;opacity:.85">Quick tips, breathing exercises, activity suggestions</div>
        </div>
      </div>
      <div class="aura-actions" style="margin-top:8px">
        <button class="chip" data-activity="breathe">Breathe</button>
        <button class="chip" data-activity="doodle">Doodle</button>
        <button class="chip" data-activity="game">Play mini‚Äëgame</button>
        <button class="chip" data-activity="music">Listen</button>
      </div>
    </div>

  </div>
</section>

<!-- THEMES PANEL -->
<div id="themesPanel" class="themes-panel">
  <div class="panel-shell glass" style="height:100%;padding:12px;display:flex;flex-direction:column">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div style="font-weight:900">Themes</div>
      <button class="btn" id="closeThemes">‚úï</button>
    </div>
    <div class="themes-body" id="themesBody"></div>
  </div>
</div>

<!-- MINIPLAYER (3 tracks expected: bgm.mp3, bgm2.mp3, bgm3.mp3 in same repo) -->
<div id="miniPlayer" class="miniplayer" aria-label="Background Music Player">
  <button id="miniPlay" class="mini-btn">‚ñ∂Ô∏è</button>
  <div class="mini-meta">
    <div id="miniTitle" style="font-weight:900">No track</div>
    <input id="miniSeek" class="mini-progress" type="range" min="0" max="100" value="0" />
    <div style="font-size:12px;opacity:.85"><span id="miniCur">0:00</span> / <span id="miniDur">0:00</span></div>
  </div>
</div>

<script>
/* ============================
   Utilities & sound engine
   ============================ */
const Sound = (() => {
  let ctx; let muted=false;
  function ensure(){ if(!ctx){ const A=window.AudioContext||window.webkitAudioContext; if(A) ctx=new A(); } }
  function tone(f=440,d=0.06,t="sine",g=0.05){ if(muted) return; ensure(); if(!ctx) return; const o=ctx.createOscillator(), G=ctx.createGain(); o.type=t; o.frequency.value=f; G.gain.value=g; o.connect(G).connect(ctx.destination); o.start(); o.stop(ctx.currentTime+d); }
  return { click:()=>tone(600,0.04,"triangle",0.04), pop:()=>tone(900,0.08,"sine",0.07), scribble:()=>tone(280,0.03,"square",0.03), toggle:()=>tone(420,0.06,"sawtooth",0.05), setMuted:(v)=>muted=!!v, isMuted:()=>muted };
})();

/* ============================
   Screen router
   ============================ */
const screens = { hello:document.getElementById('hello-screen'), game:document.getElementById('game-screen'), draw:document.getElementById('draw-screen'), chat:document.getElementById('chat-screen') };
function switchScreen(k){ Object.values(screens).forEach(s=>s.classList.remove('active')); screens[k].classList.add('active'); window.scrollTo(0,0); }

/* Bind nav */
document.getElementById('goPlay').onclick=()=>{ Sound.click(); switchScreen('game'); startGameFlow(); };
document.getElementById('goDraw').onclick=()=>{ Sound.click(); switchScreen('draw'); loadRandomChallenge(); };
document.getElementById('goTalk').onclick=()=>{ Sound.click(); switchScreen('chat'); initChatExample(); };
document.getElementById('backFromGame').onclick=()=>{ Sound.click(); switchScreen('hello'); };
document.getElementById('backFromDraw').onclick=()=>{ Sound.click(); switchScreen('hello'); };
document.getElementById('backFromChat').onclick=()=>{ Sound.click(); switchScreen('hello'); };

/* ============================
   THEMES (100+) build UI
   ============================ */
const themesBody = document.getElementById('themesBody');
const THEMES = [];
// We'll create many themed swatches programmatically to reach 100+ with groups
const themeGroups = {
  "Glassy": [
    ["Glassy Arctic","linear-gradient(135deg,#e6f7ff,#eaf6ff)"],
    ["Glassy Dawn","linear-gradient(135deg,#fff1f0,#fff7e8)"],
    ["Glassy Mint","linear-gradient(135deg,#e6fff5,#dffbf0)"]
  ],
  "Metallic": [
    ["Metal Steel","linear-gradient(135deg,#c0c6cc,#9aa3ab)"],
    ["Metal Bronze","linear-gradient(135deg,#d6b89a,#b88466)"],
    ["Metal Chrome","linear-gradient(135deg,#e9eef2,#bfc7cc)"]
  ],
  "Poster": [
    ["Poster Neon","linear-gradient(135deg,#ff007f,#7f00ff)"],
    ["Poster Pop","linear-gradient(135deg,#ff8a00,#ff3d00)"],
    ["Poster Retro","linear-gradient(135deg,#ffd194,#cf6e6e)"]
  ],
  "Pastel": [
    ["Pastel Sky","#C7E9FF"],
    ["Pastel Mint","#C2F5E9"],
    ["Pastel Peach","#FFD1BA"]
  ],
  "Gradient": [
    ["Sunset","linear-gradient(135deg,#FF512F,#DD2476)"],
    ["Aurora","linear-gradient(135deg,#00d2ff,#3a7bd5)"],
    ["Night","linear-gradient(135deg,#141E30,#243B55)"]
  ],
  "Greyscale": [
    ["Paper Gray","#F4F6F8"],
    ["Slate","#7F8C8D"],
    ["Charcoal","#2C3E50"]
  ],
};

// auto-generate variants to surpass 100 entries
function buildThemes(){
  const names = [];
  let counter = 1;
  for(const [group, items] of Object.entries(themeGroups)){
    const gdiv = document.createElement('div');
    const gt = document.createElement('div'); gt.className='group-title'; gt.textContent = group; gdiv.appendChild(gt);
    const row = document.createElement('div'); row.className='swatch-row';
    items.forEach(([name, bg])=>{
      for(let i=0;i<6;i++){
        const nm = `${name}${i?(' '+(i+1)):''}`;
        const btn = document.createElement('button'); btn.className='theme-btn';
        btn.style.background = (typeof bg==='string' && bg.startsWith('#')) ? bg : bg;
        btn.setAttribute('data-bg', bg);
        btn.title = nm;
        const tt = document.createElement('span'); tt.className='theme-tooltip'; tt.textContent = nm; btn.appendChild(tt);
        btn.addEventListener('click', ()=>{ Sound.click(); applyTheme(btn.getAttribute('data-bg')); });
        row.appendChild(btn);
        THEMES.push({name:nm,bg});
        names.push(nm);
        counter++;
      }
    });
    gdiv.appendChild(row);
    themesBody.appendChild(gdiv);
  }

  // Add special rainbow loop theme
  const loopDiv = document.createElement('div'); loopDiv.className='group';
  const ltitle = document.createElement('div'); ltitle.className='group-title'; ltitle.textContent='Special';
  const lrow = document.createElement('div'); lrow.className='swatch-row';
  const rb = document.createElement('button'); rb.className='theme-btn'; rb.style.background='linear-gradient(90deg,#ff0000,#ff8000,#ffff00,#00ff00,#0000ff,#4b0082,#9400d3)'; rb.title='Rainbow Loop';
  const rtt = document.createElement('span'); rtt.className='theme-tooltip'; rtt.textContent='Rainbow Loop (cycles)'; rb.appendChild(rtt);
  rb.addEventListener('click', ()=>{ Sound.click(); enableRainbowLoop(); });
  lrow.appendChild(rb);
  loopDiv.appendChild(ltitle); loopDiv.appendChild(lrow);
  themesBody.appendChild(loopDiv);

  // Ensure 100+ by duplication if needed
  while(THEMES.length < 100){
    const idx = Math.floor(Math.random()*THEMES.length);
    const t = THEMES[idx];
    THEMES.push({name:t.name+'+', bg:t.bg});
    // append visual swatches too for user's theme panel
    const row = themesBody.querySelector('.swatch-row');
    if(row){
      const btn = document.createElement('button'); btn.className='theme-btn'; btn.style.background = t.bg; btn.title = t.name+'+'; const tt=document.createElement('span'); tt.className='theme-tooltip'; tt.textContent=t.name+'+'; btn.appendChild(tt);
      btn.addEventListener('click', ()=>{ Sound.click(); applyTheme(t.bg); });
      row.appendChild(btn);
    }
  }
}
buildThemes();

function applyTheme(bg){
  document.body.style.background = (bg||'').toString();
  // basic glass modifications depending on gradient vs color
  if(String(bg).startsWith('linear-gradient')){ document.documentElement.style.setProperty('--glass-bg','rgba(255,255,255,0.12)'); document.documentElement.style.setProperty('--glass-border','rgba(255,255,255,0.18)'); }
  else{ document.documentElement.style.setProperty('--glass-bg','rgba(255,255,255,0.20)'); document.documentElement.style.setProperty('--glass-border','rgba(255,255,255,0.28)'); }
}

/* Rainbow loop */
let rainbowInterval = null;
function enableRainbowLoop(){
  if(rainbowInterval){ clearInterval(rainbowInterval); rainbowInterval=null; document.body.style.transition='background .6s ease'; return; }
  let t=0;
  rainbowInterval = setInterval(()=>{
    t+=0.01;
    document.body.style.background = `conic-gradient(from ${t}turn, #ff0000,#ff8000,#ffff00,#00ff00,#0000ff,#4b0082,#9400d3)`;
  },80);
}

/* panel toggles */
document.getElementById('themesToggle').onclick = ()=>{ document.getElementById('themesPanel').classList.toggle('open'); Sound.click(); }
document.getElementById('closeThemes').onclick = ()=>{ document.getElementById('themesPanel').classList.remove('open'); Sound.click(); }
document.getElementById('musicToggle').onclick = ()=>{ toggleMiniPlayer(); Sound.click(); }

/* ============================
   Music player (3 files referenced)
   ============================ */
const tracks = [
  {file:'bgm.mp3', title:'Track 1'},
  {file:'bgm2.mp3', title:'Track 2'},
  {file:'bgm3.mp3', title:'Track 3'}
];
const audio = new Audio();
audio.crossOrigin = 'anonymous';
let currentTrackIndex = 0;
const miniPlay = document.getElementById('miniPlay');
const miniTitle = document.getElementById('miniTitle');
const miniSeek = document.getElementById('miniSeek');
const miniCur = document.getElementById('miniCur');
const miniDur = document.getElementById('miniDur');
function loadTrack(i){
  currentTrackIndex = i % tracks.length;
  audio.src = tracks[currentTrackIndex].file;
  miniTitle.textContent = tracks[currentTrackIndex].title;
  audio.load();
  audio.volume = 0.35;
}
loadTrack(0);
miniPlay.onclick = ()=>{ if(audio.paused){ audio.play().catch(()=>{}); miniPlay.textContent='‚è∏'; miniPlay.classList.add('pulse'); } else { audio.pause(); miniPlay.textContent='‚ñ∂Ô∏è'; miniPlay.classList.remove('pulse'); } }
miniSeek.oninput = ()=>{ if(audio.duration) audio.currentTime = (miniSeek.value/100)*audio.duration; }
audio.addEventListener('timeupdate', ()=>{
  if(audio.duration){ miniSeek.value = ((audio.currentTime/audio.duration)*100)||0; miniCur.textContent = formatTime(audio.currentTime); miniDur.textContent = formatTime(audio.duration); }
});
audio.addEventListener('ended', ()=>{ // next random track
  loadTrack((currentTrackIndex+1)%tracks.length); audio.play().catch(()=>{}); });
function toggleMiniPlayer(){ const el=document.getElementById('miniPlayer'); el.style.display = (el.style.display==='none' ? 'flex':'none'); }
function formatTime(t){ if(isNaN(t)) return '0:00'; const m=Math.floor(t/60); const s=Math.floor(t%60).toString().padStart(2,'0'); return `${m}:${s}`; }

/* Attempt autoplay ‚Äî browsers block but first user interaction will start */
document.addEventListener('pointerdown', ()=>{ audio.play().catch(()=>{}); }, {once:true});

/* ============================
   Bubble Pop ‚Äî level based
   ============================ */
const gameCanvas = document.getElementById('gameCanvas');
let gctx, W, H, bubbles=[], score=0, level=1, lastSpawn=0, running=true, prevT=performance.now();
function resizeGame(){
  const rect = gameCanvas.getBoundingClientRect();
  gameCanvas.width = Math.floor(rect.width * devicePixelRatio);
  gameCanvas.height = Math.floor(rect.height * devicePixelRatio);
  gctx = gameCanvas.getContext('2d');
  gctx.setTransform(1,0,0,1,0,0);
  gctx.scale(devicePixelRatio,devicePixelRatio);
}
window.addEventListener('resize', resizeGame);
resizeGame();

function spawnBubble(){
  const r = 18 + Math.random()*34*(1+level/30);
  const x = r + Math.random()*(gameCanvas.clientWidth - r*2);
  const y = gameCanvas.clientHeight + r + 10;
  const vy = (0.5 + Math.random()*1.0) * (parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--motion-scale')) || 0.75) * (1 + level/40);
  const hue = Math.floor(200 + Math.random()*120);
  bubbles.push({x,y,r,vy,alpha:1,hue,popped:false});
}

function updateBubble(b,dt){
  if(!b.popped){
    b.y -= b.vy * dt * 0.06;
    if(b.y < -b.r){ b.popped=true; b.alpha=0; }
  } else b.alpha -= 0.04;
}

function drawBubble(b){
  const ctx = gctx;
  ctx.save();
  ctx.globalAlpha = Math.max(0,b.alpha);
  ctx.shadowColor = `rgba(255,255,255,0.9)`;
  ctx.shadowBlur = 14;
  ctx.lineWidth = 2;
  ctx.strokeStyle = `rgba(0,0,0,0.18)`;
  const cx=b.x, cy=b.y, r=b.r;
  const grad = ctx.createRadialGradient(cx-r*0.3, cy-r*0.3, r*0.15, cx, cy, r);
  grad.addColorStop(0, `hsla(${b.hue},90%,96%,.95)`);
  grad.addColorStop(1, `hsla(${b.hue},70%,60%,.7)`);
  ctx.fillStyle = grad;
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.beginPath(); ctx.arc(cx-r*0.36, cy-r*0.36, r*0.2,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,.6)'; ctx.fill();
  ctx.restore();
}

function gameLoop(t){
  const dt = t - prevT; prevT = t;
  if(running){
    gctx.clearRect(0,0,gameCanvas.clientWidth,gameCanvas.clientHeight);
    // soft background
    const grd = gctx.createLinearGradient(0,0,gameCanvas.clientWidth,gameCanvas.clientHeight);
    grd.addColorStop(0,'rgba(255,255,255,.22)');
    grd.addColorStop(1,'rgba(255,255,255,.12)');
    gctx.fillStyle = grd; gctx.fillRect(0,0,gameCanvas.clientWidth,gameCanvas.clientHeight);
    // spawn slower in low levels, faster later
    const spawnInterval = Math.max(280 - level*6, 140);
    if(t - lastSpawn > spawnInterval){ spawnBubble(); lastSpawn = t; }
    bubbles = bubbles.filter(b=>b.alpha>0);
    for(const b of bubbles){ updateBubble(b,dt); drawBubble(b); }
  }
  requestAnimationFrame(gameLoop);
}
requestAnimationFrame(gameLoop);

gameCanvas.addEventListener('click', (e)=>{
  const rect = gameCanvas.getBoundingClientRect();
  const x = e.clientX - rect.left, y = e.clientY - rect.top;
  for(const b of bubbles){
    const dx = x - b.x, dy = y - b.y;
    if(!b.popped && dx*dx + dy*dy <= b.r*b.r){
      b.popped = true; b.vy = 0; score += Math.round(5 + level*1.25); document.getElementById('scoreTxt').textContent = score; Sound.pop(); checkMilestones(); checkLevelUp(); break;
    }
  }
});

function checkMilestones(){
  const milestones = [25,50,100,200,350,500,750,1000];
  for(const m of milestones){
    if(score >= m && (score - Math.round(5 + level*1.25)) < m){
      showEncouragement(`Nice! You hit ${m} points ‚Äî awesome!`);
    }
  }
}

function checkLevelUp(){
  // simple: every 100 points -> level
  const newLevel = Math.min(1 + Math.floor(score/100), 30);
  if(newLevel > level){
    level = newLevel; document.getElementById('levelTxt').textContent = level;
    showEncouragement(`Level up! Welcome to level ${level} üéâ`);
  }
}

document.getElementById('resetGame').onclick = ()=>{ Sound.click(); bubbles=[]; score=0; level=1; document.getElementById('scoreTxt').textContent=0; document.getElementById('levelTxt').textContent=1; showEncouragement('Game reset ‚Äî start fresh!'); };

function showEncouragement(msg){
  // show as small floating bot message in chat box for continuity
  addMessage(msg,'bot');
}

/* ============================
   Drawing Pad + TF.js recognition
   ============================ */
const drawCanvas = document.getElementById('drawCanvas');
const dctx = drawCanvas.getContext('2d', {willReadFrequently:true});
let drawing=false, brushColor='#1e88e5', brushSize=10, lastX=0, lastY=0, erasing=false;
function sizeDraw(){
  const rect = drawCanvas.getBoundingClientRect();
  const prev = dctx.getImageData(0,0,drawCanvas.width||1, drawCanvas.height||1);
  drawCanvas.width = Math.floor(rect.width * devicePixelRatio);
  drawCanvas.height = Math.floor(rect.height * devicePixelRatio);
  dctx.setTransform(1,0,0,1,0,0); dctx.scale(devicePixelRatio, devicePixelRatio);
  try{ dctx.putImageData(prev,0,0); }catch(e){}
}
new ResizeObserver(sizeDraw).observe(drawCanvas);
setTimeout(sizeDraw,0);

function startDraw(x,y){ drawing=true; lastX=x; lastY=y; Sound.scribble(); }
function moveDraw(x,y){ if(!drawing) return;
  dctx.lineWidth = brushSize; dctx.lineJoin='round'; dctx.lineCap='round';
  if(erasing){ dctx.globalCompositeOperation = 'destination-out'; dctx.strokeStyle='rgba(0,0,0,1)'; }
  else { dctx.globalCompositeOperation = 'source-over'; dctx.strokeStyle = brushColor; }
  dctx.beginPath(); dctx.moveTo(lastX,lastY); dctx.lineTo(x,y); dctx.stroke();
  lastX=x; lastY=y;
}
function endDraw(){ drawing=false; dctx.globalCompositeOperation='source-over'; if(document.getElementById('autoCheck').checked) runAutoCheck(); }

drawCanvas.addEventListener('mousedown', e=>{ const r=drawCanvas.getBoundingClientRect(); startDraw(e.clientX-r.left, e.clientY-r.top); });
drawCanvas.addEventListener('mousemove', e=>{ const r=drawCanvas.getBoundingClientRect(); moveDraw(e.clientX-r.left,e.clientY-r.top); });
window.addEventListener('mouseup', endDraw);
drawCanvas.addEventListener('touchstart', e=>{ const t=e.touches[0]; const r=drawCanvas.getBoundingClientRect(); startDraw(t.clientX-r.left,t.clientY-r.top); e.preventDefault(); },{passive:false});
drawCanvas.addEventListener('touchmove', e=>{ const t=e.touches[0]; const r=drawCanvas.getBoundingClientRect(); moveDraw(t.clientX-r.left,t.clientY-r.top); e.preventDefault(); },{passive:false});
drawCanvas.addEventListener('touchend', endDraw);

/* tools */
document.getElementById('colorPicker').addEventListener('input', e=>{ brushColor = e.target.value; erasing=false; document.getElementById('eraserToggle').checked=false; });
document.getElementById('brushSize').addEventListener('input', e=>{ brushSize = e.target.value; });
document.getElementById('eraserToggle').addEventListener('change', e=>{ erasing = e.target.checked; Sound.toggle(); });
document.getElementById('clearBtn').addEventListener('click', ()=>{ dctx.clearRect(0,0,drawCanvas.width,drawCanvas.height); document.getElementById('recognitionResult').textContent = 'Canvas cleared'; Sound.click(); });

document.getElementById('saveBtn').addEventListener('click', ()=>{
  const url = drawCanvas.toDataURL('image/png'); const a = document.createElement('a'); a.href=url; a.download='drawing.png'; a.click(); Sound.click();
});

/* rotate (visual rotate for fun) */
let drawRotation = 0;
document.getElementById('rotateBtn').addEventListener('click', ()=>{
  drawRotation = (drawRotation + 90) % 360;
  drawCanvas.style.transform = `rotate(${drawRotation}deg)`;
  Sound.click();
});

/* Free-style */
document.getElementById('freeStyleBtn').addEventListener('click', ()=>{
  dctx.clearRect(0,0,drawCanvas.width,drawCanvas.height); document.getElementById('challengeText').textContent = 'Free‚Äëstyle ‚Äî create what you like'; document.getElementById('recognitionResult').textContent = 'Free style mode'; Sound.click();
});

/* Challenge list (100 items) */
const CHALLENGES = [
  "cat","dog","house","tree","car","boat","key","cup","pizza","sun",
  "moon","star","flower","bird","fish","apple","banana","clock","chair","book",
  "hat","shoe","ice cream","ball","butterfly","rocket","cloud","mountain","leaf","houseplant",
  "cake","birdhouse","camera","lamp","umbrella","guitar","piano","glasses","phone","bottle",
  "train","bus","bicycle","heart","diamond","crown","lion","elephant","bear","penguin",
  "turtle","snake","bridge","door","window","windowhouse","sled","socks","scarf","treehouse",
  "lighthouse","castle","sword","shield","robot","alien","spaceship","volcano","skyscraper","island",
  "tent","campfire","map","compass","treasure","magic wand","wizard","princess","dragon","unicorn",
  "kite","rollercoaster","ferris wheel","skateboard","microscope","telescope","globe","notebook","pen","paintbrush",
  "palette","hamburger","fries","donut","cookie","bottle rocket","lantern","magnet","keycard","badge",
  "palm tree","cactus","mushroom","owl","fox","zebra","giraffe","cow","sheep","goat"
];
// shuffle for variety
function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
shuffle(CHALLENGES);

/* Challenge state */
let currentChallenge = null;
let challengeIndex = 0;
const challengeTextEl = document.getElementById('challengeText');
const recognitionResultEl = document.getElementById('recognitionResult');

function loadRandomChallenge(){
  challengeIndex = (challengeIndex + 1) % CHALLENGES.length;
  currentChallenge = CHALLENGES[challengeIndex];
  challengeTextEl.textContent = `Try drawing a ${currentChallenge}`;
  document.getElementById('challengeBox').scrollIntoView({behavior:'smooth',block:'nearest'});
  recognitionResultEl.textContent = 'Ready for your drawing...';
}

/* Buttons: New, OK, No, Later */
document.getElementById('newChallengeBtn').addEventListener('click', ()=>{ loadRandomChallenge(); Sound.click(); });
document.getElementById('okChallengeBtn').addEventListener('click', ()=>{
  Sound.click(); addMessage(`Okay ‚Äî try drawing a ${currentChallenge} üé®`, 'bot'); dctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
});
document.getElementById('noChallengeBtn').addEventListener('click', ()=>{ Sound.click(); loadRandomChallenge(); addMessage('Alright, new challenge incoming!', 'bot'); });
document.getElementById('laterBtn').addEventListener('click', ()=>{ Sound.click(); addMessage('Free‚Äëstyle unlocked ‚Äî draw whatever you like!', 'bot'); document.getElementById('recognitionResult').textContent = 'Free‚Äëstyle mode'; });

/* Auto-check logic uses MobileNet */
let mobilenetModel = null;
let mobilenetReady = false;
async function loadMobileNet(){
  recognitionResultEl.textContent = 'Loading recognition model‚Ä¶';
  try{
    mobilenetModel = await mobilenet.load({version:2,alpha:1.0});
    mobilenetReady = true;
    recognitionResultEl.textContent = 'Recognition ready';
  }catch(e){ recognitionResultEl.textContent = 'Model failed to load ‚Äî check network'; mobilenetReady=false; }
}
loadMobileNet();

async function runAutoCheck(){
  if(!mobilenetReady || !currentChallenge) return;
  // prepare canvas snapshot scaled to 224x224
  const tmp = document.createElement('canvas');
  tmp.width = 224; tmp.height = 224;
  const tctx = tmp.getContext('2d');
  // draw white background then the drawing (to aid model)
  tctx.fillStyle = '#ffffff'; tctx.fillRect(0,0,224,224);
  // draw scaled content
  tctx.drawImage(drawCanvas, 0, 0, 224, 224);
  // use mobilenet to classify
  recognitionResultEl.textContent = 'Analyzing...';
  try{
    const preds = await mobilenetModel.classify(tmp, 5);
    // preds: [{className, probability}, ...]
    if(preds && preds.length){
      const top = preds[0];
      // fuzzy match check: normalize both
      const foundLabel = top.className.toLowerCase();
      const target = currentChallenge.toLowerCase();
      // build synonyms map for likely matches
      const synonyms = {
        "sun":"sun",
        "moon":"moon",
        "dog":"dog",
        "cat":"cat",
        "car":"car",
        "house":"house",
        "pizza":"pizza",
        "tree":"tree",
        "bicycle":"bicycle",
        "boat":"boat",
        "rocket":"rocket",
        "guitar":"guitar",
        "piano":"piano",
        "apple":"apple",
        "banana":"banana",
        "flower":"flower",
        "bird":"bird",
        "fish":"fish",
        "key":"key",
        "cup":"cup",
        "chair":"chair",
        "hat":"hat",
        "shoe":"shoe",
        "clock":"clock",
        "lamp":"lamp",
        "camera":"camera",
        "umbrella":"umbrella",
        "cake":"cake",
        "heart":"heart",
        "diamond":"diamond",
        "lion":"lion",
        "elephant":"elephant",
        "bear":"bear",
        "penguin":"penguin",
        "turtle":"turtle",
        "snake":"snake",
        "bridge":"bridge",
        "door":"door",
        "window":"window",
        "castle":"castle",
        "robot":"robot",
        "dragon":"dragon",
        "unicorn":"unicorn",
        "owl":"owl",
        "fox":"fox",
        "zebra":"zebra",
        "giraffe":"giraffe",
        "cow":"cow",
        "sheep":"sheep",
        "goat":"goat"
      };
      // fuzzy checks: exact substring, synonyms mapping, Levenshtein-ish (simple)
      function fuzzyMatch(a,b){
        if(a.includes(b) || b.includes(a)) return true;
        if(synonyms[b] && a.includes(synonyms[b])) return true;
        // simple char subsequence check
        let i=0;
        for(const ch of a){ if(ch===b[i]) i++; if(i===b.length) return true; }
        return false;
      }
      // assemble labels string
      const labelList = preds.map(p=>p.className.toLowerCase()).join(', ');
      // determine success
      const ok = fuzzyMatch(foundLabel, target) || fuzzyMatch(labelList, target);
      if(ok && top.probability > 0.06){ // threshold very low because sketches are hard
        recognitionResultEl.textContent = `Nice! I see "${top.className}" (${(top.probability*100).toFixed(0)}%). Great job! üéâ`;
        addMessage(`Wow! That looks great ‚Äî your ${currentChallenge} is recognizable!`, 'bot');
      } else {
        recognitionResultEl.textContent = `Hmm ‚Äî I saw "${preds[0].className}" and "${preds[1] ? preds[1].className : ''}". Wanna try again or pick a new challenge?`;
        addMessage(`So nice! Do you want to try again or try another?`, 'bot');
      }
    } else recognitionResultEl.textContent = 'No confident match ‚Äî try again or free‚Äëstyle.';
  }catch(e){
    recognitionResultEl.textContent = 'Recognition error ‚Äî try again later.';
  }
}

/* Public runAutoCheck trigger */
async function runAutoCheckPublic(){ if(document.getElementById('autoCheck').checked) await runAutoCheck(); }

/* Expose runAutoCheck on demand (e.g., after a big stroke) */
window.runAutoCheck = runAutoCheck;

/* ============================
   Chatbot ‚Äî Aura (improved)
   ============================ */
const chatBox = document.getElementById('chat-box');
const userInput = document.getElementById('user-input');
const sendBtn = document.getElementById('send-btn');
const moodButtons = document.querySelectorAll('.mood-btn');

function addMessage(text, sender='bot'){
  const d = document.createElement('div'); d.className='message '+sender+' fadein'; d.textContent = text;
  chatBox.appendChild(d); chatBox.scrollTop = chatBox.scrollHeight;
}

/* seed conversation examples ‚Äî 10 lines for sad/nervous */
const sadConversation = [
  "Hi, I'm here with you. Tell me one small thing that happened today.",
  "I hear you ‚Äî that sounds heavy. Do you want a small comfort idea?",
  "Maybe wrap up in a blanket or play a soft song for 2 minutes.",
  "You're doing well just by sharing that. Would a breathing exercise help?",
  "Let's try: breathe in 4s, hold 4s, out 6s ‚Äî three times with me.",
  "How did that feel? Even a little better?",
  "If you want, we can doodle something calming together.",
  "You're not alone ‚Äî small steps are still steps. I'm proud of you.",
  "Would you like a short distraction ‚Äî a simple game or a drawing challenge?",
  "Whenever you're ready, I'm here."
];

const nervousConversation = [
  "Hey ‚Äî I notice tension in your voice. Want to name that worry?",
  "Naming it can make it feel smaller. What's one word to describe it?",
  "Okay. That's a lot. Want to do a grounding exercise?",
  "Look around: name 5 things you can see, 4 things you can touch...",
  "Now breathe with me for 30 seconds. Slow and easy.",
  "Good. Sometimes the body needs a moment to reset.",
  "Would music help or a small game to shift focus?",
  "We can try a drawing prompt that's simple and fun.",
  "You did something brave just by checking in ‚Äî well done.",
  "I'm right here, whenever you need."
];

function initChatExample(){
  addMessage("Hi! üëã How was your day? üòä", 'bot');
}

sendBtn.addEventListener('click', ()=>{
  const txt = userInput.value.trim();
  if(!txt) return;
  addMessage(txt,'user'); userInput.value='';
  Sound.click();
  processChat(txt);
});

/* quick fuzzy intent helpers */
function norm(s){ return (s||'').toLowerCase().replace(/[^a-z0-9\s]/g,'').trim(); }
function containsAny(s, arr){ const n=norm(s); return arr.some(a=>n.includes(a)); }

function processChat(text){
  const n = norm(text);
  if(containsAny(n, ['draw','doodle','sketch','paint'])){ addMessage("Want a challenge or free‚Äëstyle? Click Doodle above.", 'bot'); return; }
  if(containsAny(n, ['game','play','bubble','pop'])){ addMessage("Ready for Bubble Pop ‚Äî calming levels await. Tap Play.", 'bot'); return; }
  if(containsAny(n, ['music','song','listen'])){ addMessage("I can play some background music. Use the music player to start.", 'bot'); return; }
  // gratitude / thanks
  if(containsAny(n, ['thank','thanks','thx'])){ addMessage("Always here ‚Äî glad to help üíô", 'bot'); return; }
  // mood detection
  if(containsAny(n, ['sad','down','depressed','unhappy'])){ sadConversation.forEach((line, i)=> setTimeout(()=>addMessage(line,'bot'), 400*(i+1))); return; }
  if(containsAny(n, ['anxious','nervous','scared','afraid','worried'])){ nervousConversation.forEach((line,i)=> setTimeout(()=>addMessage(line,'bot'), 400*(i+1))); return; }
  // fallback: empathetic reflection + activity suggestions
  addMessage("Thanks for telling me. I'm listening. Would you like a small activity ‚Äî breathe, doodle, or play a calm game?", 'bot');
}

/* mood buttons direct flows */
moodButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const mood = btn.getAttribute('data-mood');
    if(mood==='happy'){ addMessage("That's wonderful ‚Äî tell me more about what made you smile today!",'bot'); }
    else if(mood==='sad'){ sadConversation.forEach((line,i)=> setTimeout(()=>addMessage(line,'bot'),400*(i+1))); }
    else if(mood==='nervous'){ nervousConversation.forEach((line,i)=> setTimeout(()=>addMessage(line,'bot'),400*(i+1))); }
    else if(mood==='angry'){ addMessage("I hear you. Want a 60s outlet ‚Äî deep breaths or a physical release like punching a pillow safely?", 'bot'); }
    Sound.click();
  });
});

/* activity chips */
document.querySelectorAll('.chip').forEach(c=>{
  c.addEventListener('click', ()=>{
    const a = c.dataset.activity;
    if(a==='breathe'){ addMessage("Let's breathe: In 4s ‚Äî Hold 4s ‚Äî Out 6s ‚Äî 3√ó", 'bot'); }
    if(a==='doodle'){ addMessage("Opening drawing pad with a fresh challenge.", 'bot'); switchScreen('draw'); loadRandomChallenge(); }
    if(a==='game'){ addMessage("Launching Bubble Pop ‚Äî calming levels.", 'bot'); switchScreen('game'); startGameFlow(); }
    if(a==='music'){ addMessage("Opening music player. Click play to begin.", 'bot'); toggleMiniPlayer(); }
    Sound.click();
  });
});

/* init */
initChatExample();

/* ============================
   Flow helpers for Game/Draw
   ============================ */
function startGameFlow(){ // small optional card prompt for game
  addMessage("Want a guided calm session? Pop slowly and breathe. Good luck!", 'bot');
}

/* ============================
   UI polish: ensure draw challenge loaded initially
   ============================ */
loadRandomChallenge();

/* ============================
   Small helpers: keyboard shortcuts
   ============================ */
document.addEventListener('keydown',(e)=>{
  if(e.key==='Escape'){ document.getElementById('themesPanel').classList.remove('open'); }
  if(e.key==='g'){ switchScreen('game'); }
  if(e.key==='d'){ switchScreen('draw'); }
  if(e.key==='c'){ switchScreen('chat'); }
});

/* ============================
   Expose some debug utilities
   ============================ */
window.DEBUG = { CHALLENGES, THEMES, runAutoCheckPublic };

/* ============================
   End of file
   ============================ */
</script>
</body>
</html>
