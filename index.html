<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aura AI — All in One</title>
<style>
/* (Style kept compact to preserve your look) */
:root{
  --bot-bg:#d6e6fb; --bot-fg:#074279;
  --user-bg:#517fc4; --user-fg:#e8f3fc;
  --glass-bg: rgba(255,255,255,0.20);
  --glass-border: rgba(255,255,255,0.28);
  --glass-shadow: 0 18px 40px rgba(0,0,0,0.22);
  --glass-blur: blur(18px);
  --pad:20px; --radius:18px; --motion-scale:0.75;
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0;font-family:"Comic Neue",Arial,sans-serif;color:#0b3c61;
  background:#a8cdf1;min-height:100vh;display:flex;align-items:center;justify-content:center;overflow:hidden;
}
/* screens */
.screen{position:absolute;inset:0;display:none;place-items:center;padding:var(--pad)}
.screen.active{display:grid}
.glass{background:var(--glass-bg);backdrop-filter:var(--glass-blur);-webkit-backdrop-filter:var(--glass-blur);border:1px solid var(--glass-border);box-shadow:var(--glass-shadow)}
.btn{border:0;cursor:pointer;border-radius:14px;padding:14px 18px;font-weight:800;font-size:16px;color:#0b3c61;background:linear-gradient(90deg,#a8cdf1 0%,#f7b7b9 100%);box-shadow:0 4px 8px rgba(168,205,241,.7);transition:filter .18s,transform .18s}
.btn:hover{filter:brightness(.92);transform:translateY(-1px)}

/* Hello */
.hello-wrap{width:min(980px,92vw);border-radius:var(--radius);padding:28px;text-align:center}
.hello-text{font-weight:900;line-height:1;user-select:none;margin:14px 0 8px;font-size:clamp(42px,8vw,92px);letter-spacing:1px;background:linear-gradient(90deg,#ffffff,#f7b7b9,#a8cdf1,#ffffff);-webkit-background-clip:text;background-clip:text;color:transparent;animation:hueflow 12s linear infinite;filter:saturate(.9)}
@keyframes hueflow{0%{filter:hue-rotate(0deg)}100%{filter:hue-rotate(360deg)}}
.hello-sub{font-size:clamp(16px,2.6vw,22px);opacity:.9;margin-bottom:18px}
.hello-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
.hint{margin-top:14px;font-size:14px;opacity:.8}

/* Game */
.game-wrap{width:min(1000px,95vw);height:min(70vh,680px);border-radius:var(--radius);padding:12px;display:grid;grid-template-rows:auto 1fr;gap:10px}
.bar{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
.left-group,.right-group{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.title{font-weight:900;font-size:20px}
.game-ind{font-weight:800;padding:8px 12px;border-radius:12px;background:rgba(255,255,255,.55)}
#gameCanvas{width:100%;height:100%;border-radius:14px;background:linear-gradient(135deg,#eaf6ff,#f6f0ff);display:block;outline:2px solid rgba(255,255,255,.5)}

/* Draw */
.draw-wrap{width:min(1100px,96vw);height:min(76vh,740px);border-radius:var(--radius);padding:12px;display:grid;grid-template-rows:auto 1fr auto;gap:10px}
.brush{display:flex;align-items:center;gap:8px;font-weight:800;background:rgba(255,255,255,.55);padding:6px 10px;border-radius:12px}
.swatch{width:26px;height:26px;border-radius:50%;border:0;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.2)}
.picker{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.55);padding:6px 10px;border-radius:12px;font-weight:800}
.draw-canvas{width:100%;height:100%;border-radius:14px;background:rgba(255,255,255,.65);outline:2px solid rgba(255,255,255,.5)}
.draw-bottom{display:flex;gap:8px;justify-content:space-between;flex-wrap:wrap}

/* Chat */
.chat-container{width:min(980px,92vw);border-radius:var(--radius);padding:18px;display:flex;flex-direction:column;gap:12px}
.header-controls{display:flex;gap:10px;align-items:center}
.mood-header{flex:1;text-align:center;font-weight:900;font-size:22px;padding:12px 16px;border-radius:14px;background:linear-gradient(90deg,#a8cdf1 0%,#f7b7b9 100%);box-shadow:0 4px 8px rgba(168,205,241,.4)}
.header-buttons{display:flex;gap:8px;flex-wrap:wrap}
.mood-selector{display:flex;gap:10px;flex-wrap:wrap}
.mood-btn{border:0;flex:1;cursor:pointer;padding:12px 14px;border-radius:14px;font-weight:800;font-size:16px;transition:transform .18s,box-shadow .18s}
.mood-btn.happy{background:#c1e6a6} .mood-btn.sad{background:#a4c7f9} .mood-btn.angry{background:#f9d6d6} .mood-btn.nervous{background:#fff3c8}
#moodHint{opacity:.85;font-size:14px}
#chat-box{flex:1;min-height:280px;max-height:52vh;overflow-y:auto;padding:14px;border-radius:14px;background:rgba(232,242,252,.55)}
.message{margin:10px 0;padding:12px 14px;border-radius:14px;max-width:75%;border:2px solid transparent;font-size:18px}
.message.bot{background:rgba(0,0,0,0.35);color:#f0f0f0;border:1px solid rgba(255,255,255,0.25);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
.message.user{background:rgba(0,0,0,0.55);color:#fff;align-self:flex-end;text-align:right;border:1px solid rgba(255,255,255,0.25)}
.input-footer{position:relative;display:none}
#user-input{width:100%;padding:16px 120px 16px 14px;border-radius:12px;border:1px solid #a9c8e8;background:rgba(255,255,255,.72);font-size:18px;color:#0b3c61;outline:none}
#send-btn{position:absolute;right:6px;top:6px;bottom:6px;width:108px;color:#fff;background:#88b7e5}

/* Themes */
.themes-panel{position:fixed;top:0;right:0;height:100%;width:0;opacity:0;pointer-events:none;z-index:1000;transition:width .28s,opacity .2s;display:flex;flex-direction:column}
.themes-panel.open{width:320px;opacity:1;pointer-events:auto}
.panel-shell{height:100%;display:flex;flex-direction:column}
.themes-head{display:flex;align-items:center;justify-content:space-between;padding:12px;font-weight:900}
.themes-body{padding:12px;overflow-y:auto;flex:1}
.swatch-strip{display:flex;flex-direction:column;gap:12px}
.group-title{font-weight:900;font-size:14px;opacity:.85;padding-left:4px}
.swatch-row{display:flex;gap:10px;flex-wrap:wrap}
.theme-btn{width:34px;height:34px;border-radius:50%;border:0;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.18);transition:transform .12s}
.theme-btn:hover{transform:scale(1.08)}

.miniplayer{position:fixed;right:14px;bottom:14px;z-index:1200;display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:14px}
.mini-btn{border:0;cursor:pointer;border-radius:12px;padding:10px 12px;font-weight:800;font-size:14px;background:rgba(255,255,255,.6);box-shadow:0 4px 8px rgba(0,0,0,.15)}
.mini-meta{display:flex;flex-direction:column;gap:4px;min-width:170px;max-width:240px}
.mini-progress{appearance:none;width:100%;height:6px;border-radius:6px;background:rgba(255,255,255,.6);outline:none;cursor:pointer}

/* Flow overlay (challenge UI) */
.flow-pad{position:absolute;left:16px;bottom:16px;z-index:900;display:flex;flex-direction:column;gap:8px;max-width:min(560px,80vw);padding:10px 12px;border-radius:14px}
.flow-q{font-weight:900;font-size:16px}
.flow-actions{display:flex;gap:8px;flex-wrap:wrap}
.chip{border:0;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:800;background:rgba(255,255,255,.65)}
.chip:hover{filter:brightness(.95)}

@media(max-width:880px){
  .mood-selector{flex-wrap:wrap}
  .header-controls{flex-wrap:wrap}
  .miniplayer{right:10px;left:10px;bottom:10px}
}
</style>
</head>
<body>

<!-- HELLO -->
<section id="hello-screen" class="screen active">
  <div class="hello-wrap glass">
    <div class="hello-text">AuraAI</div>
    <div class="hello-sub">Hi 👋 I’m your support buddy. What would you like to do today?</div>
    <div class="hello-actions">
      <button class="btn" id="goPlay">🎮 Play a Game</button>
      <button class="btn" id="goDraw">🎨 Draw Something</button>
      <button class="btn" id="goTalk">💬 Talk</button>
    </div>
    <div class="hint">You can always go back here from any screen.</div>
  </div>
  <div style="position:fixed;right:18px;bottom:18px;display:flex;gap:10px">
    <button class="btn" id="openThemesGlobal">🎨 Themes</button>
    <button class="btn" id="toggleMusicGlobal">🎶 Music</button>
  </div>
</section>

<!-- GAME -->
<section id="game-screen" class="screen">
  <div class="game-wrap glass">
    <div class="bar">
      <div class="left-group"><div class="title">🫧 Bubble Pop — calm your mind</div></div>
      <div class="right-group">
        <span class="game-ind">Score: <span id="scoreTxt">0</span></span>
        <button class="btn" id="resetGame">Reset</button>
        <button class="btn" id="themeBtnGame">🎨 Themes</button>
        <button class="btn" id="muteBtnGame">🔇 Mute</button>
        <button class="btn" id="backFromGame">⬅ Back</button>
      </div>
    </div>
    <canvas id="gameCanvas" aria-label="Bubble Pop Canvas"></canvas>

    <div id="flowGame" class="flow-pad glass" style="display:none">
      <div class="flow-q" id="flowGameQ"></div>
      <div class="flow-actions">
        <button class="chip" id="flowGameOK">OK</button>
        <button class="chip" id="flowGameNo">No</button>
        <button class="chip" id="flowGameLater">Later</button>
        <button class="chip" id="flowGameClose">Close</button>
      </div>
    </div>
  </div>
</section>

<!-- DRAW -->
<section id="draw-screen" class="screen">
  <div class="draw-wrap glass">
    <div class="bar">
      <div class="left-group">
        <div class="title">🎨 Doodle — express or doodle</div>
        <div class="brush">Brush <input id="brushSize" type="range" min="2" max="50" value="10" /></div>
        <button class="swatch" style="background:#000" data-color="#000" title="Black"></button>
        <button class="swatch" style="background:#fff" data-color="#fff" title="White"></button>
        <label class="toggle"><input id="eraserToggle" type="checkbox" /> Eraser</label>
        <div class="picker">Color <input id="colorPicker" type="color" value="#1e88e5" /></div>
      </div>
      <div class="right-group">
        <button class="btn" id="themeBtnDraw">🎨 Themes</button>
        <button class="btn" id="muteBtnDraw">🔇 Mute</button>
        <button class="btn" id="backFromDraw">⬅ Back</button>
      </div>
    </div>

    <canvas id="drawCanvas" class="draw-canvas" aria-label="Drawing Canvas"></canvas>

    <div class="draw-bottom">
      <div class="left">
        <button class="btn" id="clearDraw">Clear</button>
        <button class="btn" id="saveDraw">Save</button>
        <button class="btn" id="newChallengeBtn">🔄 New</button>
        <button class="btn" id="autoCheckToggle" aria-pressed="true">✅ Auto‑Check</button>
      </div>
      <div class="right"><div id="drawStatus" style="opacity:.9"></div></div>
    </div>

    <div id="flowDraw" class="flow-pad glass" style="display:flex">
      <div class="flow-q" id="challengeText">Try drawing a <strong id="challengeWord">cat</strong>. (OK / No / Later)</div>
      <div class="flow-actions">
        <button class="chip" id="challengeOK">OK</button>
        <button class="chip" id="challengeNo">No</button>
        <button class="chip" id="challengeLater">Later</button>
        <button class="chip" id="challengeClose">Close</button>
      </div>
    </div>
  </div>
</section>

<!-- CHAT -->
<section id="chat-screen" class="screen">
  <div class="chat-container glass">
    <div class="header-controls">
      <div class="mood-header glass">How do you feel?</div>
      <div class="header-buttons">
        <button class="btn" id="voice-mode-btn">🎤 Voice</button>
        <button class="btn" id="speak-reply-btn">🔊 Speak</button>
        <button class="btn" id="themeBtnChat">🎨 Themes</button>
        <button class="btn" id="muteBtnChat">🔇 Mute</button>
        <button class="btn" id="backFromChat">⬅ Back</button>
      </div>
    </div>

    <div class="mood-selector">
      <button class="mood-btn happy">😊 Happy</button>
      <button class="mood-btn sad">😢 Sad</button>
      <button class="mood-btn angry">😠 Angry</button>
      <button class="mood-btn nervous">😰 Nervous</button>
    </div>

    <div id="chat-box" class="glass" role="log" aria-live="polite"></div>

    <div class="input-footer">
      <input id="user-input" type="text" placeholder="Type your response..." autocomplete="off" />
      <button class="btn" id="send-btn">Send</button>
    </div>

    <div id="flowChat" class="flow-pad glass" style="display:none">
      <div class="flow-q" id="flowChatQ"></div>
      <div class="flow-actions">
        <button class="chip" id="flowChatYes">Yes</button>
        <button class="chip" id="flowChatNo">No</button>
        <button class="chip" id="flowChatClose">Close</button>
      </div>
    </div>
  </div>
</section>

<!-- THEMES PANEL -->
<aside id="themesPanel" class="themes-panel" aria-hidden="true">
  <div class="panel-shell glass">
    <div class="themes-head glass">
      <div>🎨 Themes</div>
      <button class="close-btn btn" id="closeThemes">✕</button>
    </div>
    <div class="themes-body">
      <div class="swatch-strip" id="themeStrip"></div>
    </div>
  </div>
</aside>

<!-- MINI MUSIC PLAYER -->
<div id="miniPlayer" class="miniplayer glass" role="region" aria-label="Background Music Player">
  <button id="miniPlayPause" class="mini-btn">⏸</button>
  <div class="mini-meta">
    <div class="mini-title" id="miniTitle">BGM</div>
    <input id="miniSeek" class="mini-progress" type="range" min="0" max="100" value="0" />
    <div class="mini-time"><span id="miniCur">0:00</span> / <span id="miniDur">0:00</span></div>
  </div>
</div>

<!-- Audio elements (sources must be in repo) -->
<audio id="bgm1" src="bgm.mp3" crossorigin="anonymous"></audio>
<audio id="bgm2" src="bgm2.mp3" crossorigin="anonymous"></audio>
<audio id="bgm3" src="bgm3.mp3" crossorigin="anonymous"></audio>

<!-- TensorFlow & MobileNet CDN (for auto-check) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.2.2/dist/mobilenet.min.js"></script>

<script>
/* ---------------------- Utilities & sound ---------------------- */
const Sound = (() => {
  let ctx, muted=false;
  function ensure(){ if(!ctx){ const AC = window.AudioContext || window.webkitAudioContext; if(AC) ctx = new AC(); } }
  function tone(f=440,d=0.06,t='sine',g=0.06){ if(muted) return; ensure(); if(!ctx) return; const o=ctx.createOscillator(), gg=ctx.createGain(); o.type=t; o.frequency.value=f; gg.gain.value=g; o.connect(gg).connect(ctx.destination); o.start(); o.stop(ctx.currentTime + d); }
  return { click:()=>tone(600,0.04,'triangle',0.04), pop:()=>tone(900,0.07,'sine',0.07), scribble:()=>tone(280,0.03,'square',0.03), toggle:()=>tone(420,0.05,'sawtooth',0.05), setMuted:(v)=>muted=v, isMuted:()=>muted };
})();

/* ---------------------- Screen router ---------------------- */
const screens = { hello:document.getElementById('hello-screen'), game:document.getElementById('game-screen'), draw:document.getElementById('draw-screen'), chat:document.getElementById('chat-screen') };
function switchScreen(k){ Object.values(screens).forEach(s=>s.classList.remove('active')); screens[k].classList.add('active'); }

/* Start/back */
document.getElementById('goPlay').onclick = ()=>{ Sound.click(); switchScreen('game'); };
document.getElementById('goDraw').onclick = ()=>{ Sound.click(); switchScreen('draw'); };
document.getElementById('goTalk').onclick = ()=>{ Sound.click(); switchScreen('chat'); };
document.getElementById('backFromGame').onclick = ()=>{ Sound.click(); switchScreen('hello'); };
document.getElementById('backFromDraw').onclick = ()=>{ Sound.click(); switchScreen('hello'); };
document.getElementById('backFromChat').onclick = ()=>{ Sound.click(); switchScreen('hello'); };

/* ---------------------- Themes (50+ + rainbow loop) ---------------------- */
const themeStrip = document.getElementById('themeStrip');
const THEMES = [
  {name:"Classic", bg:"linear-gradient(90deg,#a8cdf1,#f7b7b9)", bot:["#d6e6fb","#074279"], user:["#517fc4","#e8f3fc"]},
  {name:"Poster Black", bg:"#000000", bot:["#2b2b2b","#ffffff"], user:["#0a0a0a","#ffffff"]},
  {name:"Deep Charcoal", bg:"#2C3E50", bot:["#3e5368","#ffffff"], user:["#1c2a36","#ffffff"]},
  {name:"Sky Blue", bg:"#87CEEB", bot:["#eef9ff","#08345a"], user:["#6dbfe1","#08345a"]},
  {name:"Ocean", bg:"#2980B9", bot:["#c8e3f8","#082b45"], user:["#1f6592","#ffffff"]},
  {name:"Sunset Orange", bg:"linear-gradient(135deg,#FF8008,#FFC837)", bot:["#ffe3a6","#4a3a00"], user:["#f39b10","#2a1e00"]},
  {name:"Aurora", bg:"linear-gradient(135deg,#00d2ff,#3a7bd5)", bot:["#e6f8ff","#0a2a4a"], user:["#4aa0ef","#0a2a4a"]},
  {name:"Berry", bg:"linear-gradient(135deg,#833ab4,#fd1d1d,#fcb045)", bot:["#f7dfff","#26123a"], user:["#f36f52","#ffffff"]},
  {name:"Cotton Candy", bg:"linear-gradient(135deg,#ffb6c1,#add8e6)", bot:["#ffe6f0","#552a4e"], user:["#b0e0e6","#552a4e"]},
  {name:"Galaxy", bg:"linear-gradient(135deg,#0f0c29,#302b63,#24243e)", bot:["#2e2e4a","#ffffff"], user:["#5a5a7f","#ffffff"]},
  {name:"Mint Pastel", bg:"#C2F5E9", bot:["#eafffa","#0f2a20"], user:["#9edfcf","#0f2a20"]},
  {name:"Neon Cyan", bg:"#00F5FF", bot:["#d4fdff","#002a2e"], user:["#00c8d0","#00181b"]},
  {name:"Earth Clay", bg:"#B5651D", bot:["#e7c39d","#2a1807"], user:["#8e4a12","#ffffff"]},
  // add more programmatically to exceed 50
];
/* programmatically add shades to reach many themes */
for(let i=0;i<40;i++){
  const h = (i*17)%360;
  THEMES.push({name:`Shade ${i+1}`, bg:`linear-gradient(135deg,hsl(${h} 70% 70%), hsl(${(h+40)%360} 70% 60%))`, bot:["#ffffff","#08345a"], user:["#517fc4","#e8f3fc"]});
}
/* special rainbow loop theme (cycles) */
THEMES.unshift({name:"Rainbow Loop", bg:"linear-gradient(90deg,#ff0000,#ff8000,#ffff00,#00a000,#0000ff,#4b0082,#9400d3)", bot:["#ffffff","#000000"], user:["#000000","#ffffff"], rainbow:true});

function isDarkBackground(bg){
  if(!bg) return false;
  if(bg.startsWith("linear-gradient")) return true;
  if(bg[0]==='#' && bg.length===7){ const r=parseInt(bg.slice(1,3),16), g=parseInt(bg.slice(3,5),16), b=parseInt(bg.slice(5,7),16); const L=0.2126*r+0.7152*g+0.0722*b; return L<128; }
  return false;
}
function applyTheme(t){
  document.body.style.background = t.bg;
  document.documentElement.style.setProperty('--bot-bg', t.bot[0]);
  document.documentElement.style.setProperty('--bot-fg', t.bot[1]);
  document.documentElement.style.setProperty('--user-bg', t.user[0]);
  document.documentElement.style.setProperty('--user-fg', t.user[1]);
  const dark = isDarkBackground(t.bg);
  document.documentElement.style.setProperty('--glass-bg', dark ? "rgba(255,255,255,0.12)" : "rgba(255,255,255,0.20)");
  document.documentElement.style.setProperty('--glass-border', dark ? "rgba(255,255,255,0.22)" : "rgba(255,255,255,0.28)");
  document.documentElement.style.setProperty('--glass-shadow', dark ? "0 18px 44px rgba(0,0,0,0.35)" : "0 18px 40px rgba(0,0,0,0.22)");
  if(t.rainbow){
    // gently animate background hue rotate
    document.body.animate([{filter:'hue-rotate(0deg)'},{filter:'hue-rotate(360deg)'}],{duration:20000,iterations:Infinity});
  } else {
    document.body.getAnimations().forEach(a=>a.cancel());
  }
}

/* build swatches */
function buildSwatches(){
  themeStrip.innerHTML='';
  THEMES.forEach(t=>{
    const btn=document.createElement('button');
    btn.className='theme-btn';
    btn.title=t.name;
    btn.style.background = t.bg;
    btn.addEventListener('click', ()=>{ Sound.toggle(); applyTheme(t); localStorage.setItem('aura-theme', t.name); });
    // tooltip via title already
    themeStrip.appendChild(btn);
  });
}
buildSwatches();
document.getElementById('closeThemes').onclick = ()=>{ Sound.click(); document.getElementById('themesPanel').classList.remove('open'); };
document.getElementById('openThemesGlobal').onclick = ()=>{ Sound.click(); document.getElementById('themesPanel').classList.add('open'); };
document.querySelectorAll('#themeBtnGame,#themeBtnDraw,#themeBtnChat').forEach(b=>b.addEventListener('click', ()=>{ Sound.click(); document.getElementById('themesPanel').classList.add('open'); }));

/* apply saved theme */
(function(){
  const saved = localStorage.getItem('aura-theme');
  if(saved){
    const t = THEMES.find(x=>x.name===saved);
    if(t) applyTheme(t);
  }
})();

/* ---------------------- Music player (mini) ---------------------- */
const tracks = [document.getElementById('bgm1'), document.getElementById('bgm2'), document.getElementById('bgm3')];
let currentTrack = 0;
const mini = { btn:document.getElementById('miniPlayPause'), seek:document.getElementById('miniSeek'), cur:document.getElementById('miniCur'), dur:document.getElementById('miniDur'), title:document.getElementById('miniTitle') };
function fmt(t){ if(isNaN(t)) return '0:00'; const m=Math.floor(t/60), s=Math.floor(t%60).toString().padStart(2,'0'); return `${m}:${s}`; }
function setTrack(i){
  tracks.forEach((tr,idx)=>{ if(idx===i) tr.volume=0.45; else { tr.pause(); tr.currentTime=0 }});
  currentTrack = i;
  mini.title.textContent = `BGM ${i+1}`;
  tracks[i].addEventListener('timeupdate', ()=>{ if(tracks[i].duration){ mini.seek.value = (tracks[i].currentTime / tracks[i].duration) * 100; mini.cur.textContent = fmt(tracks[i].currentTime); mini.dur.textContent = fmt(tracks[i].duration);} });
}
setTrack(0);
mini.btn.onclick = ()=>{ const tr = tracks[currentTrack]; if(tr.paused){ tr.play(); mini.btn.textContent='⏸'; } else { tr.pause(); mini.btn.textContent='▶️'; } };
document.getElementById('toggleMusicGlobal').onclick = ()=>{ Sound.click(); const tr=tracks[currentTrack]; if(tr.paused){ tr.play(); mini.btn.textContent='⏸'; } else { tr.pause(); mini.btn.textContent='▶️'; } };

/* allow clicking any mini progress to seek */
mini.seek.addEventListener('input', ()=>{ const tr = tracks[currentTrack]; if(tr.duration) tr.currentTime = (mini.seek.value/100)*tr.duration; });

/* ---------------------- Mute buttons ---------------------- */
function bindMute(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.onclick = ()=>{ Sound.toggle(); };
}
bindMute('muteBtnGame'); bindMute('muteBtnDraw'); bindMute('muteBtnChat');

/* ---------------------- Bubble pop (level-ish) ---------------------- */
const gameCanvas = document.getElementById('gameCanvas'); const gctx = gameCanvas.getContext('2d');
let bubbles=[],score=0,lastSpawn=0,prevT=performance.now(),running=true,level=1;
function resizeGame(){ const r=gameCanvas.getBoundingClientRect(); gameCanvas.width=Math.floor(r.width*devicePixelRatio); gameCanvas.height=Math.floor(r.height*devicePixelRatio); gctx.setTransform(1,0,0,1,0,0); gctx.scale(devicePixelRatio,devicePixelRatio); }
window.addEventListener('resize', resizeGame); resizeGame();
function spawnBubble(){ const r=12 + Math.random()*36; const x=r+Math.random()*(gameCanvas.clientWidth - r*2); const y=gameCanvas.clientHeight + r +10; const vy=(0.4+Math.random()*1.2) * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--motion-scale')); const hue=Math.floor(200+Math.random()*100); bubbles.push({x,y,r,vy,alpha:1,hue,popped:false}); }
function updateBubble(b,dt){ if(!b.popped){ b.y -= b.vy * dt * 0.06 * (1 + (level-1)*0.03); if(b.y < -b.r){ b.popped=true; b.alpha=0;} } else b.alpha -= 0.04; }
function drawBubble(b){ gctx.save(); gctx.globalAlpha=Math.max(0,b.alpha); gctx.shadowColor='rgba(255,255,255,0.9)'; gctx.shadowBlur=12; gctx.lineWidth=2; gctx.strokeStyle='rgba(0,0,0,0.25)'; const cx=b.x,cy=b.y,r=b.r; const grad=gctx.createRadialGradient(cx-r*0.3,cy-r*0.3,r*0.2,cx,cy,r); grad.addColorStop(0,`hsla(${b.hue},90%,96%,.95)`); grad.addColorStop(1,`hsla(${b.hue},70%,65%,.65)`); gctx.fillStyle=grad; gctx.beginPath(); gctx.arc(cx,cy,r,0,Math.PI*2); gctx.fill(); gctx.stroke(); gctx.beginPath(); gctx.arc(cx-r*0.38,cy-r*0.38,r*0.22,0,Math.PI*2); gctx.fillStyle='rgba(255,255,255,.6)'; gctx.fill(); gctx.restore(); }
function gameLoop(t){ const dt = t - prevT; prevT=t; if(running){ gctx.clearRect(0,0,gameCanvas.clientWidth,gameCanvas.clientHeight); const grd=gctx.createLinearGradient(0,0,gameCanvas.clientWidth,gameCanvas.clientHeight); grd.addColorStop(0,'rgba(255,255,255,.28)'); grd.addColorStop(1,'rgba(255,255,255,.18)'); gctx.fillStyle=grd; gctx.fillRect(0,0,gameCanvas.clientWidth,gameCanvas.clientHeight); if(t-lastSpawn > Math.max(220,900 - level*10)){ spawnBubble(); lastSpawn = t; } bubbles = bubbles.filter(b=>b.alpha>0); for(const b of bubbles){ updateBubble(b,dt); drawBubble(b); } } requestAnimationFrame(gameLoop); }
requestAnimationFrame(gameLoop);

gameCanvas.addEventListener('click',(e)=>{ const rect=gameCanvas.getBoundingClientRect(); const x=e.clientX-rect.left, y=e.clientY-rect.top; for(const b of bubbles){ const dx=x-b.x, dy=y-b.y; if(!b.popped && dx*dx+dy*dy <= b.r*b.r){ b.popped=true; b.vy=0; score+=1; document.getElementById('scoreTxt').textContent = score; Sound.pop(); checkMilestones(); level = Math.min(30,1 + Math.floor(score/10)); break; } } });
document.getElementById('resetGame').onclick = ()=>{ Sound.click(); bubbles=[]; score=0; level=1; document.getElementById('scoreTxt').textContent=0; };

function checkMilestones(){
  const milestones = [5,10,25,50,75,100,150,250,500,1000];
  for(const m of milestones){
    if(score === m){
      addBubbleHint(`Nice — ${m} popped! You're doing great 🎉`);
    }
  }
}
function addBubbleHint(text){
  addMessage(text,'bot'); // reuse chat message style in chat-box (separate)
}

/* ---------------------- Drawing canvas ---------------------- */
const drawCanvas = document.getElementById('drawCanvas'); const dctx = drawCanvas.getContext('2d',{willReadFrequently:true});
let drawing=false, brushColor='#1e88e5', brushSize=10, lastX=0,lastY=0,erasing=false;
function sizeDrawCanvas(){
  const rect = drawCanvas.getBoundingClientRect();
  const prev = (()=>{try{return dctx.getImageData(0,0,drawCanvas.width||1,drawCanvas.height||1);}catch(e){return null;}})();
  drawCanvas.width = Math.floor(rect.width * devicePixelRatio);
  drawCanvas.height = Math.floor(rect.height * devicePixelRatio);
  dctx.setTransform(1,0,0,1,0,0); dctx.scale(devicePixelRatio,devicePixelRatio);
  if(prev) try{ dctx.putImageData(prev,0,0); }catch(e){}
}
new ResizeObserver(sizeDrawCanvas).observe(drawCanvas); setTimeout(sizeDrawCanvas,0);
function startDraw(x,y){ drawing=true; lastX=x; lastY=y; Sound.scribble(); }
function moveDraw(x,y){ if(!drawing) return; dctx.lineWidth = brushSize; dctx.lineCap='round'; dctx.lineJoin='round'; if(erasing){ dctx.globalCompositeOperation='destination-out'; dctx.strokeStyle='rgba(0,0,0,1)'; } else { dctx.globalCompositeOperation='source-over'; dctx.strokeStyle = brushColor; } dctx.beginPath(); dctx.moveTo(lastX,lastY); dctx.lineTo(x,y); dctx.stroke(); lastX=x; lastY=y; }
function endDraw(){ drawing=false; dctx.globalCompositeOperation='source-over'; }
drawCanvas.addEventListener('mousedown', e=>{ const r=drawCanvas.getBoundingClientRect(); startDraw(e.clientX - r.left, e.clientY - r.top); });
drawCanvas.addEventListener('mousemove', e=>{ const r=drawCanvas.getBoundingClientRect(); moveDraw(e.clientX - r.left, e.clientY - r.top); });
window.addEventListener('mouseup', endDraw);
drawCanvas.addEventListener('touchstart', e=>{ const t=e.touches[0], r=drawCanvas.getBoundingClientRect(); startDraw(t.clientX - r.left, t.clientY - r.top); e.preventDefault(); },{passive:false});
drawCanvas.addEventListener('touchmove', e=>{ const t=e.touches[0], r=drawCanvas.getBoundingClientRect(); moveDraw(t.clientX - r.left, t.clientY - r.top); e.preventDefault(); },{passive:false});
document.querySelectorAll('.swatch').forEach(s=>s.addEventListener('click', e=>{ brushColor = e.currentTarget.dataset.color; erasing=false; document.getElementById('eraserToggle').checked=false; Sound.click(); }));
document.getElementById('brushSize').addEventListener('input', e=>brushSize = +e.target.value);
document.getElementById('colorPicker').addEventListener('input', e=>{ brushColor = e.target.value; erasing=false; document.getElementById('eraserToggle').checked=false; });
document.getElementById('eraserToggle').addEventListener('change', e=>{ erasing = e.target.checked; Sound.toggle(); });
document.getElementById('clearDraw').onclick = ()=>{ Sound.click(); dctx.clearRect(0,0,drawCanvas.width,drawCanvas.height); document.getElementById('drawStatus').textContent=''; };
document.getElementById('saveDraw').onclick = ()=>{ Sound.click(); const url = drawCanvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download='doodle.png'; a.click(); };

/* ---------------------- 100 challenges (embedded) ---------------------- */
const CHALLENGES = [
 "cat","dog","house","tree","sun","moon","star","flower","car","bicycle","boat","fish","bird","apple","banana","cup","cake","hat","shoe","clock",
 "book","chair","telephone","key","lock","umbrella","cloud","mountain","rocket","train","rocketship","guitar","piano","drum","balloon","leaf","grass","bridge","lamp","eye",
 "hand","foot","clock-face","map","camera","glass","spoon","fork","knife","truck","motorbike","penguin","panda","elephant","lion","tiger","bear","hippo","whale","octopus",
 "house-plant","teapot","mushroom","jellyfish","crown","diamond","ring","sword","shield","anchor","compass","paper-boat","kite","stairs","door","window","keyhole","owl","fox","squirrel",
 "lollipop","icecream","donut","sandwich","pencil","marker","eraser","paperclip","magnet","globe","tent","campfire","saxophone","violin","microphone","starfish","seahorse","shell","feather","scroll"
];
/* synonyms map for better matching (a few common ones) */
const SYNONYMS = {
  "cat":["cat","kitten","kitty","feline"],
  "dog":["dog","puppy","hound","canine"],
  "house":["house","home","cabin"],
  "tree":["tree","oak","pine"],
  "car":["car","automobile","vehicle"],
  "bicycle":["bicycle","bike","cycle"],
  "cup":["cup","mug","glass"],
  "cake":["cake","birthday cake"],
  "key":["key"],
  "star":["star"],
  "sun":["sun"],
  "moon":["moon"],
  "fish":["fish"],
  "bird":["bird"],
  "umbrella":["umbrella"],
  "rocket":["rocket","rocketship","spaceship"],
  "guitar":["guitar"],
  "piano":["piano","keyboard"],
  "balloon":["balloon"],
  "snowman":["snowman"],
  "penguin":["penguin"],
  "elephant":["elephant"],
  // leave rest free-form
};

/* UI wiring for challenges */
let currentChallengeIndex = Math.floor(Math.random()*CHALLENGES.length);
const challengeWordEl = document.getElementById('challengeWord');
const drawStatusEl = document.getElementById('drawStatus');
function showChallenge(i){
  currentChallengeIndex = i % CHALLENGES.length;
  const word = CHALLENGES[currentChallengeIndex];
  challengeWordEl.textContent = word;
  drawStatusEl.textContent = '';
}
function nextChallenge(){ showChallenge((currentChallengeIndex+1)%CHALLENGES.length); }
function randomChallenge(){ showChallenge(Math.floor(Math.random()*CHALLENGES.length)); }
document.getElementById('newChallengeBtn').addEventListener('click', ()=>{ Sound.click(); randomChallenge(); });
document.getElementById('challengeClose').addEventListener('click', ()=>{ Sound.click(); document.getElementById('flowDraw').style.display='none'; });
document.getElementById('challengeLater').addEventListener('click', ()=>{ Sound.click(); document.getElementById('flowDraw').style.display='none'; addMessage("Free mode: doodle however you like!", 'bot'); toggleChatInput(false); });
document.getElementById('challengeNo').addEventListener('click', ()=>{ Sound.click(); nextChallenge(); addMessage("Okay, here's a different one — try this!", 'bot'); });
document.getElementById('challengeOK').addEventListener('click', ()=>{ Sound.click(); autoCheckAndScore(); });

/* also OK/No/Later for small chips in other screens—kept simple */
document.getElementById('challengeClose').onclick = ()=>document.getElementById('flowDraw').style.display='none';

/* set initial challenge on load */
showChallenge(currentChallengeIndex);

/* ---------------------- TensorFlow MobileNet (auto-check) ---------------------- */
let mobilenetModel = null;
async function loadMobilenet(){
  try{
    mobilenetModel = await mobilenet.load({version:2,alpha:1.0});
    console.log('mobilenet loaded');
  }catch(e){ console.warn('mobilenet load failed',e); mobilenetModel=null; }
}
loadMobilenet();

/* helper: get canvas image resized to 224x224 */
function getCanvasImageTensor(){
  // capture drawCanvas scaled into an offscreen canvas
  const off = document.createElement('canvas');
  off.width = 224; off.height = 224;
  const octx = off.getContext('2d');
  // white background for better classification
  octx.fillStyle = '#fff'; octx.fillRect(0,0,off.width,off.height);
  // fit drawn canvas into off canvas preserving aspect
  const src = drawCanvas;
  const sr = src.getBoundingClientRect();
  octx.drawImage(src, 0, 0, off.width, off.height);
  return off;
}

/* check: compares classifier labels to current challenge with synonyms and fuzzy includes */
async function autoCheckAndScore(){
  const auto = document.getElementById('autoCheckToggle').getAttribute('aria-pressed') === 'true';
  if(!auto){ addMessage("Auto-check is off — you're in freestyle mode. Save or share your art!", 'bot'); return; }
  if(!mobilenetModel){ addMessage("Recognition model still loading — try again in a moment.", 'bot'); return; }
  addMessage("Checking your doodle... 🔎", 'bot');
  const img = getCanvasImageTensor();
  try{
    const results = await mobilenetModel.classify(img);
    console.log(results);
    // decide match: use synonyms if available or check if any result includes the challenge term
    const challenge = CHALLENGES[currentChallengeIndex];
    const syns = SYNONYMS[challenge] || [challenge];
    const found = results.find(r=>{
      const lab = r.className.toLowerCase();
      for(const s of syns){
        if(lab.includes(s.toLowerCase())) return true;
        // also compare by tokens, e.g., 'digital clock' vs 'clock'
        const tokens = s.toLowerCase().split(/[\s\-_]+/);
        if(tokens.every(tok => lab.includes(tok))) return true;
      }
      return false;
    });
    // apply threshold
    if(found && found.probability > 0.12){
      // success
      addMessage(["Wow! That looks great!","Nice job — that really looks like a " + challenge + "!","Fantastic — you nailed it!"][Math.floor(Math.random()*3)], 'bot');
      Sound.pop();
      document.getElementById('drawStatus').textContent = `Match: ${found.className} (${(found.probability*100).toFixed(1)}%)`;
      // offer new challenge after short delay
      setTimeout(()=>{ nextChallenge(); }, 1200);
    } else {
      // gentle retry
      addMessage(["Lovely! Want to try again for a little reward?","So nice — maybe try again to make it even clearer?","Great attempt! Fancy another try or switch to free-draw?"][Math.floor(Math.random()*3)], 'bot');
      Sound.toggle();
      if(results && results.length) document.getElementById('drawStatus').textContent = `Top guess: ${results[0].className} (${(results[0].probability*100).toFixed(1)}%)`;
    }
  }catch(e){
    console.error(e);
    addMessage("Oops — recognition failed. Try again or freestyle. (Model may not detect every doodle.)", 'bot');
  }
}

/* Auto-check toggle */
document.getElementById('autoCheckToggle').addEventListener('click', function(){
  const p = this.getAttribute('aria-pressed') === 'true';
  this.setAttribute('aria-pressed', String(!p));
  this.textContent = !p ? "✅ Auto‑Check" : "❌ Auto‑Check";
  Sound.click();
});

/* ---------------------- Chat (local, friend‑style) ---------------------- */
const chatBox = document.getElementById('chat-box');
function addMessage(text, sender){
  const d = document.createElement('div'); d.className = `message ${sender}`; d.textContent = text; chatBox.appendChild(d); chatBox.scrollTop = chatBox.scrollHeight;
  if(sender === 'bot') { /* optionally speak */ }
}
addMessage("Hi! 👋 How was your day? 😊", "bot");

const moodButtons = document.querySelectorAll('.mood-btn');
const suggestions = {
  happy:["That's wonderful—what made your day shine?","Amazing! Share one happy moment."],
  sad:["I'm sorry you're feeling sad. Want to tell me more?","I hear you. Do you want a small comfort idea?"],
  angry:["It's okay to be angry. Want a breathing trick?","I can listen. Tell me what happened."],
  nervous:["Take a slow breath. Want to talk about what's making you nervous?","I got you — want a 4-4-6 breathing exercise?"]
};
moodButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    moodButtons.forEach(b=>b.setAttribute('aria-pressed','false'));
    btn.setAttribute('aria-pressed','true');
    const mood = btn.classList[1];
    addMessage(suggestions[mood][Math.floor(Math.random()*suggestions[mood].length)], 'bot');
    // show chat flow UI optionally
    document.getElementById('flowChat').style.display = 'flex';
    document.getElementById('flowChatQ').textContent = "Want to tell more?";
    document.getElementById('flowChatYes').onclick = ()=>{ Sound.click(); document.querySelector('.input-footer').style.display='block'; addMessage("I'm listening. 💬",'bot'); document.getElementById('flowChat').style.display='none'; };
    document.getElementById('flowChatNo').onclick = ()=>{ Sound.click(); document.getElementById('flowChat').style.display='none'; addMessage("All good — I'm here when you need me. 💙",'bot'); };
    document.getElementById('flowChatClose').onclick = ()=>{ Sound.click(); document.getElementById('flowChat').style.display='none'; };
  });
});

document.getElementById('send-btn').addEventListener('click', ()=>{
  const v=document.getElementById('user-input');
  if(!v.value.trim()) return;
  addMessage(v.value.trim(),'user');
  const userText = v.value.trim().toLowerCase();
  v.value='';
  // simple local intent responses
  if(/thank|thanks|thx/.test(userText)){ addMessage("You're welcome! 😊",'bot'); return; }
  if(/sad|upset|cry|bad/.test(userText)){ addMessage("I'm sorry — that sounds heavy. Want a 3-step breathing exercise?","bot"); return; }
  if(/happy|good|great|amazing/.test(userText)){ addMessage("Love to hear that! Want a small celebration idea? 🎉",'bot'); return; }
  addMessage("Thanks for sharing — tell me a bit more or choose an activity above. 💙",'bot');
});

/* ---------------------- small helpers ---------------------- */
function toggleChatInput(show){ document.querySelector('.input-footer').style.display = show ? 'block' : 'none'; }

/* ---------------------- keyboard/touches ---------------------- */
document.addEventListener('keydown', e=>{ if(e.key === "Escape"){ document.getElementById('themesPanel').classList.remove('open'); document.getElementById('flowDraw').style.display='none'; document.getElementById('flowGame').style.display='none'; } });

/* ---------------------- initial UI tweaks ---------------------- */
document.getElementById('flowDraw').style.display='flex';
document.getElementById('flowChat').style.display='none';
document.getElementById('miniPlayer').style.display='flex';
document.getElementById('miniPlayPause').textContent = '▶️';
document.getElementById('autoCheckToggle').setAttribute('aria-pressed','true');

/* ---------------------- end of main script ---------------------- */
</script>
</body>
</html>
