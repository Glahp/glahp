<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AuraAI — All‑in‑One</title>

<!-- TensorFlow.js + MobileNet (CDN) -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@1.0.0/dist/mobilenet.min.js"></script>

<style>
  /* -------------------------
     Core variables & typographic
     ------------------------- */
  :root{
    --glass-bg: rgba(255,255,255,0.20);
    --glass-border: rgba(255,255,255,0.28);
    --glass-shadow: 0 18px 40px rgba(0,0,0,0.22);
    --pad: 20px;
    --radius: 16px;
    --accent: #1e88e5;
    --text: #0b3c61;
    --muted: #6d7b8a;
    --ui-ease: 0.22s;
    --motion-scale: 0.8;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:"Inter", "Segoe UI", Roboto, "Helvetica Neue", Arial,sans-serif;color:var(--text);background:linear-gradient(180deg,#a8cdf1,#f0f6ff);-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale}
  /* container */
  .app{
    min-height:100vh;
    display:grid;
    place-items:center;
    padding:32px;
  }
  /* screens (tabbed) */
  .screen-wrap{
    width:min(1100px,95vw);
    display:grid;
    grid-template-rows:auto 1fr;
    gap:14px;
  }
  /* Splash overlay shown once */
  .splash {
    position: fixed; inset:0;
    display:grid; place-items:center;
    background: linear-gradient(180deg, rgba(10,20,40,.45), rgba(10,20,40,.25));
    z-index:2200;
  }
  .splash-card{
    width:min(820px,92vw);
    padding:28px;
    border-radius:20px;
    background:var(--glass-bg);
    border:1px solid var(--glass-border);
    box-shadow:var(--glass-shadow);
    text-align:center;
    backdrop-filter: blur(12px);
  }
  .splash h1{ margin:0; font-size:36px; letter-spacing:0.6px}
  .splash p{ margin:10px 0 18px; color:var(--muted) }
  .splash .actions{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap }

  /* header row: title + clock + top actions */
  .top-row{
    display:flex; align-items:center; gap:12px; justify-content:space-between;
  }
  .title-card{
    display:flex; align-items:center; gap:12px;
  }
  .brand{
    font-weight:900; font-size:26px; background: linear-gradient(90deg,#ffffff,#f7b7b9,#a8cdf1);
    -webkit-background-clip:text; background-clip:text; color:transparent;
    letter-spacing:1px;
  }
  .subtle { color:var(--muted); font-size:13px; }

  .controls{
    display:flex; align-items:center; gap:8px;
  }

  .btn {
    border:0; cursor:pointer; border-radius:12px;
    padding:10px 14px; font-weight:700; font-size:14px;
    background:linear-gradient(90deg,#ffffff,#eef6ff);
    color:var(--text); box-shadow:0 6px 18px rgba(20,40,80,0.06);
    transition: transform var(--ui-ease), filter var(--ui-ease);
  }
  .btn:active{ transform:translateY(1px) }
  .btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.06) }

  /* main body grid: left area (app card), right area (aux) */
  .body-grid{
    display:grid; grid-template-columns: 1fr 320px; gap:18px;
  }

  /* the main card (tabs inside) */
  .card{
    border-radius:18px; padding:14px; background:var(--glass-bg);
    border:1px solid var(--glass-border); box-shadow:var(--glass-shadow);
    min-height:520px; display:flex; flex-direction:column;
  }

  /* tabs */
  .tabs{ display:flex; gap:8px; margin-bottom:12px; align-items:center; }
  .tab{
    padding:10px 14px; border-radius:12px; font-weight:800; cursor:pointer;
    background:transparent; color:var(--muted);
  }
  .tab.active{
    background:linear-gradient(90deg,#eaf6ff,#f9eef5);
    color:var(--text); box-shadow:0 6px 16px rgba(20,40,80,0.06)
  }

  /* content areas */
  .pane{ flex:1; display:none; padding:16px; gap:12px; }
  .pane.active{ display:flex; flex-direction:column; }

  /* Chat card UI in chat pane */
  .chat-app{ display:flex; gap:12px; align-items:flex-end; justify-content:space-between; height:100% }
  .chat-panel{
    background: linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0.35));
    border-radius:14px; padding:12px; flex:1; display:flex; flex-direction:column; gap:10px;
  }
  .chat-log{ overflow:auto; padding:12px; border-radius:10px; background:rgba(255,255,255,0.06); flex:1; }
  .msg{ max-width:78%; margin:8px 0; padding:10px 12px; border-radius:12px; font-size:15px; line-height:1.25; display:inline-block; opacity:0; transform:translateY(6px); animation: fadeIn .28s forwards; }
  .msg.aura{ background: linear-gradient(90deg,#f0f8ff,#e6f1ff); color:var(--text); box-shadow:0 6px 18px rgba(30,60,120,0.04) }
  .msg.you{ background: linear-gradient(90deg,#1e88e5,#2b9df7); color:white; align-self:flex-end; box-shadow: 0 6px 18px rgba(30,60,120,0.12) }
  @keyframes fadeIn { to{ opacity:1; transform:none } }

  .chat-actions{ display:flex; gap:8px; align-items:center; }
  .mood-row{ display:flex; gap:8px; }
  .mood-btn{ padding:8px 10px; border-radius:10px; background:rgba(255,255,255,0.45); font-weight:800; cursor:pointer; }

  .mini-meta{ font-size:13px; color:var(--muted) }

  /* Bubble Pop pane */
  .game-area{ display:grid; grid-template-rows:auto 1fr auto; gap:10px; height:100% }
  #gameCanvas{ border-radius:12px; width:100%; height:100%; display:block; background: linear-gradient(180deg,#eef9ff,#f8f5ff) }
  .game-top{ display:flex; justify-content:space-between; gap:8px; align-items:center }
  .game-status{ display:flex; gap:12px; align-items:center }
  .status-pill{ background:rgba(255,255,255,0.7); padding:8px 10px; border-radius:12px; font-weight:800 }

  /* Level bar */
  .level-bar{ height:10px; background:rgba(255,255,255,0.45); border-radius:10px; overflow:hidden }
  .level-fill{ height:100%; width:0%; background:linear-gradient(90deg,#9be7ff,#6fb3ff) }

  /* Draw pane */
  .draw-area{ display:grid; grid-template-rows:auto 1fr auto; gap:10px; height:100% }
  .draw-canvas{ border-radius:12px; width:100%; height:100%; background:linear-gradient(180deg,#fff,#f3fbff); box-shadow: inset 0 0 0 1px rgba(0,0,0,0.02) }
  .draw-tools{ display:flex; gap:8px; align-items:center }
  .chip{ padding:8px 12px; border-radius:12px; font-weight:800; cursor:pointer; background:rgba(255,255,255,0.7) }

  /* challenge card integrated into UI */
  .challenge-card{ display:flex; gap:10px; align-items:center; padding:8px; border-radius:12px; background:linear-gradient(90deg, rgba(255,255,255,.8), rgba(255,255,255,.6)); box-shadow:0 6px 18px rgba(0,0,0,0.05) }
  .challenge-q{ font-weight:900; }
  .challenge-actions{ display:flex; gap:8px }

  /* mini player floating */
  .miniplayer{ position:fixed; right:18px; bottom:18px; z-index:1900; display:flex; align-items:center; gap:12px; padding:10px; border-radius:14px; background:var(--glass-bg); border:1px solid var(--glass-border); box-shadow:var(--glass-shadow) }
  .mini-progress{ width:220px; appearance:none; height:8px; border-radius:8px; background:rgba(255,255,255,0.6) }

  /* themes panel */
  .themes-panel{ position:fixed; right:12px; top:80px; z-index:1200; width:320px; max-height:70vh; overflow:auto; padding:12px; border-radius:12px; background:var(--glass-bg); border:1px solid var(--glass-border); box-shadow:var(--glass-shadow) }
  .swatch-row{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px }
  .theme-btn{ width:40px; height:40px; border-radius:10px; border:0; cursor:pointer; box-shadow:0 6px 12px rgba(0,0,0,0.08); position:relative }
  .theme-btn:hover{ transform:translateY(-4px) }

  /* right column widgets (clock, theme quick, stats) */
  .sidebar{ display:flex; flex-direction:column; gap:12px; width:100% }
  .widget{ border-radius:12px; padding:12px; background:linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.55)); }

  /* small utilities */
  .muted{ color:var(--muted) }
  .flex{ display:flex; align-items:center }
  .spacer{ flex:1 }

  /* responsive */
  @media (max-width:980px){
    .body-grid{ grid-template-columns: 1fr; }
    .themes-panel{ position:static; width:100%; max-height:180px }
    .miniplayer{ left:12px; right:12px; bottom:12px; width:calc(100% - 24px) }
  }

  /* tooltips using title attribute suffice; minimally styled */
</style>
</head>
<body>
<div class="app">

  <!-- SPLASH SCREEN (one-time) -->
  <div id="splash" class="splash" style="display:none">
    <div class="splash-card">
      <h1>AuraAI</h1>
      <p>Welcome — we’ll help with calm, expression and practice. Pick a starting place below.</p>
      <div class="actions">
        <button class="btn" id="splashPlay">Play</button>
        <button class="btn" id="splashDraw">Draw</button>
        <button class="btn" id="splashTalk">Talk</button>
      </div>
      <div style="margin-top:12px" class="subtle">This appears once. You can reopen the welcome from the menu later.</div>
    </div>
  </div>

  <div class="screen-wrap">
    <div class="top-row">
      <div class="title-card">
        <div class="brand">AuraAI</div>
        <div style="margin-left:6px" class="subtle">— calm · express · practice</div>
      </div>

      <div class="controls">
        <div id="clock" class="subtle" style="min-width:80px; text-align:right"></div>
        <button id="openThemesBtn" class="btn">🎨 Themes</button>
      </div>
    </div>

    <div class="body-grid">
      <!-- MAIN CARD -->
      <div class="card">
        <div class="tabs" role="tablist" aria-label="Main tabs">
          <div class="tab active" data-tab="chat">💬 Talk</div>
          <div class="tab" data-tab="game">🫧 Bubble Pop</div>
          <div class="tab" data-tab="draw">🎨 Draw</div>
          <div class="spacer"></div>
          <button id="demoToggle" class="btn">Demo OFF</button>
        </div>

        <!-- panes -->
        <!-- CHAT -->
        <div id="pane-chat" class="pane active">
          <div class="chat-app">
            <div class="chat-panel">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div class="subtle" style="font-weight:900">Aura</div>
                <div class="mini-meta">You can switch emotions anytime →</div>
              </div>
              <div id="chatLog" class="chat-log" role="log" aria-live="polite"></div>

              <div style="display:flex; gap:8px; align-items:center">
                <div class="mood-row">
                  <button class="mood-btn" data-mood="happy">😊 Happy</button>
                  <button class="mood-btn" data-mood="sad">😢 Sad</button>
                  <button class="mood-btn" data-mood="angry">😠 Angry</button>
                  <button class="mood-btn" data-mood="nervous">😰 Nervous</button>
                </div>
                <div class="spacer"></div>
                <div class="chat-actions">
                  <button id="voiceBtn" class="btn">🎤 Voice</button>
                  <button id="speakBtn" class="btn">🔊 Speak</button>
                </div>
              </div>
            </div>
            <div style="width:240px; display:flex; flex-direction:column; gap:12px">
              <div class="widget">
                <div style="font-weight:900">Quick Actions</div>
                <div style="display:flex; flex-direction:column; gap:8px; margin-top:8px">
                  <button id="actDraw" class="btn">Go Draw</button>
                  <button id="actPlay" class="btn">Go Play</button>
                  <button id="actResetChat" class="btn">Reset Chat</button>
                </div>
              </div>
              <div class="widget">
                <div style="font-weight:900">Mode</div>
                <div class="muted" style="margin-top:8px">Demo: <span id="demoLabel">OFF</span></div>
              </div>
            </div>
          </div>
        </div>

        <!-- GAME -->
        <div id="pane-game" class="pane">
          <div class="game-area">
            <div class="game-top">
              <div class="game-status">
                <div class="status-pill">Level <span id="levelNum">1</span></div>
                <div class="status-pill">Score <span id="scoreNum">0</span></div>
                <div class="status-pill">Pops left: <span id="popsLeft">—</span></div>
              </div>
              <div style="display:flex; gap:8px; align-items:center">
                <button id="pauseGame" class="btn">⏸ Pause</button>
                <button id="resetLevel" class="btn">↺ Restart</button>
              </div>
            </div>

            <canvas id="gameCanvas"></canvas>

            <div style="display:flex; gap:12px; align-items:center">
              <div style="flex:1">
                <div class="level-bar"><div id="levelFill" class="level-fill"></div></div>
              </div>
              <div style="min-width:220px; display:flex; gap:8px; justify-content:flex-end">
                <div class="muted" id="encouragement">Ready?</div>
              </div>
            </div>
          </div>
        </div>

        <!-- DRAW -->
        <div id="pane-draw" class="pane">
          <div class="draw-area">
            <div style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
              <div class="draw-tools">
                <label class="chip">Brush <input id="brushRange" type="range" min="2" max="40" value="10" /></label>
                <button id="eraserBtn" class="chip">Eraser</button>
                <input id="colorPicker" type="color" value="#1e88e5" class="chip" />
                <button id="rotateBtn" class="chip">↻ Rotate</button>
                <button id="clearBtn" class="chip">Clear</button>
                <button id="saveBtn" class="chip">Save</button>
              </div>

              <div style="display:flex; gap:8px; align-items:center">
                <label style="display:flex; gap:8px; align-items:center"><input id="autoCheckToggle" type="checkbox" /> Auto‑Check</label>
                <button id="newChallengeBtn" class="btn">🔄 New</button>
                <button id="challengeFreeBtn" class="btn">Free‑style</button>
              </div>
            </div>

            <canvas id="drawCanvas" class="draw-canvas"></canvas>

            <div style="display:flex; gap:8px; align-items:center; justify-content:space-between;">
              <div id="challengeCard" class="challenge-card">
                <div>
                  <div class="challenge-q" id="challengeText">Would you like a drawing challenge?</div>
                  <div class="muted" id="challengeSub">Try this and tap OK when you finish.</div>
                </div>
                <div class="challenge-actions">
                  <button id="okBtn" class="chip">OK</button>
                  <button id="noBtn" class="chip">No</button>
                  <button id="laterBtn" class="chip">Later</button>
                </div>
              </div>

              <div style="min-width:220px; display:flex; gap:8px; justify-content:flex-end">
                <div id="drawFeedback" class="muted">Hint: rotate for fun</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div style="display:flex; flex-direction:column; gap:12px">
        <div class="sidebar">
          <div class="widget">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <div style="font-weight:900">Themes</div>
              <div class="muted">Hover for name</div>
            </div>
            <div style="margin-top:8px" id="themesContainer" class="swatch-row"></div>
          </div>

          <div class="widget">
            <div style="display:flex; justify-content:space-between; align-items:center">
              <div style="font-weight:900">Status</div>
              <div class="muted">Live</div>
            </div>
            <div style="margin-top:8px">
              <div class="muted">Level: <strong id="sideLevel">1</strong></div>
              <div class="muted">Score: <strong id="sideScore">0</strong></div>
              <div class="muted">Auto‑Check: <strong id="sideAuto">Off</strong></div>
            </div>
          </div>

          <div class="widget">
            <div style="font-weight:900">Quick</div>
            <div style="display:flex; gap:8px; margin-top:8px">
              <button id="openThemePanel" class="btn">Open Themes</button>
              <button id="resetUI" class="btn">Reset</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Floating mini player -->
  <div id="miniPlayer" class="miniplayer" aria-hidden="false" role="region" aria-label="Music player">
    <button id="miniPlayPause" class="btn">▶️</button>
    <div style="display:flex; flex-direction:column; gap:6px">
      <div style="font-weight:900" id="miniTitle">BGM</div>
      <input id="miniSeek" class="mini-progress" type="range" min="0" max="100" value="0" />
      <div style="display:flex; gap:8px; font-size:12px"><span id="miniCur">0:00</span> / <span id="miniDur">0:00</span></div>
    </div>
  </div>

  <!-- Themes panel (detailed) -->
  <div id="themesPanel" class="themes-panel" style="display:none">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
      <div style="font-weight:900">All Themes</div>
      <button id="closeThemes" class="btn">✕</button>
    </div>
    <div id="themesList"></div>
  </div>

</div>

<script>
/* ============================================================
   Utilities, small helpers
   ============================================================ */
function $(id){ return document.getElementById(id) }
function el(tag,props){ const e=document.createElement(tag); if(props) Object.assign(e,props); return e; }
function nowFmt(sec){ if(isNaN(sec)) return "0:00"; const m=Math.floor(sec/60), s=Math.floor(sec%60); return `${m}:${String(s).padStart(2,'0')}`; }
function clamp(v,a,b){ return Math.max(a,Math.min(b,v)); }

/* ===========================
   Splash (one-time)
   =========================== */
const splash = $('splash');
const seenKey = 'aura_seen_splash_v1';
function showSplashOnceIfNeeded(){
  if(!localStorage.getItem(seenKey)){ splash.style.display='grid'; }
}
$('splashPlay').addEventListener('click', ()=>{ chooseFromSplash('game') });
$('splashDraw').addEventListener('click', ()=>{ chooseFromSplash('draw') });
$('splashTalk').addEventListener('click', ()=>{ chooseFromSplash('chat') });
function chooseFromSplash(tab){
  localStorage.setItem(seenKey,Date.now());
  splash.style.display='none';
  activateTab(tab);
}

/* ===========================
   Clock
   =========================== */
function tickClock(){
  const d=new Date();
  const h=d.getHours().toString().padStart(2,'0');
  const m=d.getMinutes().toString().padStart(2,'0');
  const s=d.getSeconds().toString().padStart(2,'0');
  $('clock').textContent = `${h}:${m}:${s}`;
}
setInterval(tickClock,1000); tickClock();

/* ===========================
   Tabs
   =========================== */
const tabs = document.querySelectorAll('.tab');
tabs.forEach(t=>t.addEventListener('click', ()=> activateTab(t.dataset.tab)));
function activateTab(name){
  tabs.forEach(tb => tb.classList.toggle('active', tb.dataset.tab===name));
  document.querySelectorAll('.pane').forEach(p => p.classList.remove('active'));
  const pane = $(`pane-${name}`);
  if(pane) pane.classList.add('active');

  // ensure canvases resize properly when shown
  if(name==='game'){ resizeGame(); }
  if(name==='draw'){ sizeDrawCanvas(); }
}
showSplashOnceIfNeeded();

/* ===========================
   THEMES: data + UI (100+)
   =========================== */
/* Base groups (user-provided + extras) */
const THEME_GROUPS = {
  'Grayscale': [
    { name:'Pure White', bg:'#ffffff' }, { name:'White Smoke', bg:'#F5F5F5' }, { name:'Light Gray', bg:'#d3d3d3' },
    { name:'Silver Mist', bg:'#b0b0b0' }, { name:'Steel Gray', bg:'#708090' }, { name:'Slate', bg:'#405d72' },
    { name:'Gunmetal', bg:'#2c3539' }, { name:'Charcoal', bg:'#36454f' }, { name:'Dark Slate', bg:'#2f4f4f' },
    { name:'Jet Black', bg:'#000000' }, { name:'Off White', bg:'#fafafa' }, { name:'Dim Gray', bg:'#696969' },
    { name:'Snow', bg:'#FFFAFA' }, { name:'Ivory', bg:'#FFFFF0' }, { name:'Gainsboro', bg:'#DCDCDC' },
    { name:'Alice Blue', bg:'#F0F8FF' }, { name:'Ghost White', bg:'#F8F8FF' }, { name:'Slate Gray', bg:'#708090' }
  ],
  'Gradient': [
    { name:'Aurora', grad:'linear-gradient(135deg,#a8cdf1,#f7b7b9)' },
    { name:'Sunset', grad:'linear-gradient(135deg,#fdbb2d,#22c1c3)' },
    { name:'Forest', grad:'linear-gradient(135deg,#43ac62,#6a9d77)' },
    { name:'Ocean', grad:'linear-gradient(135deg,#005bea,#00c6fb)' },
    { name:'Lavender', grad:'linear-gradient(135deg,#c495d4,#b669c6)' },
    { name:'Candy', grad:'linear-gradient(135deg,#ff7e5f,#feb47b)' },
    { name:'Mint', grad:'linear-gradient(135deg,#9de0ad,#45a247)' },
    { name:'Fire', grad:'linear-gradient(135deg,#ff416c,#ff4b2b)' },
    { name:'Emerald', grad:'linear-gradient(135deg,#56ab2f,#a8e063)' },
    { name:'Grape', grad:'linear-gradient(135deg,#662d8c,#ed1e79)' }
  ],
  'Pastel': [
    { name:'Pastel Dreams', bg:'#ffb3ba' }, { name:'Lemonade', bg:'#fffacd' }, { name:'Strawberry', bg:'#f1a89c' },
    { name:'Aqua Mint', bg:'#b2fef8' }, { name:'Powder Blue', bg:'#b1d4e0' }, { name:'Wisteria', bg:'#c9b1e5' }
  ],
  'Metallic':[ {name:'Gold', bg:'#b8924b'},{name:'Silver', bg:'#c0c0c0'},{name:'Bronze', bg:'#cd7f32'},{name:'Copper', bg:'#b87333'} ],
  'Animated':[ {name:'Shifting Rainbow', grad:'linear-gradient(135deg,#ff6b6b,#ffc87c,#d5a3ff,#8aff8a)'} ],
  'Poster':[ {name:'Crimson', bg:'#8d0426'},{name:'Slate', bg:'#405d72'},{name:'Carbon', bg:'#232526'},{name:'Azure', bg:'#007fff'} ]
};

/* build a long flat list and expand to 100+ swatches */
const allThemes = [];
for(const [group, arr] of Object.entries(THEME_GROUPS)){
  for(const t of arr){
    const entry = Object.assign({group}, t);
    allThemes.push(entry);
  }
}
// generate variations to reach 110
let i=0;
const seedColors = ['#ff6b6b','#ffd166','#6bcB77','#4d90fe','#a28bff','#ffd1f2','#9be7ff','#ffb6b9','#8dd3c7','#f7c59f'];
while(allThemes.length < 110){
  const base = seedColors[i % seedColors.length];
  allThemes.push({ group: 'Generated', name: `Variant ${allThemes.length+1}`, grad:`linear-gradient(135deg, ${base}, ${shadeColor(base,-18)})` });
  i++;
}

/* helper to shade colors */
function shadeColor(hex, percent) {
  // hex "#rrggbb"
  const h = hex.replace('#','');
  const num = parseInt(h,16);
  let r = (num >> 16) + percent;
  let g = (num >> 8 & 0x00FF) + percent;
  let b = (num & 0x0000FF) + percent;
  r = clamp(r,0,255); g=clamp(g,0,255); b=clamp(b,0,255);
  return '#' + ( (1<<24) + (r<<16) + (g<<8) + b ).toString(16).slice(1);
}

/* inject theme swatches (compact) */
const themesContainer = $('themesContainer');
const themesList = $('themesList');
function renderThemeSwatches(){
  themesContainer.innerHTML='';
  allThemes.slice(0,18).forEach(t=>{
    const btn = el('button',{className:'theme-btn', title: t.name || t.group});
    if(t.grad) btn.style.background = t.grad; else btn.style.background = t.bg || '#eee';
    btn.addEventListener('click', ()=> applyTheme(t));
    themesContainer.appendChild(btn);
  });

  // full list in panel
  themesList.innerHTML='';
  let lastGroup = '';
  allThemes.forEach(t=>{
    if(t.group !== lastGroup){
      const h = el('div',{textContent: t.group, className:'muted', style:'font-weight:900;margin-top:10px;margin-bottom:6px'});
      themesList.appendChild(h);
      lastGroup = t.group;
    }
    const btn = el('button',{className:'theme-btn', title: t.name || t.group});
    if(t.grad) btn.style.background = t.grad; else btn.style.background = t.bg || '#eee';
    btn.addEventListener('click', ()=> applyTheme(t));
    const wrap = el('div');
    wrap.style.display='inline-block'; wrap.style.margin='6px';
    wrap.appendChild(btn);
    themesList.appendChild(wrap);
  });
}
renderThemeSwatches();

function applyTheme(t){
  if(t.grad) document.body.style.background = t.grad;
  else if(t.bg) document.body.style.background = t.bg;
  // adjust glass tone
  document.documentElement.style.setProperty('--glass-bg','rgba(255,255,255,0.16)');
  Sound.toggle(); // playful click
}

/* theme panel open/close */
$('openThemesBtn').addEventListener('click', ()=>{$('themesPanel').style.display='block'});
$('openThemePanel').addEventListener('click', ()=>{$('themesPanel').style.display='block'});
$('closeThemes').addEventListener('click', ()=>{$('themesPanel').style.display='none'});

/* ===========================
   SMALL AUDIO / mini player
   =========================== */
const tracks = ['bgm.mp3','bgm2.mp3','bgm3.mp3']; // files should be in same repo
let currentAudio = new Audio();
currentAudio.crossOrigin = 'anonymous';
currentAudio.volume = 0.4;
let currentTrackIndex = 0;
function setTrack(i){
  currentTrackIndex = i % tracks.length;
  currentAudio.src = tracks[currentTrackIndex];
  $('miniTitle').textContent = `Track ${currentTrackIndex+1}`;
}
setTrack(0);
$('miniPlayPause').addEventListener('click', ()=>{
  if(currentAudio.paused){ currentAudio.play().catch(()=>{}); $('miniPlayPause').textContent='⏸'; } else { currentAudio.pause(); $('miniPlayPause').textContent='▶️'; }
});

/* seek */
currentAudio.addEventListener('timeupdate', ()=>{
  if(currentAudio.duration) $('miniSeek').value = (currentAudio.currentTime/currentAudio.duration)*100;
  $('miniCur').textContent = nowFmt(currentAudio.currentTime);
  $('miniDur').textContent = nowFmt(currentAudio.duration);
});
$('miniSeek').addEventListener('input', ()=>{ if(currentAudio.duration) currentAudio.currentTime = ( $('miniSeek').value/100 ) * currentAudio.duration; });

/* click anywhere to resume play on some browsers */
document.addEventListener('pointerdown', ()=>{ /* noop */ }, { once:true });

/* ===========================
   GLOBAL Sound engine (tiny beeps)
   =========================== */
const Sound = (() => {
  let ctx; let muted=false;
  function ensure(){ if(!ctx){ const AC = window.AudioContext || window.webkitAudioContext; if(AC) ctx = new AC(); } }
  function beep(freq=440,dur=0.06,type='sine',gain=0.04){
    if(muted) return;
    ensure(); if(!ctx) return;
    const o = ctx.createOscillator(); const g = ctx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=gain;
    o.connect(g).connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime + dur);
  }
  return { click:()=>beep(620,0.05,'triangle',0.04), pop:()=>beep(920,0.07,'sine',0.06), scribble:()=>beep(260,0.02,'square',0.03), toggle:()=>beep(360,0.05,'sawtooth',0.04), setMuted:(v)=>muted=v, isMuted:()=>muted };
})();

/* ===========================
   BUBBLE POP: Level mechanics
   =========================== */
const gameCanvas = $('gameCanvas');
let gctx, gameWidth, gameHeight;
let bubbles = [], lastSpawn = 0, score=0, level=1, running=true, popsToNextLevel=10;
const MAX_LEVEL = 30;
function resizeGame(){
  const rect = gameCanvas.getBoundingClientRect();
  gameCanvas.width = Math.floor(rect.width * devicePixelRatio);
  gameCanvas.height = Math.floor(rect.height * devicePixelRatio);
  gctx = gameCanvas.getContext('2d');
  gctx.setTransform(1,0,0,1,0,0);
  gctx.scale(devicePixelRatio, devicePixelRatio);
  gameWidth = gameCanvas.clientWidth; gameHeight = gameCanvas.clientHeight;
}
window.addEventListener('resize', resizeGame);
resizeGame();

function spawnBubble(){
  const r = 18 + Math.random()*30;
  const x = r + Math.random()*(gameCanvas.clientWidth - r*2);
  const y = gameCanvas.clientHeight + r + 10;
  const baseSpeed = 0.35 + (level*0.015);
  const vy = (baseSpeed + Math.random()*0.6) * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--motion-scale'));
  const hue = Math.floor(180 + Math.random()*160);
  bubbles.push({x,y,r,vy,alpha:1,hue,popped:false});
}

function updateBubble(b,dt){
  if(!b.popped){
    b.y -= b.vy * dt * 0.06;
    if(b.y < -b.r){ b.popped = true; b.alpha=0; }
  }else b.alpha -= 0.04;
}

function drawBubble(b){
  const ctx = gctx;
  ctx.save();
  ctx.globalAlpha = Math.max(0,b.alpha);
  ctx.shadowColor = `rgba(255,255,255,0.9)`;
  ctx.shadowBlur = 10;
  ctx.lineWidth = 2;
  ctx.strokeStyle = `rgba(0,0,0,0.18)`;
  const cx=b.x, cy=b.y, r=b.r;
  const grad = ctx.createRadialGradient(cx-r*0.3, cy-r*0.3, r*0.15, cx, cy, r);
  grad.addColorStop(0, `hsla(${b.hue},80%,96%,0.95)`);
  grad.addColorStop(1, `hsla(${b.hue},70%,60%,0.7)`);
  ctx.fillStyle = grad;
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.beginPath(); ctx.arc(cx-r*0.38, cy-r*0.38, r*0.22, 0, Math.PI*2);
  ctx.fillStyle = 'rgba(255,255,255,0.6)'; ctx.fill();
  ctx.restore();
}

let prevT = performance.now();
function gameLoop(t){
  const dt = t - prevT; prevT = t;
  if(running){
    gctx.clearRect(0,0,gameCanvas.clientWidth,gameCanvas.clientHeight);
    // soft background tint
    const grd = gctx.createLinearGradient(0,0,gameCanvas.clientWidth,gameCanvas.clientHeight);
    grd.addColorStop(0,'rgba(255,255,255,.28)');
    grd.addColorStop(1,'rgba(255,255,255,.18)');
    gctx.fillStyle = grd; gctx.fillRect(0,0,gameCanvas.clientWidth,gameCanvas.clientHeight);

    const spawnInterval = Math.max(300, 900 - level*18);
    if(t - lastSpawn > spawnInterval) { spawnBubble(); lastSpawn = t; }

    bubbles = bubbles.filter(b=>b.alpha>0);
    for(const b of bubbles){ updateBubble(b, dt); drawBubble(b); }
  }
  requestAnimationFrame(gameLoop);
}
requestAnimationFrame(gameLoop);

gameCanvas.addEventListener('click', (e)=>{
  const rect = gameCanvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  for(const b of bubbles){
    const dx = x - b.x, dy = y - b.y;
    if(!b.popped && dx*dx + dy*dy <= b.r*b.r){
      b.popped = true; b.vy = 0; score++; Sound.pop(); updateGameState();
      break;
    }
  }
});

function updateGameState(){
  $('scoreNum').textContent = score;
  $('sideScore').textContent = score;
  const threshold = level * 10;
  const progress = (score % threshold) / threshold;
  $('levelFill').style.width = `${Math.round(progress*100)}%`;
  $('encouragement').textContent = encouragementForScore(score);
  if(score >= level * 10 && level < MAX_LEVEL){
    level++;
    $('levelNum').textContent = level;
    $('sideLevel').textContent = level;
    Sound.click();
    bubbles = []; // small reset to feel new level
  }
  // milestone messages
  const milestones = [25,50,100,150,250,500,1000];
  if(milestones.includes(score)){
    const msg = `Amazing — ${score} pops! Keep going!`;
    $('encouragement').textContent = msg;
  }
}
function encouragementForScore(s){
  if(s<5) return "Take your time.";
  if(s<20) return "Nice steady pace!";
  if(s<60) return "You're doing great — breathe.";
  if(s<150) return "Awesome focus!";
  return "Legendary calm!";
}

/* control buttons */
$('pauseGame').addEventListener('click', ()=>{
  running = !running; $('pauseGame').textContent = running ? '⏸ Pause' : '▶ Resume';
});
$('resetLevel').addEventListener('click', ()=>{ score=0; level=1; bubbles=[]; updateGameState(); });

/* BUGFIX: ensure resize when switching to game tab */
tabs.forEach(t => t.addEventListener('click', ()=>{
  if(t.dataset.tab === 'game') setTimeout(()=>{ resizeGame(); }, 80);
}));

/* ===========================
   DRAW Canvas + Challenge logic
   =========================== */
const drawCanvas = $('drawCanvas');
const dctx = drawCanvas.getContext('2d', { willReadFrequently:true });
let drawing=false, lastX=0,lastY=0, brushSize=10, brushColor='#1e88e5', eraser=false, rotation=0;

function sizeDrawCanvas(){
  const rect = drawCanvas.getBoundingClientRect();
  // preserve image
  let prev;
  try{ prev = dctx.getImageData(0,0,drawCanvas.width||1,drawCanvas.height||1); }catch(e){ prev = null; }
  drawCanvas.width = Math.floor(rect.width * devicePixelRatio);
  drawCanvas.height = Math.floor(rect.height * devicePixelRatio);
  dctx.setTransform(1,0,0,1,0,0); dctx.scale(devicePixelRatio, devicePixelRatio);
  if(prev){ try{ dctx.putImageData(prev,0,0); }catch(e){} }
}
new ResizeObserver(sizeDrawCanvas).observe(drawCanvas);
setTimeout(sizeDrawCanvas, 0);

function startDraw(x,y){ drawing=true; lastX=x; lastY=y; Sound.scribble(); }
function moveDraw(x,y){
  if(!drawing) return;
  dctx.lineWidth = brushSize; dctx.lineCap='round'; dctx.lineJoin='round';
  if(eraser){ dctx.globalCompositeOperation='destination-out'; dctx.strokeStyle='rgba(0,0,0,1)'; }
  else{ dctx.globalCompositeOperation='source-over'; dctx.strokeStyle=brushColor; }
  dctx.beginPath(); dctx.moveTo(lastX,lastY); dctx.lineTo(x,y); dctx.stroke();
  lastX=x; lastY=y;
}
function endDraw(){ drawing=false; dctx.globalCompositeOperation='source-over'; }

drawCanvas.addEventListener('mousedown', e=>{
  const r=drawCanvas.getBoundingClientRect(); startDraw(e.clientX-r.left, e.clientY-r.top);
});
drawCanvas.addEventListener('mousemove', e=>{
  const r=drawCanvas.getBoundingClientRect(); moveDraw(e.clientX-r.left, e.clientY-r.top);
});
window.addEventListener('mouseup', endDraw);

drawCanvas.addEventListener('touchstart', e=>{
  const t=e.touches[0]; const r=drawCanvas.getBoundingClientRect();
  startDraw(t.clientX-r.left, t.clientY-r.top); e.preventDefault();
},{passive:false});
drawCanvas.addEventListener('touchmove', e=>{
  const t=e.touches[0]; const r=drawCanvas.getBoundingClientRect();
  moveDraw(t.clientX-r.left, t.clientY-r.top); e.preventDefault();
},{passive:false});

$('brushRange').addEventListener('input', e=> brushSize = +e.target.value );
$('colorPicker').addEventListener('input', e=> { brushColor = e.target.value; eraser=false; });
$('eraserBtn').addEventListener('click', ()=> { eraser = !eraser; $('eraserBtn').style.opacity = eraser?0.8:1; });
$('clearBtn').addEventListener('click', ()=> { dctx.clearRect(0,0,drawCanvas.width,drawCanvas.height); });
$('saveBtn').addEventListener('click', ()=> {
  const url = drawCanvas.toDataURL('image/png');
  const a = document.createElement('a'); a.href=url; a.download='drawing.png'; a.click();
});

/* rotate button — rotates the canvas backing image by 90° each click */
$('rotateBtn').addEventListener('click', ()=>{
  rotation = (rotation + 90) % 360;
  // extract image
  const temp = document.createElement('canvas');
  temp.width = drawCanvas.width; temp.height = drawCanvas.height;
  const tctx = temp.getContext('2d');
  tctx.drawImage(drawCanvas,0,0);
  // resize main canvas (keeping same dimensions)
  // apply rotation by drawing into original with transform
  dctx.save(); dctx.clearRect(0,0,drawCanvas.width,drawCanvas.height);
  dctx.translate(drawCanvas.width/2, drawCanvas.height/2);
  dctx.rotate(rotation * Math.PI / 180);
  dctx.drawImage(temp, -drawCanvas.width/2, -drawCanvas.height/2);
  dctx.restore();
});

/* ===========================
   Challenge list (100 items)
   =========================== */
const challenges = [
  "cat","dog","house","tree","car","bicycle","cup","apple","banana","butterfly","fish","boat","rocket",
  "sun","moon","cloud","flower","bird","key","chair","shoe","hat","guitar","piano","book","lamp","clock",
  "star","mountain","bridge","camera","ice cream","cake","cookie","panda","owl","fox","lion","tiger","elephant",
  "penguin","dolphin","whale","forest","island","castle","train","bus","motorcycle","skateboard","umbrella",
  "leaf","river","lighthouse","kite","balloon","mushroom","diamond","ring","cupcake","scooter","glasses",
  "rocket ship","alien","wizard hat","dragon","crown","treasure chest","map","lighthouse","harp","microphone",
  "saxophone","violin","teapot","squirrel","raccoon","hedgehog","maple leaf","compass","lantern","backpack","boots",
  "submarine","hot air balloon","iceberg","volcano","satellite","planet","squirrel","chess piece","pencil","paintbrush",
  "keyboard","monitor","phone","tablet","laptop","headphones","camera lens","snail"
];
// ensure exactly 100 (pad with patterned variants if needed)
while(challenges.length < 100){
  challenges.push("doodle " + (challenges.length+1));
}

/* challenge state */
let currentChallenge = null;
let autoCheckEnabled = false;
$('autoCheckToggle').addEventListener('change', (e)=> { autoCheckEnabled = e.target.checked; $('sideAuto').textContent = autoCheckEnabled ? 'On' : 'Off'; });

function pickRandomChallenge(){
  const idx = Math.floor(Math.random()*challenges.length);
  currentChallenge = challenges[idx];
  $('challengeText').textContent = `Try drawing a ${currentChallenge}?`;
  $('challengeSub').textContent = `OK → shows auto-check (if enabled). No → new task. Later → free‑style.`;
}
$('newChallengeBtn').addEventListener('click', ()=> pickRandomChallenge());
pickRandomChallenge();

/* challenge actions */
$('okBtn').addEventListener('click', async ()=>{
  // user says they're done; run auto-check if enabled, otherwise just encourage
  if(autoCheckEnabled){
    $('drawFeedback').textContent = 'Checking…';
    const result = await classifyCanvas();
    const ok = checkIfMatches(result, currentChallenge);
    if(ok){
      $('drawFeedback').textContent = `Wow! That looks great — I see "${result[0]?.className || 'something'}"! Nice job! 🎉`;
    } else {
      $('drawFeedback').textContent = `So nice — that was fun! Want to try again or a new task?`;
    }
  } else {
    $('drawFeedback').textContent = "Nice! Want another task or free‑style?";
  }
});
$('noBtn').addEventListener('click', ()=>{
  pickRandomChallenge();
  $('drawFeedback').textContent = "New task ready — give it a go!";
});
$('laterBtn').addEventListener('click', ()=>{
  currentChallenge = null;
  $('challengeText').textContent = 'Free‑style mode — create anything!';
  $('drawFeedback').textContent = "Enjoy free drawing — change color, rotate, save.";
});

/* ===========================
   Classification using MobileNet (TensorFlow.js)
   =========================== */
let mobilenetModel = null;
async function loadMobilenet(){
  if(mobilenetModel) return mobilenetModel;
  try{
    mobilenetModel = await mobilenet.load();
  }catch(e){
    console.error("mobilenet load error", e);
    mobilenetModel = null;
  }
  return mobilenetModel;
}
async function classifyCanvas(){
  await loadMobilenet();
  if(!mobilenetModel) return [];
  return new Promise((resolve)=>{
    const img = new Image();
    img.onload = async ()=>{
      try{
        const predictions = await mobilenetModel.classify(img, 5);
        resolve(predictions);
      }catch(e){
        console.error(e); resolve([]);
      }
    };
    img.onerror = ()=> resolve([]);
    img.src = drawCanvas.toDataURL('image/png');
  });
}
function normalizeLabel(l){
  return (l || '').toLowerCase();
}
function checkIfMatches(predictions, target){
  if(!predictions || predictions.length === 0) return false;
  const t = (target || '').toLowerCase();
  for(const p of predictions){
    const label = normalizeLabel(p.className || '');
    if(label.includes(t) || t.includes(label) || label.split(' ').some(w=>t.includes(w))) return true;
  }
  // also fuzzy check small tokens: e.g., "key" vs "key ring"
  return false;
}

/* ===========================
   SIMPLE CHAT (improved)
   =========================== */
const chatLog = $('chatLog');
let demoMode = false; // when true, only respond to lines starting with "You:"
$('demoToggle').addEventListener('click', ()=>{
  demoMode = !demoMode;
  $('demoToggle').textContent = demoMode ? 'Demo ON' : 'Demo OFF';
  $('demoLabel').textContent = demoMode ? 'ON' : 'OFF';
});
function addChat(text, who){
  const div = document.createElement('div');
  div.className = 'msg ' + (who==='aura' ? 'aura' : 'you');
  div.textContent = text;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
}
addChat("Hi! 👋 How was your day? 😊", 'aura');

const moodButtons = document.querySelectorAll('.mood-btn');
moodButtons.forEach(b => b.addEventListener('click', ()=>{
  const mood = b.dataset.mood;
  let reply;
  if(mood==='happy') reply = "That's wonderful — tell me more about what's good today!";
  if(mood==='sad') reply = "I'm sorry you're feeling sad. I'm here — tell me if you want.";
  if(mood==='angry') reply = "Anger is valid. Want a short breathing trick? I can guide you.";
  if(mood==='nervous') reply = "Nervousness can be eased with a small ritual — breathe with me 4-4-6?";
  addChat(reply,'aura');
}));

/* Basic improved intent matching */
const INTENT_RESPONSES = [
  { patterns: ['hello','hi','hey'], replies:["Hey! What would you like to do today? Draw • Play • Talk."] },
  { patterns: ['music','song','listen'], replies:["I can play soothing background music. Try Play and press the ▶️ button."] },
  { patterns: ['draw','doodle','sketch'], replies:["Open Draw and try a challenge — or pick free‑style."] },
  { patterns: ['game','bubble','pop'], replies:["Open Bubble Pop for a calm popping exercise."] },
  { patterns: ['anxious','anxiety','nervous','scared'], replies:["Try this breathing: inhale 4s, hold 4s, exhale 6s — 3 times. Want me to count with you?"] },
  { patterns: ['sad','depressed','down'], replies:["I'm sorry. Want a small comfort idea — warm drink, soft music, or drawing?"] },
];
function findIntent(text){
  const s = text.toLowerCase();
  for(const it of INTENT_RESPONSES){
    for(const p of it.patterns) if(s.includes(p)) return it;
  }
  return null;
}

/* Text entry simulation: We'll accept "You:" lines from console input (demo) via prompt for simple demo */
function sendUserLine(line){
  addChat(line,'you');
  // demo mode: only respond if line starts with "You:" when demoMode true
  if(demoMode && !line.trim().startsWith('You:')) return;
  // strip leading "You:" if present
  const plain = line.replace(/^You:\s*/i,'').trim();
  const intent = findIntent(plain);
  if(intent){
    const r = intent.replies[Math.floor(Math.random()*intent.replies.length)];
    setTimeout(()=> addChat(r,'aura'), 450);
    return;
  }
  // fallback
  setTimeout(()=> addChat("I hear you. Tell me more or choose an activity — Draw • Bubble Pop • Music.", 'aura'), 450);
}

/* For demo: wire simple keypress on document (not shown input field) — user wants to record speech lines "You:" - we'll simulate with prompt when pressing D key */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'y' && e.ctrlKey){
    const line = prompt("Enter line (prefix with 'You:' if Demo ON):");
    if(line) sendUserLine(line);
  }
});

/* quick action buttons */
$('actDraw').addEventListener('click', ()=> activateTab('draw'));
$('actPlay').addEventListener('click', ()=> activateTab('game'));
$('actResetChat').addEventListener('click', ()=> { chatLog.innerHTML=''; addChat("Hi! 👋 How was your day? 😊",'aura') });

/* ===========================
   UI wiring: mini actions
   =========================== */
$('themesContainer').addEventListener('click', ()=> $('themesPanel').style.display='block');
$('resetUI').addEventListener('click', ()=>{
  localStorage.clear(); location.reload();
});

/* ===========================
   Accessibility + finishing touches
   =========================== */
pickRandomChallenge();
showSplashOnceIfNeeded();

/* ensure game canvas initialized on first show */
if(document.querySelector('.tab.active').dataset.tab === 'game') resizeGame();

/* auto-start audio if browser allows (only starts on user gesture) */
document.addEventListener('pointerdown', function startAudio(){ try{ currentAudio.play().catch(()=>{}); }catch(e){} document.removeEventListener('pointerdown', startAudio); }, { once:true });

</script>
</body>
</html>
