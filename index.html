<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AuraAI — All in One</title>
<!-- minimal comments only where necessary -->
<style>
  :root{
    --bot-bg:#d6e6fb; --bot-fg:#074279;
    --user-bg:#517fc4; --user-fg:#e8f3fc;
    --glass-bg: rgba(255,255,255,0.20);
    --glass-border: rgba(255,255,255,0.28);
    --glass-shadow: 0 18px 40px rgba(0,0,0,0.22);
    --glass-blur: blur(18px);
    --pad:20px; --radius:18px; --motion-scale:0.75;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:"Comic Neue",Arial,sans-serif; color:#0b3c61;
    background:#a8cdf1; min-height:100vh; display:flex; align-items:center; justify-content:center; overflow:hidden;
  }
  .screen{position:absolute; inset:0; display:none; place-items:center; padding:var(--pad)}
  .screen.active{display:grid}
  .glass{background:var(--glass-bg); backdrop-filter:var(--glass-blur); -webkit-backdrop-filter:var(--glass-blur); border:1px solid var(--glass-border); box-shadow:var(--glass-shadow)}
  .btn{border:0;cursor:pointer;border-radius:14px;padding:14px 18px;font-weight:800;font-size:16px;color:#0b3c61;background:linear-gradient(90deg,#a8cdf1 0%,#f7b7b9 100%);box-shadow:0 4px 8px rgba(168,205,241,.7);transition:filter .18s ease, transform .18s ease}
  .btn:hover{filter:brightness(.92);transform:translateY(-1px)}
  /* Hello */
  .hello-wrap{width:min(980px,92vw);border-radius:var(--radius);padding:28px;text-align:center}
  .hello-text{font-weight:900;line-height:1;user-select:none;margin:14px 0 8px;font-size:clamp(42px,8vw,92px);letter-spacing:1px;background:linear-gradient(90deg,#ffffff,#f7b7b9,#a8cdf1,#ffffff);-webkit-background-clip:text;background-clip:text;color:transparent;animation:hueflow 12s linear infinite;filter:saturate(.9)}
  @keyframes hueflow{0%{filter:hue-rotate(0deg)}100%{filter:hue-rotate(360deg)}}
  .hello-sub{font-size:clamp(16px,2.6vw,22px);opacity:.9;margin-bottom:18px}
  .hello-actions{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
  .hint{margin-top:14px;font-size:14px;opacity:.8}
  /* Game */
  .game-wrap{width:min(1000px,95vw);height:min(70vh,680px);border-radius:var(--radius);padding:12px;display:grid;grid-template-rows:auto 1fr;gap:10px}
  .bar{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
  .title{font-weight:900;font-size:20px}
  #gameCanvas{width:100%;height:100%;border-radius:14px;background:linear-gradient(135deg,#eaf6ff,#f6f0ff);display:block;outline:2px solid rgba(255,255,255,.5)}
  .game-ind{font-weight:800;padding:8px 12px;border-radius:12px;background:rgba(255,255,255,.55)}
  /* Draw */
  .draw-wrap{width:min(1100px,96vw);height:min(76vh,740px);border-radius:var(--radius);padding:12px;display:grid;grid-template-rows:auto 1fr auto;gap:10px}
  .draw-tools{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .brush{display:flex;align-items:center;gap:8px;font-weight:800;background:rgba(255,255,255,.55);padding:6px 10px;border-radius:12px}
  .swatch{width:26px;height:26px;border-radius:50%;border:0;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,.2)}
  .draw-canvas{width:100%;height:100%;border-radius:14px;background:rgba(255,255,255,.65);outline:2px solid rgba(255,255,255,.5)}
  .draw-bottom{display:flex;gap:8px;justify-content:space-between;flex-wrap:wrap}
  .picker{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.55);padding:6px 10px;border-radius:12px;font-weight:800}
  .picker input[type="color"]{appearance:none;-webkit-appearance:none;border:none;width:42px;height:26px;border-radius:10px;cursor:pointer;background:conic-gradient(from 0deg, red,yellow,lime,cyan,blue,magenta,red)}
  /* Chat */
  .chat-container{width:min(980px,92vw);border-radius:var(--radius);padding:18px;display:flex;flex-direction:column;gap:12px}
  .header-controls{display:flex;gap:10px;align-items:center}
  .mood-header{flex:1;text-align:center;font-weight:900;font-size:22px;padding:12px 16px;border-radius:14px;background:linear-gradient(90deg,#a8cdf1 0%,#f7b7b9 100%);box-shadow:0 4px 8px rgba(168,205,241,.4)}
  .mood-selector{display:flex;gap:10px;flex-wrap:wrap}
  .mood-btn{border:0;flex:1;cursor:pointer;padding:12px 14px;border-radius:14px;font-weight:800;font-size:16px;transition:transform .18s ease,box-shadow .18s ease}
  .mood-btn.happy{background:#c1e6a6}.mood-btn.sad{background:#a4c7f9}.mood-btn.angry{background:#f9d6d6}.mood-btn.nervous{background:#fff3c8}
  .mood-btn:hover{transform:translateY(-3px);box-shadow:0 10px 16px rgba(0,0,0,.22)}
  .mood-btn[aria-pressed="true"]{box-shadow:0 0 12px 2px rgba(0,0,0,.22)}
  #chat-box{flex:1;min-height:280px;max-height:52vh;overflow-y:auto;padding:14px;border-radius:14px;background:rgba(232,242,252,.55)}
  .message{margin:10px 0;padding:12px 14px;border-radius:14px;max-width:75%;border:2px solid transparent;font-size:18px}
  .message.bot{background:rgba(0,0,0,0.35);color:#f0f0f0;border:1px solid rgba(255,255,255,0.25);backdrop-filter:blur(8px)}
  .message.user{background:rgba(0,0,0,0.55);color:#fff;align-self:flex-end;text-align:right;border:1px solid rgba(255,255,255,0.25);backdrop-filter:blur(8px)}
  .input-footer{position:relative;display:none}
  #user-input{width:100%;padding:16px 120px 16px 14px;border-radius:12px;border:1px solid #a9c8e8;background:rgba(255,255,255,.72);font-size:18px;color:#0b3c61;outline:none}
  #send-btn{position:absolute;right:6px;top:6px;bottom:6px;width:108px;color:#fff;background:#88b7e5}
  /* Themes panel */
  .themes-panel{position:fixed;top:0;right:0;height:100%;width:0;opacity:0;pointer-events:none;z-index:1000;transition:width .3s ease,opacity .25s ease;display:flex;flex-direction:column}
  .themes-panel.open{width:320px;opacity:1;pointer-events:auto}
  .themes-body{padding:12px 10px;overflow-y:auto;flex:1}
  .swatch-row{display:flex;gap:10px;flex-wrap:wrap}
  .theme-btn{width:34px;height:34px;border-radius:50%;border:0;cursor:pointer;box-shadow:0 6px 16px rgba(0,0,0,.18)}
  /* Mini player */
  .miniplayer{position:fixed;right:14px;bottom:14px;z-index:1200;display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:14px}
  .mini-btn{border:0;cursor:pointer;border-radius:12px;padding:10px 12px;font-weight:800;font-size:14px;background:rgba(255,255,255,.6);box-shadow:0 4px 8px rgba(0,0,0,.15)}
  .mini-meta{display:flex;flex-direction:column;gap:4px;min-width:170px;max-width:240px}
  .mini-progress{appearance:none;width:100%;height:6px;border-radius:6px;background:rgba(255,255,255,.6);outline:none;cursor:pointer}
  /* Flow overlays */
  .flow-pad{position:absolute;left:16px;bottom:16px;z-index:900;display:flex;flex-direction:column;gap:8px;max-width:min(560px,80vw);padding:10px 12px;border-radius:14px}
  .flow-q{font-weight:900;font-size:16px;line-height:1.25}
  .flow-actions{display:flex;gap:8px;flex-wrap:wrap}
  .chip{border:0;cursor:pointer;border-radius:12px;padding:10px 14px;font-weight:800;background:rgba(255,255,255,.65)}
  .chip:hover{filter:brightness(.95)}
  @media (max-width:880px){.mood-selector{flex-wrap:wrap}.header-controls{flex-wrap:wrap}.miniplayer{right:10px;left:10px;bottom:10px}}
</style>
</head>
<body>

  <!-- HELLO -->
  <section id="hello-screen" class="screen active">
    <div class="hello-wrap glass">
      <div class="hello-text">AuraAI</div>
      <div class="hello-sub">Hi 👋 I’m your support buddy. What would you like to do today?</div>
      <div class="hello-actions">
        <button id="goPlay" class="btn">🎮 Play a Game</button>
        <button id="goDraw" class="btn">🎨 Draw Something</button>
        <button id="goTalk" class="btn">💬 Talk</button>
      </div>
      <div class="hint">You can always go back here from any screen.</div>
    </div>
  </section>

  <!-- GAME -->
  <section id="game-screen" class="screen">
    <div class="game-wrap glass">
      <div class="bar">
        <div class="left-group"><div class="title">🫧 Bubble Pop — calm your mind</div></div>
        <div class="right-group">
          <span class="game-ind">Level: <span id="levelTxt">1</span> • Score: <span id="scoreTxt">0</span></span>
          <button id="resetGame" class="btn">Reset</button>
          <button id="themeBtnGame" class="btn" title="Themes">🎨 Themes</button>
          <button id="muteBtnGame" class="btn" title="Mute/Unmute">🔇 Mute</button>
          <button id="backFromGame" class="btn">⬅ Back</button>
        </div>
      </div>
      <canvas id="gameCanvas" aria-label="Bubble Pop Canvas"></canvas>
      <div id="flowGame" class="flow-pad glass" role="group" aria-label="Game Flow" style="display:none">
        <div id="flowGameQ" class="flow-q"></div>
        <div class="flow-actions">
          <button id="flowGameOK" class="chip">OK</button>
          <button id="flowGameNo" class="chip">No</button>
          <button id="flowGameLater" class="chip">Later</button>
        </div>
      </div>
    </div>
  </section>

  <!-- DRAW -->
  <section id="draw-screen" class="screen">
    <div class="draw-wrap glass">
      <div class="bar">
        <div class="left-group">
          <div class="title">🎨 Draw Something — express or doodle</div>
          <div class="brush">Brush <input id="brushSize" type="range" min="2" max="50" value="10" /></div>
          <button class="swatch" style="background:#000" data-color="#000" title="Black"></button>
          <button class="swatch" style="background:#fff" data-color="#fff" title="White"></button>
          <label class="toggle"><input id="eraserToggle" type="checkbox" /> Eraser</label>
          <div class="picker">Color <input id="colorPicker" type="color" value="#1e88e5" title="Pick color" /></div>
        </div>
        <div class="right-group">
          <button id="themeBtnDraw" class="btn" title="Themes">🎨 Themes</button>
          <button id="muteBtnDraw" class="btn" title="Mute/Unmute">🔇 Mute</button>
          <button id="backFromDraw" class="btn">⬅ Back</button>
        </div>
      </div>

      <canvas id="drawCanvas" class="draw-canvas" aria-label="Drawing Canvas"></canvas>

      <div class="draw-bottom">
        <div class="left">
          <button id="clearDraw" class="btn">Clear</button>
          <button id="saveDraw" class="btn">Save</button>
          <button id="randomPrompt" class="btn">New Prompt</button>
        </div>
        <div class="right">
          <div id="promptDisplay" style="font-weight:800; padding:8px 12px; border-radius:10px; background:rgba(255,255,255,.6);">Prompt: —</div>
        </div>
      </div>

      <div id="drawFlow" class="flow-pad glass" role="group" aria-label="Draw Flow" style="display:none">
        <div id="drawFlowQ" class="flow-q"></div>
        <div class="flow-actions">
          <button id="drawOK" class="chip">OK</button>
          <button id="drawNo" class="chip">No</button>
          <button id="drawLater" class="chip">Later</button>
        </div>
      </div>

    </div>
  </section>

  <!-- CHAT -->
  <section id="chat-screen" class="screen">
    <div class="chat-container glass">
      <div class="header-controls">
        <div class="mood-header glass">How do you feel?</div>
        <div class="header-buttons">
          <button id="voice-mode-btn" class="btn" aria-pressed="false" title="Toggle Voice">🎤 Voice</button>
          <button id="speak-reply-btn" class="btn" aria-pressed="false" title="Speak Replies">🔊 Speak</button>
          <button id="themeBtnChat" class="btn" title="Themes">🎨 Themes</button>
          <button id="muteBtnChat" class="btn" title="Mute/Unmute">🔇 Mute</button>
          <button id="backFromChat" class="btn">⬅ Back</button>
        </div>
      </div>

      <div class="mood-selector">
        <button class="mood-btn happy" aria-pressed="false">😊 Happy</button>
        <button class="mood-btn sad" aria-pressed="false">😢 Sad</button>
        <button class="mood-btn angry" aria-pressed="false">😠 Angry</button>
        <button class="mood-btn nervous" aria-pressed="false">😰 Nervous</button>
      </div>

      <div id="chat-box" class="glass" role="log" aria-live="polite"></div>

      <div class="input-footer">
        <input id="user-input" type="text" placeholder="Type your response..." autocomplete="off" />
        <button id="send-btn" class="btn">Send</button>
      </div>

      <div id="chatFlow" class="flow-pad glass" role="group" aria-label="Chat Flow" style="display:none">
        <div id="chatFlowQ" class="flow-q"></div>
        <div class="flow-actions">
          <button id="chatOK" class="chip">OK</button>
          <button id="chatNo" class="chip">No</button>
          <button id="chatLater" class="chip">Later</button>
        </div>
      </div>

    </div>
  </section>

  <!-- THEMES PANEL -->
  <aside id="themesPanel" class="themes-panel" aria-hidden="true">
    <div class="panel-shell glass">
      <div class="themes-head glass" style="display:flex;align-items:center;justify-content:space-between;padding:12px;font-weight:900;">
        <div>🎨 Themes</div>
        <button id="closeThemes" class="close-btn">✕</button>
      </div>
      <div class="themes-body">
        <div id="themeStrip" class="swatch-strip"></div>
      </div>
    </div>
  </aside>

  <!-- MINI PLAYER -->
  <div id="miniPlayer" class="miniplayer glass" role="region" aria-label="Background Music Player">
    <button id="miniPlayPause" class="mini-btn">⏸</button>
    <div class="mini-meta">
      <div id="miniTitle" class="mini-title" style="font-weight:900">BGM</div>
      <input id="miniSeek" class="mini-progress" type="range" min="0" max="100" value="0" />
      <div class="mini-time"><span id="miniCur">0:00</span> / <span id="miniDur">0:00</span></div>
    </div>
  </div>

<!-- TensorFlow.js + MobileNet from CDN -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@3.1.0/dist/mobilenet.min.js"></script>

<script>
/* ---------- Utilities & quick startup ---------- */
const Sound = (() => {
  let ctx, muted=false;
  function ensure(){ if(!ctx){ const AC=window.AudioContext||window.webkitAudioContext; if(AC) ctx=new AC(); } }
  function tone(f=440,d=0.08,t='sine',g=0.06){ if(muted) return; ensure(); if(!ctx) return; const o=ctx.createOscillator(), gg=ctx.createGain(); o.type=t; o.frequency.value=f; gg.gain.value=g; o.connect(gg).connect(ctx.destination); o.start(); o.stop(ctx.currentTime + d); }
  return { click:()=>tone(600,0.05,'triangle',0.05), pop:()=>tone(900,0.08,'sine',0.07), scribble:()=>tone(280,0.03,'square',0.03), toggle:()=>tone(420,0.06,'sawtooth',0.06), setMuted:(v)=>muted=v, isMuted:()=>muted };
})();

const screens = { hello:document.getElementById('hello-screen'), game:document.getElementById('game-screen'), draw:document.getElementById('draw-screen'), chat:document.getElementById('chat-screen') };
function switchScreen(k){ Object.values(screens).forEach(s=>s.classList.remove('active')); screens[k].classList.add('active'); }

/* ---------- Theme list (many groups; includes rainbow option) ---------- */
const THEMES = {
  "Core":[ ["classic","linear-gradient(135deg,#a8cdf1,#f7b7b9)","#d6e6fb","#517fc4"] ],
  "Vibrant":[ ["rainbow-loop","linear-gradient(135deg,#ff0000,#ff8000,#ffff00,#008000,#0000ff,#4b0082,#9400d3)", "#ffffff", "#000000"], ["ice","linear-gradient(135deg,#89F7FE,#66A6FF)","#e8f6ff","#1E88E5"] ],
  "Dark":[ ["poster-black","#000000","#2b2b2b","#0a0a0a"], ["navy","linear-gradient(135deg,#2C3E50,#4b6eaf)","#496177","#1f6592"] ],
  "Pastel":[ ["cotton-candy","linear-gradient(135deg,#ffb6c1,#add8e6)","#fff8fb","#add8e6"], ["pastel-mint","#C2F5E9","#eafffa","#9edfcf"] ]
};
const themeStrip = document.getElementById('themeStrip');
(function buildThemes(){
  for(const [group,items] of Object.entries(THEMES)){
    const g=document.createElement('div'); g.style.marginBottom='12px';
    const t=document.createElement('div'); t.textContent=group; t.style.fontWeight='900'; t.style.marginBottom='6px';
    g.appendChild(t);
    const row=document.createElement('div'); row.className='swatch-row';
    items.forEach(([key,bg,bot,user])=>{
      const btn=document.createElement('button'); btn.className='theme-btn'; btn.title=key; btn.dataset.key=key; btn.style.background=bg;
      btn.onclick=()=>{ Sound.toggle(); applyTheme(bg,bot,user); localStorage.setItem('aura-theme',key) };
      row.appendChild(btn);
    });
    g.appendChild(row); themeStrip.appendChild(g);
  }
})();
function applyTheme(background, bot, user){
  document.body.style.background = background;
  if(bot) document.documentElement.style.setProperty('--bot-bg', bot);
  if(user) document.documentElement.style.setProperty('--user-bg', user);
  const dark = (typeof background==='string' && background.includes('#000')) || (background && background.startsWith('linear-gradient'));
  document.documentElement.style.setProperty('--glass-bg', dark ? 'rgba(255,255,255,0.12)' : 'rgba(255,255,255,0.20)');
  document.documentElement.style.setProperty('--glass-border', dark ? 'rgba(255,255,255,0.22)' : 'rgba(255,255,255,0.28)');
}
const saved = localStorage.getItem('aura-theme'); if(saved){ /* try to reapply by key */ for(const g of Object.values(THEMES)){ for(const it of g){ if(it[0]===saved) applyTheme(it[1], it[2], it[3]); } } }

/* ---------- Music / BGM ---------- */
const bgFiles = ['bgm.mp3','bgm2.mp3','bgm3.mp3'];
let currentTrackIndex = 0;
const BGM = new Audio(); BGM.loop = true;
BGM.src = bgFiles[currentTrackIndex];
BGM.preload = 'auto';
const mini = { btn: document.getElementById('miniPlayPause'), seek: document.getElementById('miniSeek'), cur: document.getElementById('miniCur'), dur: document.getElementById('miniDur'), title: document.getElementById('miniTitle') };
function fmt(t){ if(isNaN(t)) return '0:00'; const m=Math.floor(t/60), s=Math.floor(t%60).toString().padStart(2,'0'); return `${m}:${s}`; }
mini.btn.onclick = ()=>{ Sound.click(); if(BGM.paused){ BGM.play(); mini.btn.textContent='⏸'; } else { BGM.pause(); mini.btn.textContent='▶️'; } };
mini.seek.addEventListener('input', ()=>{ if(BGM.duration) BGM.currentTime = (mini.seek.value/100)*BGM.duration; });
BGM.addEventListener('timeupdate', ()=>{ if(BGM.duration){ mini.seek.value = (BGM.currentTime/BGM.duration)*100; mini.cur.textContent = fmt(BGM.currentTime); mini.dur.textContent = fmt(BGM.duration); } mini.btn.textContent = BGM.paused ? '▶️' : '⏸'; });
function setTrack(i){ currentTrackIndex = i % bgFiles.length; BGM.src = bgFiles[currentTrackIndex]; BGM.load(); BGM.play().catch(()=>{}); mini.title.textContent = `Track ${currentTrackIndex+1}`; }

/* ---------- Screen routing buttons ---------- */
document.getElementById('goPlay').onclick = ()=>{ Sound.click(); startBGMOnFirstInteraction(); switchScreen('game'); startGameFlow(); };
document.getElementById('goDraw').onclick = ()=>{ Sound.click(); startBGMOnFirstInteraction(); switchScreen('draw'); startDrawFlow(); };
document.getElementById('goTalk').onclick = ()=>{ Sound.click(); startBGMOnFirstInteraction(); switchScreen('chat'); startChatFlow(); };
document.getElementById('backFromGame').onclick = ()=>{ Sound.click(); closeAllFlows(); switchScreen('hello'); };
document.getElementById('backFromDraw').onclick = ()=>{ Sound.click(); closeAllFlows(); switchScreen('hello'); };
document.getElementById('backFromChat').onclick = ()=>{ Sound.click(); closeAllFlows(); switchScreen('hello'); };
document.getElementById('themeBtnGame').onclick = ()=>{ Sound.click(); openThemes(); };
document.getElementById('themeBtnDraw').onclick = ()=>{ Sound.click(); openThemes(); };
document.getElementById('themeBtnChat').onclick = ()=>{ Sound.click(); openThemes(); };
document.getElementById('closeThemes').onclick = ()=>{ Sound.click(); closeThemes(); };

/* ---------- Themes open/close ---------- */
const themesPanel = document.getElementById('themesPanel');
function openThemes(){ themesPanel.classList.add('open'); themesPanel.style.width='320px'; themesPanel.setAttribute('aria-hidden','false'); }
function closeThemes(){ themesPanel.classList.remove('open'); themesPanel.style.width='0'; themesPanel.setAttribute('aria-hidden','true'); }

/* ---------- Mute binds ---------- */
function bindMute(id){ const el = document.getElementById(id); if(!el) return; const setLabel = ()=> el.textContent = Sound.isMuted() ? '🔈 Unmute' : '🔇 Mute'; setLabel(); el.onclick = ()=>{ const will = !Sound.isMuted(); Sound.setMuted && Sound.setMuted(will); setLabel(); if(will) { BGM.pause(); } else { BGM.play().catch(()=>{}); } } }
bindMute('muteBtnGame'); bindMute('muteBtnDraw'); bindMute('muteBtnChat');

/* ---------- BUBBLE POP (level system up to 30) ---------- */
const gameCanvas = document.getElementById('gameCanvas');
let gctx, bubbles=[], score=0, level=1, lastSpawn=0, running=true, prevT=performance.now();

function resizeGame(){ const rect=gameCanvas.getBoundingClientRect(); gameCanvas.width=Math.floor(rect.width*devicePixelRatio); gameCanvas.height=Math.floor(rect.height*devicePixelRatio); gctx=gameCanvas.getContext('2d'); gctx.setTransform(1,0,0,1,0,0); gctx.scale(devicePixelRatio,devicePixelRatio); }
window.addEventListener('resize', resizeGame); resizeGame();

function spawnBubble(){
  const r = 16 + Math.random()* (22 + level/2);
  const x = r + Math.random()*(gameCanvas.clientWidth - r*2);
  const y = gameCanvas.clientHeight + r + 10;
  const vy = (0.4 + Math.random()*0.9) * (0.9 + level*0.03) * parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--motion-scale'));
  const hue = Math.floor(200 + Math.random()*100);
  bubbles.push({x,y,r,vy,alpha:1,hue,popped:false});
}
function updateBubble(b,dt){
  if(!b.popped){ b.y -= b.vy * dt * 0.06; if(b.y < -b.r){ b.popped=true; b.alpha=0; } } else { b.alpha -= 0.04; }
}
function drawBubble(b){
  const ctx = gctx; ctx.save(); ctx.globalAlpha = Math.max(0,b.alpha); ctx.shadowColor='rgba(255,255,255,0.9)'; ctx.shadowBlur=12; ctx.lineWidth=2; ctx.strokeStyle='rgba(0,0,0,0.25)';
  const cx=b.x, cy=b.y, r=b.r;
  const grad = ctx.createRadialGradient(cx-r*0.3, cy-r*0.3, r*0.2, cx, cy, r);
  grad.addColorStop(0, `hsla(${b.hue}, 90%, 96%, .95)`); grad.addColorStop(1, `hsla(${b.hue}, 70%, 65%, .65)`);
  ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.beginPath(); ctx.arc(cx-r*0.38,cy-r*0.38,r*0.22,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,.6)'; ctx.fill(); ctx.restore();
}
function checkLevelUp(){
  const next = Math.min(30, Math.floor(score / (10 * level)) + 1);
  if(next > level){ level = next; document.getElementById('levelTxt').textContent = level; addGameEncouragement(`Level up! Welcome to level ${level}.`); if(level >= 30) addGameEncouragement('Boss chill mode unlocked — breathe.'); }
}
function addGameEncouragement(txt){ addMessage(`[Game] ${txt}`, 'bot'); Sound.pop(); }
function gameLoop(t){
  const dt = t - prevT; prevT = t;
  if(running){
    gctx.clearRect(0,0,gameCanvas.clientWidth,gameCanvas.clientHeight);
    const grd = gctx.createLinearGradient(0,0,gameCanvas.clientWidth,gameCanvas.clientHeight);
    grd.addColorStop(0,'rgba(255,255,255,.28)'); grd.addColorStop(1,'rgba(255,255,255,.18)');
    gctx.fillStyle = grd; gctx.fillRect(0,0,gameCanvas.clientWidth,gameCanvas.clientHeight);
    const spawnRate = Math.max(450 - level*10, 120);
    if(t - lastSpawn > spawnRate) { spawnBubble(); lastSpawn = t; }
    bubbles = bubbles.filter(b => b.alpha > 0);
    for(const b of bubbles){ updateBubble(b, dt); drawBubble(b); }
  }
  requestAnimationFrame(gameLoop);
}
requestAnimationFrame(gameLoop);
gameCanvas.addEventListener('click', (e)=>{
  const rect = gameCanvas.getBoundingClientRect();
  const x = e.clientX - rect.left, y = e.clientY - rect.top;
  for(const b of bubbles){
    const dx = x - b.x, dy = y - b.y;
    if(!b.popped && dx*dx + dy*dy <= b.r*b.r){
      b.popped=true; b.vy=0; score++; document.getElementById('scoreTxt').textContent = score; Sound.pop();
      if([25,50,100,150,250,500,1000].includes(score)) addGameEncouragement(`Milestone reached: ${score} points! Amazing.`);
      checkLevelUp();
      break;
    }
  }
});
document.getElementById('resetGame').onclick = ()=>{ Sound.click(); bubbles=[]; score=0; level=1; document.getElementById('scoreTxt').textContent=0; document.getElementById('levelTxt').textContent=1; };

/* ---------- DRAW PAD + 100 prompts ---------- */
const drawCanvas = document.getElementById('drawCanvas');
const dctx = drawCanvas.getContext('2d', { willReadFrequently: true });
let drawing=false, brushColor='#1e88e5', brushSize=10, lastX=0, lastY=0, erasing=false;
function sizeDrawCanvas(){ const rect=drawCanvas.getBoundingClientRect(); try{ const prev=dctx.getImageData(0,0,drawCanvas.width||1,drawCanvas.height||1); drawCanvas.width = Math.floor(rect.width*devicePixelRatio); drawCanvas.height = Math.floor(rect.height*devicePixelRatio); dctx.setTransform(1,0,0,1,0,0); dctx.scale(devicePixelRatio,devicePixelRatio); dctx.putImageData(prev,0,0); }catch{ drawCanvas.width = Math.floor(rect.width*devicePixelRatio); drawCanvas.height = Math.floor(rect.height*devicePixelRatio); dctx.setTransform(1,0,0,1,0,0); dctx.scale(devicePixelRatio,devicePixelRatio); } }
new ResizeObserver(sizeDrawCanvas).observe(drawCanvas); setTimeout(sizeDrawCanvas,0);
function startDraw(x,y){ drawing=true; lastX=x; lastY=y; Sound.scribble(); }
function moveDraw(x,y){ if(!drawing) return; dctx.lineWidth = brushSize; dctx.lineCap='round'; dctx.lineJoin='round'; if(erasing){ dctx.globalCompositeOperation='destination-out'; dctx.strokeStyle='rgba(0,0,0,1)'; } else { dctx.globalCompositeOperation='source-over'; dctx.strokeStyle = brushColor; } dctx.beginPath(); dctx.moveTo(lastX,lastY); dctx.lineTo(x,y); dctx.stroke(); lastX=x; lastY=y; }
function endDraw(){ drawing=false; dctx.globalCompositeOperation='source-over'; }
drawCanvas.addEventListener('mousedown', e=>{ const r=drawCanvas.getBoundingClientRect(); startDraw(e.clientX - r.left, e.clientY - r.top); });
drawCanvas.addEventListener('mousemove', e=>{ const r=drawCanvas.getBoundingClientRect(); moveDraw(e.clientX - r.left, e.clientY - r.top); });
window.addEventListener('mouseup', endDraw);
drawCanvas.addEventListener('touchstart', e=>{ const t=e.touches[0]; const r=drawCanvas.getBoundingClientRect(); startDraw(t.clientX - r.left, t.clientY - r.top); e.preventDefault(); }, {passive:false});
drawCanvas.addEventListener('touchmove', e=>{ const t=e.touches[0]; const r=drawCanvas.getBoundingClientRect(); moveDraw(t.clientX - r.left, t.clientY - r.top); e.preventDefault(); }, {passive:false});
document.querySelectorAll('.swatch').forEach(btn=>btn.addEventListener('click', ()=>{ brushColor = btn.dataset.color; erasing=false; document.getElementById('eraserToggle').checked=false; Sound.click(); }));

document.getElementById('brushSize').addEventListener('input', e=>{ brushSize = +e.target.value; });
document.getElementById('colorPicker').addEventListener('input', e=>{ brushColor = e.target.value; erasing=false; document.getElementById('eraserToggle').checked=false; });
document.getElementById('eraserToggle').addEventListener('change', e=>{ erasing = e.target.checked; Sound.toggle(); });
document.getElementById('clearDraw').onclick = ()=>{ Sound.click(); dctx.clearRect(0,0,drawCanvas.width,drawCanvas.height); };
document.getElementById('saveDraw').onclick = ()=>{ Sound.click(); const url = drawCanvas.toDataURL('image/png'); const a=document.createElement('a'); a.href=url; a.download='drawing.png'; a.click(); };

/* 100 prompts list */
const PROMPTS = [
 "cat","dog","house","sun","tree","car","bicycle","boat","fish","flower","butterfly","bird","star","moon","mountain","cloud","cup","cake","pizza","ice cream","shoe","hat","chair","door","phone","book","pencil","clock","ball","robot","alien","rocket","castle","dragon","horse","cow","sheep","lion","tiger","elephant","snake","whale","dolphin","kite","guitar","piano","violin","camera","lamp","bridge","road","island","volcano","waterfall","train","bus","scooter","skateboard","butterfly","leaf","feather","feast","island","map","key","glasses","mirror","balloon","present","crown","egg","nest","beach","sandcastle","compass","tent","lantern","mushroom","lighthouse","statue","umbrella","socks","pajamas","blanket","garden","bench","harp","microphone","telescope","hourglass","magnet","snowman","penguin","owl","fox","bear","peacock","treehouse","fountain","ferry","submarine","sailboat","jellyfish","seahorse","clocktower","market","bakery","bakery-shop"
];
let currentPrompt = null;
const promptDisplay = document.getElementById('promptDisplay');
function pickRandomPrompt(){
  currentPrompt = PROMPTS[Math.floor(Math.random()*PROMPTS.length)];
  promptDisplay.textContent = 'Prompt: ' + currentPrompt;
  return currentPrompt;
}
document.getElementById('randomPrompt').onclick = ()=>{ pickRandomPrompt(); showDrawFlow(); };

/* ---------- TensorFlow / MobileNet integration for quick checking ---------- */
let mobilenetModel = null;
let tfReady = false;
async function loadMobileNet(){
  try{
    mobilenetModel = await mobilenet.load({version:2, alpha:1.0});
    tfReady = true;
    console.warn('MobileNet loaded.');
  }catch(e){
    console.warn('Could not load MobileNet (offline or blocked). Auto-check disabled.', e);
    tfReady = false;
  }
}
loadMobileNet();

/* classify drawing: render canvas to 224x224 canvas then call mobilenet.classify */
async function classifyDrawing(){
  if(!tfReady || !mobilenetModel) return {ok:false,reason:'model-unavailable'};
  // create offscreen canvas, draw the user's drawing scaled
  const off = document.createElement('canvas'); off.width=224; off.height=224; const octx = off.getContext('2d');
  // white background to help
  octx.fillStyle = '#ffffff'; octx.fillRect(0,0,224,224);
  // draw current drawing scaled to fit
  const src = drawCanvas;
  octx.drawImage(src, 0, 0, 224, 224);
  // use mobilenet
  try{
    const img = tf.browser.fromPixels(off);
    const results = await mobilenetModel.classify(img);
    img.dispose();
    return {ok:true,results};
  }catch(e){
    console.warn('Classification failed', e);
    return {ok:false,reason:'error'};
  }
}

/* evaluate whether classified labels match the prompt roughly */
function matchResultsToPrompt(results, prompt){
  if(!results || !results.length) return false;
  const p = (prompt||'').toLowerCase().replace(/[^a-z0-9]+/g,'');
  const labels = results.map(r=> (r.className || '').toLowerCase());
  for(const lab of labels){
    const clean = lab.replace(/[^a-z0-9]+/g,'');
    if(clean.includes(p) || p.includes(clean)) return true;
    if(p.split(' ').some(tok => lab.includes(tok))) return true;
  }
  return false;
}

/* UI flow for the draw OK/No/Later buttons */
const drawFlow = { wrap: document.getElementById('drawFlow'), q: document.getElementById('drawFlowQ'), ok: document.getElementById('drawOK'), no: document.getElementById('drawNo'), later: document.getElementById('drawLater') };
function showDrawFlow(){
  const prompt = currentPrompt || pickRandomPrompt();
  drawFlow.q.textContent = `Try drawing a ${prompt}? (OK / No / Later)`;
  drawFlow.wrap.style.display = 'flex';
}
drawFlow.ok.onclick = async ()=>{
  Sound.click();
  addMessage(`Okay — checking your ${currentPrompt || 'drawing'}...`, 'bot');
  const res = await classifyDrawing();
  if(!res.ok){ addMessage(`That was a great try — mobile model not available or couldn't evaluate automatically. Want to try again or keep free-drawing?`, 'bot'); return; }
  const match = matchResultsToPrompt(res.results, currentPrompt);
  if(match){ addMessage(`Wow! That looks great — nice job! 🎉`, 'bot'); } else { addMessage(`So nice! Wanna try again or try a different angle?`, 'bot'); }
  drawFlow.wrap.style.display = 'none';
};
drawFlow.no.onclick = ()=>{ Sound.click(); addMessage('No worries — want another prompt or free-draw?', 'bot'); drawFlow.wrap.style.display='none'; };
drawFlow.later.onclick = ()=>{ Sound.click(); addMessage('Cool — free-draw unlocked. Have fun!', 'bot'); drawFlow.wrap.style.display='none'; toggleDrawInput(true); };

/* ---------- Chat flow (Yes/No/Later) ---------- */
const chatFlow = {wrap:document.getElementById('chatFlow'), q:document.getElementById('chatFlowQ'), ok:document.getElementById('chatOK'), no:document.getElementById('chatNo'), later:document.getElementById('chatLater')};
function startChatFlow(){
  chatFlow.q.textContent = `Want to tell me about your day? (OK / No / Later)`;
  chatFlow.wrap.style.display = 'flex';
}
chatFlow.ok.onclick = ()=>{ Sound.click(); chatFlow.wrap.style.display='none'; addMessage("Great — I'm listening. 💬", 'bot'); toggleChatInput(true); };
chatFlow.no.onclick = ()=>{ Sound.click(); chatFlow.wrap.style.display='none'; addMessage("Totally fine. We can just sit here quietly. 💙", 'bot'); };
chatFlow.later.onclick = ()=>{ Sound.click(); chatFlow.wrap.style.display='none'; addMessage("Whenever you're ready — I'm here.", 'bot'); };

/* ---------- Game flow ---------- */
const gameFlow = {wrap:document.getElementById('flowGame'), q:document.getElementById('flowGameQ'), ok:document.getElementById('flowGameOK'), no:document.getElementById('flowGameNo'), later:document.getElementById('flowGameLater')};
function startGameFlow(){ gameFlow.q.textContent = 'Want a gentle focus? Try popping 5 bubbles slowly. (OK / No / Later)'; gameFlow.wrap.style.display = 'flex'; }
gameFlow.ok.onclick = ()=>{ Sound.click(); gameFlow.wrap.style.display='none'; addMessage('Nice! Take it slow and notice the colors.', 'bot'); };
gameFlow.no.onclick = ()=>{ Sound.click(); gameFlow.wrap.style.display='none'; addMessage('Cool—free play mode. 🎈', 'bot'); };
gameFlow.later.onclick = ()=>{ Sound.click(); gameFlow.wrap.style.display='none'; addMessage('Alright — hop in when ready!', 'bot'); };

/* ---------- helpers ---------- */
function closeAllFlows(){ drawFlow.wrap.style.display='none'; gameFlow.wrap.style.display='none'; chatFlow.wrap.style.display='none'; }
function addMessage(text, sender){ const chatBox=document.getElementById('chat-box'); const d=document.createElement('div'); d.className='message '+sender; d.textContent=text; chatBox.appendChild(d); chatBox.scrollTop = chatBox.scrollHeight; if(sender==='bot' && speakRepliesOn) speakText(text); }
let speakRepliesOn=false;
function speakText(t){ if(!window.speechSynthesis) return; const u=new SpeechSynthesisUtterance(t); u.lang='en-US'; window.speechSynthesis.speak(u); }

/* ---------- Chat minimal bot (improved rules + fuzzy) ---------- */
const synonyms = {
  happy:['happy','glad','great','good','amazing','awesome','joy'],
  sad:['sad','down','unhappy','depressed','blue','cry'],
  anxious:['anxious','nervous','worried','scared','panic'],
  angry:['angry','mad','furious','annoyed','irritated'],
};
function detectIntent(text){
  const s=text.toLowerCase();
  for(const [k,arr] of Object.entries(synonyms)) if(arr.some(w=>s.includes(w))) return k;
  if(/thank|thanks|ty\b/.test(s)) return 'thanks';
  if(/help|support|advice/.test(s)) return 'support';
  if(/draw|paint|doodle/.test(s)) return 'draw';
  return null;
}
function getReplyForIntent(key){
  switch(key){
    case 'happy': return ["That's wonderful — want to tell me what made you smile?","So glad! Keep that feeling — anything fun to share?"];
    case 'sad': return ["I'm sorry you're feeling low — want to tell me what happened?","It's okay to feel sad. Would a breathing exercise help?"];
    case 'anxious': return ["Take a slow breath with me: inhale 4s, hold 4s, exhale 6s — want me to guide you?","You're safe here. Want a grounding exercise?"];
    case 'angry': return ["It's okay to be angry. Want to vent or try a quick cooldown?","You're allowed to feel that — want a 60s distraction?"];
    case 'thanks': return ["You're welcome! 💙","Anytime — I'm here."];
    case 'support': return ["Tell me what's up; we can make a tiny plan together.","I can help with a calming step or someone to reach out to."];
    case 'draw': return ["Love drawing — want a prompt or free-draw?","We can start a drawing prompt — want one?"];
    default: return ["I'm here to listen — can you tell me a bit more?","Got you. Want a suggestion to start?"];
  }
}
document.getElementById('send-btn').addEventListener('click', ()=>{
  const t = document.getElementById('user-input').value.trim(); if(!t) return;
  addMessage(t, 'user'); document.getElementById('user-input').value=''; toggleChatInput(false);
  const intent = detectIntent(t);
  const reply = getReplyForIntent(intent)[Math.floor(Math.random()*getReplyForIntent(intent).length)];
  setTimeout(()=> addMessage(reply, 'bot'), 700);
});

/* mood buttons */
document.querySelectorAll('.mood-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    Sound.click(); document.querySelectorAll('.mood-btn').forEach(b=>b.setAttribute('aria-pressed','false')); btn.setAttribute('aria-pressed','true');
    const mood = btn.classList[1];
    const mapping = {happy:'happy', sad:'sad', angry:'angry', nervous:'anxious'};
    const reply = getReplyForIntent(mapping[mood])[0];
    addMessage(reply,'bot'); startChatFlow();
  });
});

/* chat voice toggles */
document.getElementById('voice-mode-btn').addEventListener('click', ()=>{ Sound.toggle(); alert('Voice mode placeholder: browser support varies.'); });
document.getElementById('speak-reply-btn').addEventListener('click', ()=>{ Sound.toggle(); speakRepliesOn = !speakRepliesOn; document.getElementById('speak-reply-btn').textContent = speakRepliesOn ? '🔊 Speak ON' : '🔊 Speak'; if(!speakRepliesOn && window.speechSynthesis) window.speechSynthesis.cancel(); });

/* toggle chat input */
function toggleChatInput(show){ document.querySelector('.input-footer').style.display = show ? 'block' : 'none'; }

/* start flows for draw / game / chat from main buttons */
function startDrawFlow(){ if(!currentPrompt) pickRandomPrompt(); showDrawFlow(); }
function startBGMOnFirstInteraction(){ document.removeEventListener('pointerdown', kickStartBGM); BGM.play().catch(()=>{}); }
function kickStartBGM(){ BGM.play().catch(()=>{}); document.removeEventListener('pointerdown', kickStartBGM); }
document.addEventListener('pointerdown', kickStartBGM, {once:true});

/* ---------- small UX: when open draw screen, show prompt chooser ---------- */
document.getElementById('randomPrompt').addEventListener('click', ()=>{ pickRandomPrompt(); });

/* ---------- initial bot message ---------- */
addMessage("Hi! 👋 How was your day? 😊","bot");

/* ---------- Expose helper to set track externally (if you want switching) ---------- */
window.setTrack = setTrack;

/* ---------- simple keyboard escape to close panels ---------- */
document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ closeThemes(); closeAllFlows(); } });

</script>
</body>
</html>
